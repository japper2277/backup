<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mic Finder - Collaborative Map</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="144x144" href="icons/icon-144x144.png">
    <link rel="apple-touch-icon" sizes="144x144" href="icons/icon-144x144.png">

    <!-- External Libraries -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <!-- TODO: Replace with local Tailwind build for production - CDN should not be used in production -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <!-- Third-party Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Mic Finder">
    <meta name="msapplication-TileColor" content="#3b82f6">
    <meta name="theme-color" content="#3b82f6">
    
    <!-- Application Styles -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/sidebar.css" type="text/css">
    <link rel="stylesheet" href="css/map.css">
    
    <!-- Application Scripts -->
    <script src="js/config.js?v=2.0"></script>
    <script src="js/utils.js?v=2.0"></script>
    <script src="js/state.js?v=2.0"></script>
    <!-- Google Sheets integration removed - using local CSV only -->
    <script src="js/micDataLoader.js?v=2.0"></script>
    <script src="js/map.js?v=2.0"></script>
    <script src="js/filters.js?v=2.0"></script>
    <script src="js/ui.js?v=2.0"></script>
    <script src="js/favorites.js?v=2.0"></script>
    <script src="js/accessibility.js?v=2.0"></script>
    <script src="js/mobile.js?v=2.0"></script>
    <script src="js/mobile-nav.js?v=2.0"></script>
    <script src="js/sidebar.js?v=2.0"></script>
    <script src="js/app.js?v=2.0"></script>

    <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.min.js"></script>

    <style>
        :root {
            --bg-surface: #232533;
        }
        /* Custom base styles */
        .pill {
            display: inline-flex;
            align-items: center;
            padding: 0.375rem 1.35rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            cursor: pointer;
            /* background: linear-gradient(90deg, #444857 0%, #232533 100%); */
            color: #fff;
            box-shadow: 0 2px 8px 0 rgba(30, 41, 59, 0.10), 0 1.5px 4px 0 rgba(30, 41, 59, 0.08);
            border: none;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            pointer-events: auto;
            position: relative;
            z-index: 10;
            transition: 
                background 0.2s cubic-bezier(.4,0,.2,1),
                box-shadow 0.2s cubic-bezier(.4,0,.2,1),
                transform 0.1s cubic-bezier(.4,0,.2,1);
            min-width: 0 !important;
            max-width: none !important;
            width: auto !important;
            white-space: nowrap !important;
            overflow: visible !important;
        }
        .pill:last-child {
            margin-right: 0;
        }
        .pill:hover, .pill:focus {
            background: linear-gradient(90deg, #6366f1 0%, #4f46e5 100%);
            color: #fff;
            box-shadow: 0 4px 16px 0 rgba(99, 102, 241, 0.15);
            transform: scale(1.05);
        }
        .pill .fa, .pill .pill-icon {
            margin-right: 0.5rem;
        }
        .pill .ml-2 {
            margin-left: 0.75rem;
            color: #cbd5e1;
            font-size: 1.1em;
            transition: color 0.2s;
        }
        .pill:hover .ml-2 {
            color: #fff;
        }
        
        /* Pill Dropdown Styles - from pills demo */
        .pill-edit-icon {
            margin-left: 0.5rem;
            font-size: 0.75rem;
            opacity: 0.6;
            transition: opacity 0.3s ease;
        }
        
        .pill:hover .pill-edit-icon {
            opacity: 1;
        }
        
        .pill-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 0.5rem;
            background: rgba(17, 24, 39, 0.95);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            z-index: 99999;
            overflow: hidden;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
            min-width: 140px;
        }
        
        .pill-dropdown.visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }
        
        .dropdown-option {
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 0.5rem;
            margin: 0.25rem;
            
        /* Context Menu Styles */
        #reset-context-menu {
            min-width: 200px;
            font-family: 'Inter', sans-serif;
            background-color: #1f2937 !important;
            /* Ensure visibility in all views */
            z-index: 99999 !important;
            position: fixed !important;
        }
        
        /* Mobile-specific context menu adjustments */
        @media (max-width: 768px) {
            #reset-context-menu {
                min-width: 250px !important;
                font-size: 16px !important; /* Prevent zoom on iOS */
                padding: 8px 0 !important;
            }
            
            #reset-context-menu button {
                padding: 12px 16px !important; /* Larger touch target */
                min-height: 44px !important;
            }
        }
        
        #reset-context-menu button,
        #reset-to-default-filters {
            transition: background-color 0.2s ease !important;
            color: #FFFFFF !important;
            font-weight: 500 !important;
            background-color: #1f2937 !important;
        }
        
        #reset-context-menu button:hover,
        #reset-to-default-filters:hover {
            background-color: #374151 !important;
            color: #FFFFFF !important;
        }
        
        /* Force override Tailwind with maximum specificity */
        html body #reset-context-menu,
        html body #reset-context-menu * {
            background-color: #1f2937 !important;
            color: #FFFFFF !important;
        }
        
        html body #reset-to-default-filters {
            background-color: #1f2937 !important;
            color: #FFFFFF !important;
            font-weight: 500 !important;
        }
            border: 1px solid transparent;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 500;
            color: #e5e7eb;
        }
        
        .dropdown-option:last-child {
            margin-bottom: 0.25rem;
        }
        
        .dropdown-option:hover {
            background: rgba(99, 102, 241, 0.1);
            border-color: rgba(99, 102, 241, 0.2);
        }
        
        .dropdown-option.selected {
            background: rgba(99, 102, 241, 0.15);
            border-color: #6366f1;
            color: #6366f1;
        }
        
        .dropdown-option-check {
            opacity: 0;
            transition: opacity 0.2s ease;
            font-size: 0.75rem;
        }
        
        .dropdown-option.selected .dropdown-option-check {
            opacity: 1;
        }
        
        /* Special positioning for day pills */
        .pill[data-type="day"] {
            position: relative;
        }
        
        /* Pill dropdown base styles */
        .pill-dropdown {
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            z-index: 99998;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
            max-height: 0;
            overflow: hidden;
            position: absolute;
            top: calc(100% + 0.5rem);
            left: 0;
            min-width: 200px;
        }
        
        /* Mobile-specific dropdown adjustments */
        @media (max-width: 768px) {
            .pill-dropdown {
                position: fixed;
                left: 1rem;
                right: 1rem;
                top: auto;
                bottom: 80px; /* Above bottom bar */
                margin-top: 0;
                width: auto;
                min-width: auto;
                max-height: 60vh;
                transform: translateY(0);
            }
            
            .dropdown-option {
                padding: 1rem 0.75rem;
                font-size: 0.875rem;
                touch-action: manipulation;
            }
        }
        
        /* Desktop dropdown positioning */
        @media (min-width: 769px) {
            .pill-dropdown {
                position: absolute;
                min-width: 180px;
                max-width: 250px;
                max-height: 300px;
                overflow-y: auto;
            }
            
            /* Adjust position if dropdown would go off-screen */
            .pill[data-type="day"]:last-child .pill-dropdown,
            .pill[data-type="day"]:nth-last-child(2) .pill-dropdown {
                right: 0;
                left: auto;
            }
        }
        
        .pill-dropdown.visible {
            opacity: 1;
            visibility: visible;
        }
            

        
        .dropdown-option {
            padding: 0.75rem 1rem;
            color: #d1d5db;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background-color 0.15s ease;
            border-bottom: 1px solid #374151;
        }
        
        .dropdown-option:last-child {
            border-bottom: none;
        }
        
        .dropdown-option:hover {
            background-color: #374151;
            color: #ffffff;
        }
        
        .dropdown-option.selected {
            background-color: #3b82f6;
            color: #ffffff;
        }
        
        .dropdown-option-check {
            opacity: 0;
            transition: opacity 0.15s ease;
        }
        
        .dropdown-option.selected .dropdown-option-check {
            opacity: 1;
        }
        
        .pill-edit-icon {
            margin-left: 0.5rem;
            transition: transform 0.2s ease;
        }
        
        .pill.editing .pill-edit-icon {
            transform: rotate(180deg);
        }
        
        #filter-modal {
            transition: opacity 0.3s ease;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            /* Remove any mobile-specific alignment overrides */
        }
        /* Utility to hide the scrollbar */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .day-pill {
            padding: 0.5rem 1.25rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid #4b5563;
            background-color: #374151;
            color: #d1d5db;
            transition: all 0.15s ease-out;
        }
        .day-pill.active {
            background-color: #f9fafb;
            color: #1f2937;
            border-color: #f9fafb;
        }
        .day-pill:active {
            transform: scale(0.95);
            background-color: #4b5563;
        }
        /* Venue Choice Popup Styling */
        .venue-choice-popup .leaflet-popup-content-wrapper {
            background: #1f2937;
            color: #f3f4f6;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        }
        .venue-choice-popup .leaflet-popup-content {
            margin: 0;
            padding: 0;
        }
        .venue-choice-container {
            padding: 20px;
            text-align: center;
        }
        .venue-choice-container h3 {
            margin: 0 0 15px 0;
            font-size: 1.1rem;
            color: #f3f4f6;
        }
        .venue-choice-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .venue-choice-btn {
            background: #374151;
            color: #f3f4f6;
            border: 2px solid #4b5563;
            border-radius: 6px;
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
        }
        .venue-choice-btn:hover {
            background: #4b5563;
            border-color: #6b7280;
            transform: translateY(-1px);
        }
        .venue-choice-btn strong {
            display: block;
            font-size: 0.95rem;
            margin-bottom: 4px;
        }
        .venue-choice-btn small {
            color: #9ca3af;
            font-size: 0.8rem;
        }
        .venue-choice-popup .leaflet-popup-tip {
            background: #1f2937;
        }
        .custom-time-picker {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            border-bottom: 1px solid #6b7280;
            padding-bottom: 0.25rem;
            width: fit-content;
        }
        .time-part {
            background: transparent;
            color: white;
            border: none;
            font-size: 1rem;
            font-weight: 500;
            padding: 0.25rem;
            cursor: pointer;
        }
        .time-part:focus {
            outline: none;
        }
        .time-dropdown {
            position: absolute;
            z-index: 60;
            background-color: #374151;
            border: 1px solid #4b5563;
            border-radius: 0.5rem;
            max-height: 150px;
            overflow-y: auto;
            color: white;
        }
        .time-dropdown-option {
            padding: 0.5rem 1rem;
            cursor: pointer;
            color: #e5e7eb;
            background-color: transparent;
            transition: all 0.2s ease;
            border-radius: 0.375rem;
            margin: 0.125rem;
        }
        .time-dropdown-option:hover {
            background-color: #6366f1;
            color: white;
        }
        .custom-checkbox {
            appearance: none;
            -webkit-appearance: none;
            height: 1.25rem;
            width: 1.25rem;
            border-radius: 0.25rem;
            border: 2px solid #6b7280;
            background-color: transparent;
            cursor: pointer;
            display: inline-block;
            position: relative;
            margin-right: 0.5rem;
            flex-shrink: 0;
        }
        .custom-checkbox:checked {
            background-color: #7c3aed;
            border-color: #7c3aed;
        }
        .custom-checkbox:checked::after {
            content: '✔';
            position: absolute;
            color: white;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.9rem;
        }

        @media (min-width: 1024px) {
          #search-and-filters-row {
            width: auto !important;
            left: 1.5rem !important;
            top: 1.5rem !important;
          }
        }
        
        /* Minimized view specific positioning */
        @media (max-width: 1023px) {
          #active-pills-row-mobile {
            position: relative !important;
            top: auto !important;
            left: auto !important;
            right: auto !important;
            width: 100% !important;
            max-width: none !important;
            z-index: 50 !important;
            background: none !important;
            border-radius: 0 !important;
            padding: 0 !important;
            box-shadow: none !important;
            display: flex !important;
            overflow-x: auto !important;
            overflow-y: hidden !important;
            margin-top: 1.1rem !important; /* Lower the pills by adding top margin */
            margin-left: 1.6rem !important; /* Align with search bar */
          }
        }
        #search-and-filters-row {
          min-width: 0;
          width: auto;
          max-width: none;
        }
        #filters-scroll-container {
          min-width: 0;
        }
        #active-pills-row,
        #active-pills-row-mobile {
            height: 2.5rem; /* Adjust to match your pill height */
            align-items: center;
            flex-wrap: nowrap !important;
            overflow-x: auto;
            overflow-y: hidden;
            white-space: nowrap;
            pointer-events: auto !important; /* Enable interactions */
        }
        #active-pills-row {
            display: flex;
            overflow-x: auto;
            white-space: nowrap;
            position: sticky;
            top: 1.75rem;
            background: transparent;
            z-index: 100;
            padding: 0.5rem 0;
            border-radius: 2rem;
            gap: 0.5rem;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
            max-width: calc(100vw - 320px - 160px - 384px - 4rem) !important; /* Prevent overlap with sidebar in maximized view */
            margin-left: .5rem;
        }
        #active-pills-row::-webkit-scrollbar {
            display: none;
        }
        #active-pills-row-mobile {
            display: flex !important;
            flex-direction: row;
            align-items: center;
            gap: 0.5rem;
            overflow-x: auto !important;
            overflow-y: hidden !important;
            min-width: 0;
            width: 100% !important;
            max-width: none !important;
            flex-wrap: nowrap !important;
            white-space: nowrap !important;
            /* background: rgba(255, 0, 0, 0.1) !important; */ /* Debug background disabled */
            position: relative !important;
            padding: 0 !important;
            pointer-events: auto; /* Enable clicking on pills */
            border-radius: 0 !important;
            box-shadow: none !important;
            z-index: 50 !important;
        }
        #active-pills-row-mobile::-webkit-scrollbar {
            display: none;
        }
        #modal-button-mobile {
            /* Airbnb-style filter button - positioning handled by Tailwind classes */
            position: relative !important;
            z-index: 2;
            flex-shrink: 0;
        }
        #active-pills-row-mobile .pill:not(#modal-button-mobile) {
            margin-left: 0;
            flex-shrink: 0;
        }
        .time-pill {
            white-space: nowrap;
            min-width: 180px;
        }
        #active-pills-row .pill:first-child {
            margin-left: 0;
        }
        #active-pills-row-mobile .pill:first-child {
            margin-left: 0;
        }
        
        /* Responsive adjustments for the new layout */
        @media (max-width: 1023px) {
            #search-and-filters-row {
                top: 0.5rem;
                left: 0 !important;
                padding-left: 0 !important;
                right: 0 !important;
                padding-right: 0 !important;
                width: 100% !important;
                max-width: none !important;
                overflow: visible !important;
            }
            
            /* Ensure filters container is properly positioned in minimized view */
            #active-pills-row-mobile {
                position: relative !important;
                height: 2.5rem;
                padding-left: 0.5rem !important;
                padding-right: 0.5rem !important;
                width: 100% !important;
                max-width: none !important;
                overflow-x: auto !important;
                overflow-y: hidden !important;
                box-sizing: border-box;
                /* Enable smooth horizontal scrolling */
                -webkit-overflow-scrolling: touch;
                scroll-behavior: smooth;
                /* Hide scrollbar but keep functionality */
                scrollbar-width: none;
                -ms-overflow-style: none;
                /* Make pills overflow right */
                direction: ltr;
                white-space: nowrap !important;
                flex-wrap: nowrap !important;
                display: flex !important;
                align-items: center !important;
                gap: 0.5rem !important;
                /* Remove background, border-radius, box-shadow, and padding */
                background: none !important;
                border-radius: 0 !important;
                box-shadow: none !important;
                z-index: 50 !important;
            }
            
            .mobile-pills-row {
                padding-left: 0 !important;
                margin-left: 0 !important;
                width: 100% !important;
                max-width: none !important;
                overflow: visible !important;
                position: relative !important;
                display: flex !important;
            }
            #modal-button-mobile {
                /* Airbnb-style filter button handled by Tailwind */
                position: relative !important;
                z-index: 2;
                flex-shrink: 0;
            }
        }
        
        @media (min-width: 1024px) {
            #search-and-filters-row {
                flex-direction: row;
                align-items: center;
            }
        }

        /* --- Google Maps Style Autocomplete (Dark Mode Enhanced) --- */
        .autocomplete-dropdown {
            background: #18181b;
            border: 1.5px solid #27272a;
            border-radius: 1rem;
            box-shadow: 0 8px 32px 0 rgba(30,41,59,0.25), 0 1.5px 4px 0 rgba(30,41,59,0.10);
            padding: 0.5rem 0.25rem;
            margin-top: 0.5rem;
            z-index: 1000;
            max-height: 22rem;
            overflow-y: auto;
            min-width: 340px;
        }
        .autocomplete-suggestion {
            display: flex;
            align-items: flex-start;
            background: transparent;
            border-radius: 0.75rem;
            margin: 0.18rem 0.4rem;
            padding: 0.5rem 1rem 0.5rem 0.8rem;
            cursor: pointer;
            border: 2px solid transparent;
            transition: background 0.18s, border 0.18s, box-shadow 0.18s;
            position: relative;
            min-height: 36px;
        }
        .autocomplete-suggestion.selected,
        .autocomplete-suggestion:hover {
            background: #232336;
            border: 2px solid #6366f1;
        }
        .autocomplete-suggestion-icon {
            width: 2.75rem;
            height: 2.75rem;
            min-width: 44px;
            min-height: 44px;
            margin-right: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 1.2rem;
            flex-shrink: 0;
            background: #232336;
            color: #60a5fa;
        }
        .autocomplete-suggestion-content {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
        }
        .autocomplete-suggestion-title {
            font-weight: 700;
            color: #fff;
            font-size: 0.97rem;
            margin-bottom: 0.18rem;
            letter-spacing: 0.01em;
            /* Allow wrapping */
            white-space: normal;
            overflow: visible;
            text-overflow: unset;
        }
        .autocomplete-suggestion-subtitle {
            font-size: 0.90rem;
            color: #d1d5db;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 0.08em;
        }
        .autocomplete-suggestion-time {
            font-size: 0.90rem;
            margin-top: 0.1rem;
            font-weight: 500;
        }
        .autocomplete-suggestion-time.open {
            color: #4ade80;
        }
        .autocomplete-suggestion-time.closed {
            color: #f87171;
        }
        .autocomplete-suggestion-time.unknown {
            color: #a1a1aa;
        }
        .autocomplete-no-results {
            padding: 1.2rem 0.5rem;
            text-align: center;
            color: #a1a1aa;
            font-size: 1rem;
        }
        .autocomplete-highlight {
            background: rgba(99, 102, 241, 0.18); /* Soft violet, matches #6366f1 */
            color: inherit;
            padding: 0.08em 0.25em;
            border-radius: 0.25em;
            font-weight: 500;
            transition: background 0.15s;
        }
        .autocomplete-suggestion:focus {
            outline: 2px solid #818cf8;
            outline-offset: 2px;
        }
        .autocomplete-suggestion-distance {
            color: #60a5fa;
            font-size: 0.87rem;
            margin-left: 0;
            font-weight: 500;
            letter-spacing: 0.01em;
            text-align: left;
            display: block;
        }
        .autocomplete-history-label {
            color: #a1a1aa;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            font-weight: 600;
        }
        .autocomplete-history-remove {
            background: none;
            border: none;
            color: #a1a1aa;
            font-size: 1.25rem;
            margin-left: 0.75rem;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0.5;
            transition: background 0.15s, opacity 0.15s;
        }
        .autocomplete-suggestion.history:hover .autocomplete-history-remove,
        .autocomplete-history-remove:focus {
            opacity: 1;
            background: #232336;
        }
        .autocomplete-clear-history-row {
            display: flex;
            justify-content: center;
            padding: 0.5rem 0 0.2rem 0;
        }
        .autocomplete-clear-history-btn {
            background: none;
            border: none;
            color: #6366f1;
            font-size: 1.05rem;
            font-weight: 600;
            cursor: pointer;
            border-radius: 0.5rem;
            padding: 0.7rem 1.5rem;
            min-width: 44px;
            min-height: 44px;
            transition: background 0.15s, color 0.15s;
        }
        .autocomplete-clear-history-btn:hover, .autocomplete-clear-history-btn:focus {
            background: #232336;
            color: #fff;
        }
        .autocomplete-history-divider {
            color: #a1a1aa;
            font-size: 0.78rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-weight: 700;
            padding: 0.5rem 1.2rem 0.2rem 1.2rem;
            border-top: 1px solid #232336;
            margin-top: 0.2rem;
            margin-bottom: 0.1rem;
        }
        .autocomplete-loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1.2rem 0.5rem 0.8rem 0.5rem;
        }
        .autocomplete-spinner {
            width: 28px;
            height: 28px;
            border: 3px solid #6366f1;
            border-top: 3px solid transparent;
            border-radius: 50%;
            animation: autocomplete-spin 0.8s linear infinite;
        }
        @keyframes autocomplete-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .mic-time-pill {
            display: inline-block;
            padding: 0.5em 1.2em;
            border-radius: 1.2em;
            background: linear-gradient(90deg, #6366f1 0%, #6d28d9 100%);
            color: #fff;
            font-weight: 500;
            margin: 0.2em 0.5em 0.2em 0;
            font-size: 1.1em;
            box-shadow: 0 2px 8px 0 rgba(99,102,241,0.10);
            transition: transform 0.15s cubic-bezier(.4,0,.2,1), background 0.15s, box-shadow 0.15s;
            cursor: pointer;
        }
        .mic-time-pill:hover, .mic-time-pill:focus {
            background: linear-gradient(90deg, #7c3aed 0%, #6366f1 100%);
            transform: scale(1.12);
            box-shadow: 0 4px 16px 0 rgba(99,102,241,0.18);
            outline: none;
            z-index: 2;
        }
        .ig-link {
            color: #2563eb;
            text-decoration: underline;
            font-weight: 500;
            word-break: break-all;
        }
        .ig-link:hover, .ig-link:focus {
            color: #0a2e7a;
            text-decoration: underline;
        }
        .mic-popup-details,
        .mic-popup-details .details-grid {
            pointer-events: auto !important;
        }
        #clear-search-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0 0.25rem;
            display: flex;
            align-items: center;
        }
        #clear-search-btn.hidden {
            display: none;
        }
        
        /* Ensure search input has proper styling */
        #search-input {
            background: transparent !important;
            background-color: transparent !important;
            border: none !important;
            color: #f3f4f6 !important;
            box-shadow: none !important;
            outline: none !important;
        }
        #search-input::placeholder {
            color: #9ca3af !important; /* text-gray-400 */
            opacity: 1 !important;
        }
        #search-input:focus {
            background: transparent !important;
            background-color: transparent !important;
            border: none !important;
            color: #f3f4f6 !important;
            box-shadow: none !important;
            outline: none !important;
        }
        /* Additional specificity to override any external styles */
        input#search-input,
        input#search-input:focus {
            background: transparent !important;
            background-color: transparent !important;
            border: none !important;
            color: #f3f4f6 !important;
            box-shadow: none !important;
            outline: none !important;
        }
        #map-search-bar > div {
            background: var(--bg-surface, #232533) !important;
        }
        
        /* Ensure modal is always centered */
        #filter-modal {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }
        #filter-modal.hidden {
            display: none !important;
        }
        
        /* Desktop centering for filter modal */
        #filter-modal {
          align-items: center !important;
          justify-content: center !important;
        }
        
        /* Desktop height constraints for modal content */
        #modal-content {
          max-height: 80vh !important;
          height: auto !important;
          overflow-y: auto !important;
        }
        
        /* Ensure modal content main section can scroll */
        #modal-content main {
          flex: 1 1 auto !important;
          overflow-y: auto !important;
          max-height: calc(80vh - 120px) !important;
        }
        
        @media (max-width: 600px) {
          #filter-modal {
            align-items: center !important;
            justify-content: center !important;
            padding: 0 !important;
          }
          #modal-content {
            width: 90vw !important;
            max-width: 90vw !important;
            min-width: 0 !important;
            height: 50vh !important;
            max-height: 60vh !important;
            min-height: 0 !important;
            border-radius: 1.5rem !important;
            margin: 0 !important;
            padding: 1.5rem 1rem 0 1rem !important;
            box-shadow: 0 8px 32px 0 rgba(30,41,59,0.25), 0 1.5px 4px 0 rgba(30,41,59,0.10);
            background: rgba(36, 39, 54, 0.95) !important;
            backdrop-filter: blur(18px) !important;
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            justify-content: flex-start !important;
            overflow-y: auto !important;
          }
          #filter-modal main {
            padding: 1rem 0.5rem !important;
            flex: 1 1 auto !important;
            overflow-y: auto !important;
            max-height: none !important;
          }
          #filter-modal header, #filter-modal footer {
            padding-left: 0.5rem !important;
            padding-right: 0.5rem !important;
          }
          #filter-modal footer {
            flex-shrink: 0 !important;
          }
        }
        #right-sidebar {
            background: #232533 !important;
        }
        #right-sidebar .flex.justify-between.items-center.p-4,
        #right-sidebar .p-4.flex.flex-col.gap-4.border-b {
            background: #232533 !important;
            background-color: #232533 !important;
        }
        #active-pills-row .pill,
        #active-pills-row-mobile .pill {
            margin-bottom: 0 !important;
            margin-right: 0 !important;
            padding-right: 0 !important;
            flex-shrink: 0;
            pointer-events: auto !important; /* Enable clicking on pills */
        }
        @media (max-width: 600px) {
          #dayOfWeek-filters { display: none !important; }
          .mobile-day-select-wrapper { display: block !important; margin-bottom: 1rem; position: relative; }
          .mobile-day-select {
            width: 100%;
            background: #353a4a;
            color: #fff;
            border: 1.5px solid #6366f1;
            border-radius: 1.2rem;
            padding: 1.1rem 1.2rem 1.1rem 1.2rem;
            font-size: 1.15rem;
            font-weight: 500;
            box-shadow: 0 2px 8px 0 rgba(30,41,59,0.10);
            margin-bottom: 0.5rem;
            appearance: none;
            -webkit-appearance: none;
            position: relative;
            transition: border 0.2s, box-shadow 0.2s;
          }
          .mobile-day-select:focus {
            outline: 2px solid #6366f1;
            background: #232533;
            border-color: #6366f1;
            box-shadow: 0 0 0 2px #6366f1;
          }
          .mobile-day-select-wrapper::after {
            content: '\25BC';
            position: absolute;
            right: 1.5rem;
            top: 50%;
            transform: translateY(-50%);
            color: #a1a1aa;
            font-size: 1.2rem;
            pointer-events: none;
          }
          /* X button for mobile dropdown */
          .mobile-day-select-close {
            position: absolute;
            top: 0.5rem;
            right: 0.8rem;
            background: none;
            border: none;
            color: #a1a1aa;
            font-size: 1.7rem;
            z-index: 10;
            cursor: pointer;
            padding: 0 0.2rem;
            transition: color 0.2s;
          }
          .mobile-day-select-close:hover {
            color: #fff;
          }
        }
        #modal-button {
          /* Light gray filter button for better map contrast */
          background-color: #f3f4f6 !important;
          color: #1f2937 !important;
          border-color: #9ca3af !important;
        }
        #modal-button:hover {
          background-color: #e5e7eb !important;
          border-color: #6b7280 !important;
        }
        
        /* Ensure mobile pills can overflow properly */
        .mobile-pills-row .pill {
            flex-shrink: 0;
            min-width: fit-content;
        }
        
        /* Additional barrier removal for mobile pills */
        .mobile-pills-row {
            overflow: visible !important;
            max-width: none !important;
            width: 100% !important;
        }
        
        .mobile-pills-row .pill {
            margin-right: 0 !important;
            padding-right: 0 !important;
        }
        
        @media (max-width: 1023px) {
          #modal-button-mobile {
            /* Light gray filter button for better map contrast */
            background-color: #f3f4f6 !important;
            color: #1f2937 !important;
            border-color: #9ca3af !important;
            min-width: fit-content;
          }
          #modal-button-mobile:hover {
            background-color: #e5e7eb !important;
            border-color: #6b7280 !important;
          }
        }

        @media (max-width: 600px) {
          .mobile-pills-row {
            display: flex !important;
            flex-direction: row !important;
            flex-wrap: nowrap !important;
            overflow-x: auto !important;
            white-space: nowrap !important;
            gap: 0.5rem !important;
            width: 100% !important;
            padding-left: 0.5rem !important;
            padding-right: 0.5rem !important;
            box-sizing: border-box !important;
          }
          .mobile-pills-row .pill {
            flex-shrink: 0 !important;
            min-width: fit-content !important;
            white-space: nowrap !important;
            margin-bottom: 0 !important;
          }
        }

        @media (max-width: 600px) {
          #search-input {
            font-size: 16px !important;
          }
        }

        @media (max-width: 1023px) {
          #right-sidebar {
            display: flex !important;
            flex-direction: column !important;
            height: 100vh !important;
            max-height: 100vh !important;
            overflow: hidden !important;
          }
          #right-sidebar .sidebar-content {
            flex: 1 1 0% !important;
            display: flex !important;
            flex-direction: column !important;
            height: 100% !important;
            min-height: 0 !important;
            overflow: hidden !important;
          }
          #mic-list {
            flex: 1 1 0% !important;
            overflow-y: auto !important;
            min-height: 0 !important;
            max-height: 100%;
          }
        }

        @media (min-width: 1024px) {
          #mic-detail-modal {
            justify-content: center;
            align-items: center;
            right: 408px; /* 384px sidebar + 24px gap */
            left: 0;
            width: auto;
          }
          #mic-detail-modal-content {
            max-width: 300px;
            width: 100%;
            margin-right: 0;
            margin-left: 0;
          }
        }
    </style>

    <script>
        // 🎯 PILL TOUCH SENSITIVITY FIX - IMPLEMENTED
        // This fix prevents pills from accidentally activating during scrolling by:
        // 1. Removing problematic 'touchend' listeners that fired on every touch
        // 2. Adding long-press detection (500ms+) for intentional activation
        // 3. Adding quick-tap detection for intentional taps (short duration, small distance)
        // 4. Allowing smooth scrolling without unwanted popups
        // Fix applied to: time pills, day pills, borough pills, details pills
        
        // View detection function for dynamic tour content - GLOBAL SCOPE
        window.getCurrentViewMode = function() {
            const isMinimized = window.innerWidth <= 1023;
            return isMinimized ? 'minimized' : 'fullscreen';
        };

        // Dynamic tour steps function - GLOBAL SCOPE
        window.getTourStepsForCurrentView = function() {
            const viewMode = getCurrentViewMode();
            
            if (viewMode === 'minimized') {
                // Mobile/Minimized view tour steps
                return [
                    {
                        id: 'search',
                        title: '🔍 Quick Search',
                        description: 'Try typing venue names to find mics near you.',
                        target: 'map-search-bar'
                    },
                    {
                        id: 'mobile-pills',
                        title: '💊 Filter Pills',
                        description: 'Quick filter pills show your active filters. Click pills to modify them, or use "All Filters" for advanced options.',
                        target: 'mobile-pills-row'
                    },
                    {
                        id: 'map',
                        title: '🗺️ Touch Map',
                        description: 'Interactive map with touch controls. Click markers to see details and use map controls.',
                        target: 'map'
                    },
                    {
                        id: 'bottom-nav',
                        title: '⬇️ Bottom Action Bar',
                        description: 'Quick actions: location, reset map, favorites, filters, and list view.',
                        target: 'bottom-bar-mobile'
                    }
                ];
            } else {
                // Fullscreen/Desktop view tour steps
                return [
                    {
                        id: 'search',
                        title: '🔍 Quick Search',
                        description: 'Try typing venue names to find mics near you.',
                        target: 'map-search-bar'
                    },
                    {
                        id: 'desktop-filters',
                        title: '🎛️ Filter Controls',
                        description: 'Use the filter controls above the map to narrow down mics by day, time, venue type, and more.',
                        target: 'active-pills-row'
                    },
                    {
                        id: 'map',
                        title: '🗺️ Interactive Map',
                        description: 'Interactive map with mouse controls. Click markers to see details and use map controls.',
                        target: 'map'
                    },
                    {
                        id: 'desktop-nav',
                        title: '📋 Mic Details Sidebar',
                        description: 'Use the right sidebar to view mic details, lists, and additional information.',
                        target: 'right-sidebar'
                    }
                ];
            }
        };

        // Test function to verify pill touch sensitivity fix
        window.testPillFix = function() {
            console.log('🧪 [PILL FIX TEST] Testing the implemented pill touch sensitivity fix...');
            
            const pills = document.querySelectorAll('.pill');
            console.log(`📊 [PILL FIX TEST] Found ${pills.length} pills to test`);
            
            // Check if pills have the new long-press behavior
            let pillsWithLongPress = 0;
            let pillsWithQuickTap = 0;
            
            pills.forEach((pill, index) => {
                // Get all event listeners for this pill
                const pillEvents = getEventListeners(pill);
                
                // Check if pill has touchstart listener (should have long-press)
                const hasTouchStart = pillEvents.touchstart && pillEvents.touchstart.length > 0;
                
                // Check if pill has touchend listener (should have quick-tap)
                const hasTouchEnd = pillEvents.touchend && pillEvents.touchend.length > 0;
                
                if (hasTouchStart) pillsWithLongPress++;
                if (hasTouchEnd) pillsWithQuickTap++;
                
                if (index < 3) { // Only log first 3 pills to avoid spam
                    console.log(`📊 [PILL FIX TEST] Pill ${index + 1}:`, {
                        text: pill.textContent?.trim().substring(0, 20),
                        hasLongPress: hasTouchStart,
                        hasQuickTap: hasTouchEnd,
                        className: pill.className,
                        touchstartListeners: hasTouchStart ? pillEvents.touchstart.length : 0,
                        touchendListeners: hasTouchEnd ? pillEvents.touchend.length : 0
                    });
                }
            });
            
            console.log(`✅ [PILL FIX TEST] Pills with long-press: ${pillsWithLongPress}/${pills.length}`);
            console.log(`✅ [PILL FIX TEST] Pills with quick-tap: ${pillsWithQuickTap}/${pills.length}`);
            console.log('🧪 [PILL FIX TEST] Now test:');
            console.log('1. Swipe left on pills (should NOT activate)');
            console.log('2. Long press on pills (should activate after 500ms)');
            console.log('3. Quick tap on pills (should activate immediately)');
            
            return {
                totalPills: pills.length,
                pillsWithLongPress,
                pillsWithQuickTap,
                fixStatus: pillsWithLongPress > 0 && pillsWithQuickTap > 0 ? '✅ IMPLEMENTED' : '❌ NOT IMPLEMENTED'
            };
        };
        
        // Helper function to get event listeners (DevTools compatible)
        function getEventListeners(element) {
            // Try DevTools method first
            if (window.getEventListeners) {
                try {
                    return window.getEventListeners(element);
                } catch (e) {
                    console.log('⚠️ [PILL FIX TEST] DevTools getEventListeners not available');
                }
            }
            
            // Fallback: check if element has any touch event handlers
            const hasTouchStart = element.ontouchstart !== null || 
                element.hasAttribute('data-touchstart') ||
                element.classList.contains('touch-enabled');
            
            const hasTouchEnd = element.ontouchend !== null || 
                element.hasAttribute('data-touchend') ||
                element.classList.contains('touch-enabled');
            
            return {
                touchstart: hasTouchStart ? [{ listener: 'touchstart-handler' }] : [],
                touchend: hasTouchEnd ? [{ listener: 'touchend-handler' }] : []
            };
        }
        
        // Simple test to verify pills are working correctly
        window.testPillBehavior = function() {
            console.log('🧪 [PILL BEHAVIOR TEST] Testing actual pill behavior...');
            
            const pills = document.querySelectorAll('.pill');
            console.log(`📊 [PILL BEHAVIOR TEST] Found ${pills.length} pills`);
            
            // Test 1: Check if pills have click handlers
            let pillsWithClick = 0;
            pills.forEach((pill, index) => {
                if (pill.onclick !== null || pill.hasAttribute('onclick')) {
                    pillsWithClick++;
                }
                
                if (index < 3) {
                    console.log(`📊 [PILL BEHAVIOR TEST] Pill ${index + 1}:`, {
                        text: pill.textContent?.trim().substring(0, 20),
                        hasClick: pill.onclick !== null || pill.hasAttribute('onclick'),
                        className: pill.className
                    });
                }
            });
            
            console.log(`✅ [PILL BEHAVIOR TEST] Pills with click handlers: ${pillsWithClick}/${pills.length}`);
            console.log('🧪 [PILL BEHAVIOR TEST] Manual testing instructions:');
            console.log('1. On mobile: Long press a pill (should activate after 500ms)');
            console.log('2. On mobile: Quick tap a pill (should activate immediately)');
            console.log('3. On mobile: Swipe left/right (should NOT activate)');
            console.log('4. On desktop: Click a pill (should activate immediately)');
            
            return {
                totalPills: pills.length,
                pillsWithClick,
                testStatus: 'Ready for manual testing'
            };
        };
        
        // Test the actual pill touch behavior by checking current pills
        window.testCurrentPills = function() {
            console.log('🧪 [CURRENT PILLS TEST] Testing pills currently on the page...');
            
            // Force re-render of pills to ensure they're up to date
            if (typeof renderActivePills === 'function') {
                console.log('🔄 [CURRENT PILLS TEST] Re-rendering pills...');
                renderActivePills();
            }
            
            // Wait a moment for pills to render, then test
            setTimeout(() => {
                const pills = document.querySelectorAll('.pill');
                console.log(`📊 [CURRENT PILLS TEST] Found ${pills.length} pills after re-render`);
                
                if (pills.length === 0) {
                    console.log('⚠️ [CURRENT PILLS TEST] No pills found - they may not be rendered yet');
                    return;
                }
                
                // Test each pill's event listeners
                pills.forEach((pill, index) => {
                    console.log(`📊 [CURRENT PILLS TEST] Pill ${index + 1}:`, {
                        text: pill.textContent?.trim().substring(0, 20),
                        className: pill.className,
                        hasTouchStart: pill.ontouchstart !== null,
                        hasTouchEnd: pill.ontouchend !== null,
                        hasClick: pill.onclick !== null
                    });
                });
                
                console.log('🧪 [CURRENT PILLS TEST] Now test manually:');
                console.log('1. Swipe left/right on pills (should NOT activate)');
                console.log('2. Long press on pills (should activate after 500ms)');
                console.log('3. Quick tap on pills (should activate immediately)');
                
            }, 100);
            
            return 'Testing pills after re-render...';
        };
        
        // Global tour update function for testing
        window.updateTourForCurrentView = function() {
            const newViewMode = getCurrentViewMode();
            const newSteps = getTourStepsForCurrentView();
            const newTotalSteps = newSteps.length;
            
            console.log(`[Tour] Updating for ${newViewMode} view: ${newTotalSteps} steps`);
            console.log('New steps:', newSteps.map(s => s.title));
            
            return {
                viewMode: newViewMode,
                totalSteps: newTotalSteps,
                steps: newSteps
            };
        };

        // Prevent any redirects to minimized.html - must be first
        if (window.location.pathname.includes('minimized.html')) {
            console.log('[Redirect Prevention] Detected minimized.html in URL, redirecting to index.html');
            window.location.replace('/index.html' + window.location.search + window.location.hash);
        }
        
        // Helper to convert "HH:mm" to "h:mm AM/PM"
        function to12HourString(time24) {
            if (!time24) return '';
            const [h, m] = time24.split(':').map(Number);
            const period = h >= 12 ? 'PM' : 'AM';
            let hour = h % 12;
            if (hour === 0) hour = 12;
            return `${hour}:${m.toString().padStart(2, '0')} ${period}`;
        }
        
        // Prevent any redirects to minimized.html
        if (window.location.pathname.includes('minimized.html')) {
            console.log('[Redirect Prevention] Detected minimized.html in URL, redirecting to index.html');
            window.location.replace('/index.html' + window.location.search + window.location.hash);
        }

        // --- Location-aware autocomplete support ---
        let userLocation = null;
        
        // Function to request user location (only called in response to user gesture)
        function requestUserLocation(callback) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        userLocation = {
                            lat: pos.coords.latitude,
                            lon: pos.coords.longitude
                        };
                        if (callback) callback(userLocation);
                    },
                    (err) => {
                        userLocation = null;
                        if (callback) callback(null);
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 60000 }
                );
            } else {
                if (callback) callback(null);
            }
        }
        // Haversine formula for distance in miles
        function getDistanceMiles(lat1, lon1, lat2, lon2) {
            if ([lat1, lon1, lat2, lon2].some(v => typeof v !== 'number' || isNaN(v))) return null;
            const toRad = (deg) => deg * Math.PI / 180;
            const R = 3958.8; // Earth radius in miles
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // --- Search History Support ---
        const SEARCH_HISTORY_KEY = 'micfinder_search_history';
        const SEARCH_HISTORY_LIMIT = 8;
        function getSearchHistory() {
            try {
                return JSON.parse(localStorage.getItem(SEARCH_HISTORY_KEY)) || [];
            } catch {
                return [];
            }
        }
        function saveSearchHistory(history) {
            localStorage.setItem(SEARCH_HISTORY_KEY, JSON.stringify(history.slice(0, SEARCH_HISTORY_LIMIT)));
        }
        function addSearchToHistory(term) {
            if (!term || !term.trim()) return;
            let history = getSearchHistory();
            // Remove duplicates (case-insensitive)
            history = history.filter(item => item.toLowerCase() !== term.toLowerCase());
            history.unshift(term);
            saveSearchHistory(history);
        }

        // --- Helper: get time status (open/closed/unknown) ---
        function getTimeStatus(mic) {
            if (!mic || !mic.time) return { status: 'unknown', label: 'Time unknown' };
            // Parse time (assume format like '7:00 PM')
            const now = new Date();
            const [time, period] = mic.time.split(' ');
            if (!time || !period) return { status: 'unknown', label: mic.time };
            let [hour, minute] = time.split(':');
            hour = parseInt(hour);
            minute = parseInt(minute || '0');
            if (period === 'PM' && hour !== 12) hour += 12;
            if (period === 'AM' && hour === 12) hour = 0;
            const micMinutes = hour * 60 + minute;
            const nowMinutes = now.getHours() * 60 + now.getMinutes();
            // Show mics as open if they started within the last 30 minutes
            if (nowMinutes >= micMinutes && nowMinutes <= micMinutes + 30) {
                return { status: 'open', label: mic.time };
            } else if (nowMinutes < micMinutes) {
                return { status: 'unknown', label: mic.time };
            } else {
                return { status: 'closed', label: mic.time };
            }
        }

        // Place this at the top of the autocomplete logic, outside any function
        let isDropdownVisible = false;

        // Add global flag for exact venue selection
        let isExactVenueSelection = false;

        // --- Add this helper to get/set the exactVenue flag globally ---
        function setExactVenueFlag(val) {
            window.__exactVenueFlag = val;
        }
        function getExactVenueFlag() {
            return !!window.__exactVenueFlag;
        }

        // --- Add function to check if venue has mics today ---
        function checkVenueHasMicsToday(venueName) {
            if (!window.MicFinderState || !window.MicFinderFilters) return false;
            
            const allMics = window.MicFinderState.getAllMics();
            const currentFilters = window.MicFinderState.getActiveFilters();
            
            // Find all mics for this venue
            const venueMics = allMics.filter(mic => 
                mic.venue && mic.venue.toLowerCase() === venueName.toLowerCase()
            );
            
            if (venueMics.length === 0) return false;
            
            // Apply current filters to see if any mics match today's criteria
            const filteredMics = window.MicFinderFilters.applyAllFilters();
            const venueFilteredMics = filteredMics.filter(mic => 
                mic.venue && mic.venue.toLowerCase() === venueName.toLowerCase()
            );
            
            return venueFilteredMics.length > 0;
        }

        // --- Add function to show "no mics today" popup ---
        function showNoMicsTodayPopup(venueName) {
            // Check if venue exists at all
            const allMics = window.MicFinderState ? window.MicFinderState.getAllMics() : [];
            const venueExists = allMics.some(mic => 
                mic.venue && mic.venue.toLowerCase() === venueName.toLowerCase()
            );
            
            let message = '';
            if (venueExists) {
                message = `Sorry, <strong>${venueName}</strong> doesn't have any mics scheduled for today with your current filters.`;
            } else {
                message = `Sorry, <strong>${venueName}</strong> doesn't appear to be in our database.`;
            }
            
            // Create popup HTML
            const popupHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6">
                        <div class="text-center">
                            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100 mb-4">
                                <i class="fa fa-calendar-times text-yellow-600 text-xl" aria-hidden="true"></i>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">No Mics Found</h3>
                            <p class="text-gray-600 mb-6">
                                ${message}
                            </p>
                            <div class="flex justify-center">
                                <button id="close-no-mics-popup" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add popup to DOM
            const popupContainer = document.createElement('div');
            popupContainer.id = 'no-mics-today-popup';
            popupContainer.innerHTML = popupHTML;
            document.body.appendChild(popupContainer);
            
            // Add event listeners
            const closeBtn = document.getElementById('close-no-mics-popup');
            
            closeBtn.addEventListener('click', () => {
                document.body.removeChild(popupContainer);
                // --- NEW: Reset map view and clear search bar ---
                // Reset map view (simulate click or call function)
                if (window.MicFinderMap && typeof window.MicFinderMap.resetMapView === 'function') {
                    window.MicFinderMap.resetMapView();
                } else {
                    // Fallback: try to click the reset map button
                    const resetBtn = document.getElementById('zoom-to-fit-btn');
                    if (resetBtn) resetBtn.click();
                }
                // Clear search bar and filter
                const searchInput = document.getElementById('search-input');
                if (searchInput) {
                    searchInput.value = '';
                    // Hide clear button if present
                    const clearBtn = document.getElementById('clear-search-btn');
                    if (clearBtn) clearBtn.classList.add('hidden');
                }
                if (window.MicFinderState && window.MicFinderFilters && window.MicFinderApp) {
                    const filters = window.MicFinderState.getActiveFilters();
                    filters.search = '';
                    filters.exactVenue = '';
                    window.MicFinderState.setActiveFilters(filters);
                    window.MicFinderFilters.saveFilterState(filters);
                    window.MicFinderApp.render();
                }
            });
            
            // Close on outside click
            popupContainer.addEventListener('click', (e) => {
                if (e.target === popupContainer) {
                    document.body.removeChild(popupContainer);
                }
            });
            
            // Close on Escape key
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    document.body.removeChild(popupContainer);
                    document.removeEventListener('keydown', handleEscape);
                }
            };
            document.addEventListener('keydown', handleEscape);
        }

        // --- Popup Manager ---
        class PopupManager {
            constructor() {
                this.activePopup = null;
                this.popupTypes = {
                    TIME_PICKER: 'time-picker',
                    DAY_SELECTION: 'day-selection',
                    BOROUGH_SELECTION: 'borough-selection',
                    NEIGHBORHOOD_SELECTION: 'neighborhood-selection',
                    DETAILS_SELECTION: 'details-selection'
                };
            }
            
            openPopup(type, element) {
                // Close any existing popup first
                this.closeActivePopup();
                
                // Set this as the active popup
                this.activePopup = { type, element };
                
                // Add global click listener to close popup on outside click
                this.addOutsideClickListener();
                
                console.log(`[PopupManager] Opened ${type} popup`);
            }
            
            closeActivePopup() {
                if (!this.activePopup) return;
                
                const { type, element } = this.activePopup;
                
                switch (type) {
                    case this.popupTypes.TIME_PICKER:
                        this.closeTimePicker();
                        break;
                    case this.popupTypes.DAY_SELECTION:
                        this.closeDaySelectionPopup();
                        break;
                    case this.popupTypes.BOROUGH_SELECTION:
                        this.closeBoroughSelectionPopup();
                        break;
                    case this.popupTypes.NEIGHBORHOOD_SELECTION:
                        this.closeNeighborhoodSelectionPopup();
                        break;
                    case this.popupTypes.DETAILS_SELECTION:
                        this.closeDetailsSelectionPopup();
                        break;
                }
                
                this.activePopup = null;
                this.removeOutsideClickListener();
                console.log(`[PopupManager] Closed ${type} popup`);
            }
            
            closeTimePicker() {
                const dropdown = document.getElementById('time-picker-dropdown');
                if (dropdown) {
                    const pillDropdown = dropdown.querySelector('.pill-dropdown');
                    if (pillDropdown) {
                        pillDropdown.style.display = 'none';
                        pillDropdown.classList.remove('visible');
                    }
                }
                document.body.classList.remove('time-picker-open');
            }
            
            closeDaySelectionPopup() {
                const popup = document.getElementById('day-selection-popup');
                if (popup) {
                    popup.classList.add('hidden');
                }
            }
            
            closeBoroughSelectionPopup() {
                const popup = document.getElementById('borough-selection-popup');
                if (popup) {
                    popup.classList.add('hidden');
                }
            }
            
            closeNeighborhoodSelectionPopup() {
                const popup = document.getElementById('neighborhood-selection-popup');
                if (popup) {
                    popup.classList.add('hidden');
                }
            }
            
            closeDetailsSelectionPopup() {
                const popup = document.getElementById('details-selection-popup');
                if (popup) {
                    popup.classList.add('hidden');
                }
            }
            
            addOutsideClickListener() {
                this.outsideClickHandler = (e) => {
                    if (this.activePopup && this.activePopup.element) {
                        const popupElement = this.activePopup.element;
                        if (!popupElement.contains(e.target)) {
                            this.closeActivePopup();
                        }
                    }
                };
                
                // Use a small delay to avoid immediate closure
                setTimeout(() => {
                    document.addEventListener('click', this.outsideClickHandler);
                }, 100);
            }
            
            removeOutsideClickListener() {
                if (this.outsideClickHandler) {
                    document.removeEventListener('click', this.outsideClickHandler);
                    this.outsideClickHandler = null;
                }
            }
            
            isPopupOpen() {
                return this.activePopup !== null;
            }
            
            getActivePopupType() {
                return this.activePopup ? this.activePopup.type : null;
            }
            
            // Test function to verify popup manager is working
            test() {
                console.log('[PopupManager] Test function called');
                console.log('[PopupManager] Active popup:', this.activePopup);
                console.log('[PopupManager] Is popup open:', this.isPopupOpen());
                return 'PopupManager is working!';
            }
        }
        
        // Initialize popup manager
        const popupManager = new PopupManager();
        
        // Make popup manager globally available
        window.popupManager = popupManager;
        
        // Add test function to window for easy testing
        window.testPopupManager = function() {
            return popupManager.test();
        };

        // --- Time Picker Function ---
        function openTimePicker() {
            // Find existing time picker dropdown or create one
            let timePickerDropdown = document.getElementById('time-picker-dropdown');
            
            if (!timePickerDropdown) {
                // Get current time filter values
                const currentFilters = window.MicFinderState ? window.MicFinderState.getActiveFilters() : {};
                
                // Convert 12-hour format to 24-hour format
                const convertTo24Hour = (time12) => {
                    if (!time12) return '';
                    const [time, ampm] = time12.split(' ');
                    const [hours, minutes] = time.split(':');
                    let hour24 = parseInt(hours);
                    if (ampm === 'PM' && hour24 !== 12) hour24 += 12;
                    if (ampm === 'AM' && hour24 === 12) hour24 = 0;
                    return `${hour24.toString().padStart(2, '0')}:${minutes}`;
                };
                
                const defaultStartTime = currentFilters.customTimeStart ? convertTo24Hour(currentFilters.customTimeStart) : '10:00';
                const defaultEndTime = currentFilters.customTimeEnd ? convertTo24Hour(currentFilters.customTimeEnd) : '18:00';
                
                // Create the time picker dropdown HTML
                const dropdownHTML = `
                    <div class="pill-dropdown time-picker-dropdown" style="position: fixed; z-index: 1000; background: rgba(17, 24, 39, 0.9); backdrop-filter: blur(4px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 0.5rem; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); width: 280px; max-width: calc(100vw - 2rem); color: #e5e7eb; overflow: visible; height: auto; max-height: fit-content;">
                        <div class="time-picker" style="padding: 1rem;">
                            <div class="time-inputs-container" style="display: flex; flex-direction: column; gap: 0.75rem; margin-bottom: 1rem;">
                                <div class="time-input-group" style="display: flex; align-items: center; gap: 0.75rem;">
                                    <span class="time-input-label" style="font-size: 0.875rem; font-weight: 500; color: #9ca3af; min-width: 3rem;">From:</span>
                                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                                        <select class="hour-select from-hour" style="padding: 0.5rem; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 0.375rem; font-size: 0.875rem; background: #2d3748; color: #f9fafb; font-weight: 500;">
                                            ${Array.from({length: 12}, (_, i) => {
                                                const hour = i + 1;
                                                return `<option value="${hour}" style="background: #2d3748; color: #f9fafb;">${hour}</option>`;
                                            }).join('')}
                                        </select>
                                        <select class="minute-select from-minute" style="padding: 0.5rem; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 0.375rem; font-size: 0.875rem; background: #2d3748; color: #f9fafb; font-weight: 500;">
                                            <option value="00" style="background: #2d3748; color: #f9fafb;">00</option>
                                            <option value="15" style="background: #2d3748; color: #f9fafb;">15</option>
                                            <option value="30" style="background: #2d3748; color: #f9fafb;">30</option>
                                            <option value="45" style="background: #2d3748; color: #f9fafb;">45</option>
                                        </select>
                                        <select class="ampm-select from-ampm" style="padding: 0.5rem; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 0.375rem; font-size: 0.875rem; background: #2d3748; color: #f9fafb; font-weight: 500;">
                                            <option value="AM" style="background: #2d3748; color: #f9fafb;">AM</option>
                                            <option value="PM" style="background: #2d3748; color: #f9fafb;">PM</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="time-input-group" style="display: flex; align-items: center; gap: 0.75rem;">
                                    <span class="time-input-label" style="font-size: 0.875rem; font-weight: 500; color: #9ca3af; min-width: 3rem;">To:</span>
                                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                                        <select class="hour-select to-hour" style="padding: 0.5rem; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 0.375rem; font-size: 0.875rem; background: #2d3748; color: #f9fafb; font-weight: 500;">
                                            ${Array.from({length: 12}, (_, i) => {
                                                const hour = i + 1;
                                                return `<option value="${hour}" style="background: #2d3748; color: #f9fafb;">${hour}</option>`;
                                            }).join('')}
                                        </select>
                                        <select class="minute-select to-minute" style="padding: 0.5rem; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 0.375rem; font-size: 0.875rem; background: #2d3748; color: #f9fafb; font-weight: 500;">
                                            <option value="00" style="background: #2d3748; color: #f9fafb;">00</option>
                                            <option value="15" style="background: #2d3748; color: #f9fafb;">15</option>
                                            <option value="30" style="background: #2d3748; color: #f9fafb;">30</option>
                                            <option value="45" style="background: #2d3748; color: #f9fafb;">45</option>
                                        </select>
                                        <select class="ampm-select to-ampm" style="padding: 0.5rem; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 0.375rem; font-size: 0.875rem; background: #2d3748; color: #f9fafb; font-weight: 500;">
                                            <option value="AM" style="background: #2d3748; color: #f9fafb;">AM</option>
                                            <option value="PM" style="background: #2d3748; color: #f9fafb;">PM</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="preset-buttons" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem;">
                                <button class="time-preset-btn" data-preset="morning" style="padding: 0.5rem 0.75rem; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 0.375rem; background: #2d3748; color: #f3f4f6; font-size: 0.8rem; cursor: pointer; font-weight: 500;">
                                    Morning<br><span style="font-size: 0.7rem; color: #d1d5db; font-weight: 400;">(9:00 AM - 12:00 PM)</span>
                                </button>
                                <button class="time-preset-btn" data-preset="afternoon" style="padding: 0.5rem 0.75rem; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 0.375rem; background: #2d3748; color: #f3f4f6; font-size: 0.8rem; cursor: pointer; font-weight: 500;">
                                    Afternoon<br><span style="font-size: 0.7rem; color: #d1d5db; font-weight: 400;">(12:00 PM - 6:00 PM)</span>
                                </button>
                                <button class="time-preset-btn" data-preset="evening" style="padding: 0.5rem 0.75rem; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 0.375rem; background: #2d3748; color: #f3f4f6; font-size: 0.8rem; cursor: pointer; font-weight: 500;">
                                    Evening<br><span style="font-size: 0.7rem; color: #d1d5db; font-weight: 400;">(6:00 PM - 11:00 PM)</span>
                                </button>
                                <button class="time-preset-btn" data-preset="all-day" style="padding: 0.5rem 0.75rem; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 0.375rem; background: #2d3748; color: #f3f4f6; font-size: 0.8rem; cursor: pointer; font-weight: 500;">
                                    All Day<br><span style="font-size: 0.7rem; color: #d1d5db; font-weight: 400;">(10:00 AM - 11:45 PM)</span>
                                </button>
                            </div>
                            
                            <div class="time-picker-actions">
                                <button class="close-time-picker" style="width: 100%; padding: 0.625rem 1rem; background: #6366f1; border: none; border-radius: 0.5rem; color: white; font-size: 0.875rem; font-weight: 500; cursor: pointer;">Done</button>
                            </div>
                        </div>
                    </div>
                `;
                
                timePickerDropdown = document.createElement('div');
                timePickerDropdown.id = 'time-picker-dropdown';
                timePickerDropdown.innerHTML = dropdownHTML;
                document.body.appendChild(timePickerDropdown);
                
                // Add event listeners
                const dropdown = timePickerDropdown.querySelector('.pill-dropdown');
                const fromHour = dropdown.querySelector('.from-hour');
                const fromMinute = dropdown.querySelector('.from-minute');
                const fromAmpm = dropdown.querySelector('.from-ampm');
                const toHour = dropdown.querySelector('.to-hour');
                const toMinute = dropdown.querySelector('.to-minute');
                const toAmpm = dropdown.querySelector('.to-ampm');
                const presetButtons = dropdown.querySelectorAll('.time-preset-btn');
                const doneButton = dropdown.querySelector('.close-time-picker');
                
                // Set initial values from current filters or defaults
                const setDropdownValues = (timeStr, prefix) => {
                    if (timeStr) {
                        console.log(`[setDropdownValues] Setting ${prefix} time: ${timeStr}`);
                        const [time, ampm] = timeStr.split(' ');
                        const [hours, minutes] = time.split(':');
                        
                        // Parse and validate hour (convert to integer, ensure it's 1-12)
                        let hourValue = parseInt(hours);
                        if (hourValue === 0) hourValue = 12; // Convert 0 to 12 for 12-hour format
                        if (hourValue > 12) hourValue = hourValue % 12 || 12; // Convert 24-hour to 12-hour
                        
                        // Validate that the hour exists in dropdown options (1-12)
                        if (hourValue < 1 || hourValue > 12) {
                            console.warn(`[setDropdownValues] Invalid hour value: ${hourValue}, defaulting to 10`);
                            hourValue = 10;
                        }
                        
                        console.log(`[setDropdownValues] Parsed values - Hour: ${hourValue}, Minutes: ${minutes}, AMPM: ${ampm}`);
                        
                        // Set the dropdown values
                        const hourDropdown = dropdown.querySelector(`.${prefix}-hour`);
                        const minuteDropdown = dropdown.querySelector(`.${prefix}-minute`);
                        const ampmDropdown = dropdown.querySelector(`.${prefix}-ampm`);
                        
                        if (hourDropdown) {
                            hourDropdown.value = hourValue.toString();
                            console.log(`[setDropdownValues] Set hour dropdown to: ${hourDropdown.value}`);
                        }
                        if (minuteDropdown) {
                            minuteDropdown.value = minutes;
                            console.log(`[setDropdownValues] Set minute dropdown to: ${minuteDropdown.value}`);
                        }
                        if (ampmDropdown) {
                            ampmDropdown.value = ampm;
                            console.log(`[setDropdownValues] Set AMPM dropdown to: ${ampmDropdown.value}`);
                        }
                    }
                };
                
                // Convert 24-hour defaults to 12-hour format for dropdowns
                const convert24to12 = (time24) => {
                    const [hours, minutes] = time24.split(':').map(Number);
                    const ampm = hours >= 12 ? 'PM' : 'AM';
                    let hour12 = hours % 12;
                    if (hour12 === 0) hour12 = 12;
                    return `${hour12}:${minutes.toString().padStart(2, '0')} ${ampm}`;
                };
                
                // Set dropdown values with defaults if no current filters exist
                const startTime12 = currentFilters.customTimeStart || convert24to12(defaultStartTime);
                const endTime12 = currentFilters.customTimeEnd || convert24to12(defaultEndTime);
                
                setDropdownValues(startTime12, 'from');
                setDropdownValues(endTime12, 'to');
                
                // Convert time to minutes since midnight for comparison
                const timeToMinutes = (hour, minute, ampm) => {
                    let totalMinutes = parseInt(minute);
                    let hourNum = parseInt(hour);
                    if (ampm === 'PM' && hourNum !== 12) hourNum += 12;
                    if (ampm === 'AM' && hourNum === 12) hourNum = 0;
                    totalMinutes += hourNum * 60;
                    return totalMinutes;
                };
                
                // Validation function
                const validateAndUpdateTime = () => {
                    const fromMinutes = timeToMinutes(fromHour.value, fromMinute.value, fromAmpm.value);
                    const toMinutes = timeToMinutes(toHour.value, toMinute.value, toAmpm.value);
                    
                    // If "to" time is before "from" time, adjust it
                    if (toMinutes <= fromMinutes) {
                        // Set "to" time to 1 hour after "from" time
                        const newToMinutes = fromMinutes + 60;
                        let newToHour = Math.floor(newToMinutes / 60) % 24;
                        let newToMinute = newToMinutes % 60;
                        let newToAmpm = newToHour >= 12 ? 'PM' : 'AM';
                        
                        // Round minutes to nearest 15-minute interval
                        newToMinute = Math.round(newToMinute / 15) * 15;
                        if (newToMinute >= 60) {
                            newToMinute = 0;
                            newToHour += 1;
                            if (newToHour >= 24) newToHour = 0;
                            newToAmpm = newToHour >= 12 ? 'PM' : 'AM';
                        }
                        
                        if (newToHour === 0) newToHour = 12;
                        else if (newToHour > 12) newToHour -= 12;
                        
                        toHour.value = newToHour;
                        toMinute.value = newToMinute.toString().padStart(2, '0');
                        toAmpm.value = newToAmpm;
                    }
                    
                    updateTimeDisplay();
                };
                
                // Time input change handlers
                const updateTimeDisplay = () => {
                    const startTimeStr = `${fromHour.value}:${fromMinute.value} ${fromAmpm.value}`;
                    const endTimeStr = `${toHour.value}:${toMinute.value} ${toAmpm.value}`;
                    
                    const displayText = `${startTimeStr} - ${endTimeStr}`;
                    
                    // Update the time filter in state using existing format
                    if (window.MicFinderState && window.MicFinderFilters) {
                        const filters = window.MicFinderState.getActiveFilters();
                        filters.customTimeStart = startTimeStr;
                        filters.customTimeEnd = endTimeStr;
                        filters.timeSetViaModal = true;
                        window.MicFinderState.setActiveFilters(filters);
                        window.MicFinderFilters.saveFilterState(filters);
                        window.MicFinderApp.render();
                    }
                };
                
                // Add change listeners to all dropdowns
                [fromHour, fromMinute, fromAmpm, toHour, toMinute, toAmpm].forEach(select => {
                    select.addEventListener('change', validateAndUpdateTime);
                });
                
                // Preset button handlers
                presetButtons.forEach(button => {
                    // Function to handle preset button interaction
                    const handlePresetSelection = (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        const preset = button.dataset.preset;
                        
                        let startHour, startMinute, startAmpm, endHour, endMinute, endAmpm;
                        switch(preset) {
                            case 'morning':
                                startHour = '9'; startMinute = '00'; startAmpm = 'AM';
                                endHour = '12'; endMinute = '00'; endAmpm = 'PM';
                                break;
                            case 'afternoon':
                                startHour = '12'; startMinute = '00'; startAmpm = 'PM';
                                endHour = '6'; endMinute = '00'; endAmpm = 'PM';
                                break;
                            case 'evening':
                                startHour = '6'; startMinute = '00'; startAmpm = 'PM';
                                endHour = '11'; endMinute = '00'; endAmpm = 'PM';
                                break;
                            case 'all-day':
                                startHour = '10'; startMinute = '00'; startAmpm = 'AM';
                                endHour = '11'; endMinute = '45'; endAmpm = 'PM';
                                break;
                        }
                        
                        fromHour.value = startHour;
                        fromMinute.value = startMinute;
                        fromAmpm.value = startAmpm;
                        toHour.value = endHour;
                        toMinute.value = endMinute;
                        toAmpm.value = endAmpm;
                        
                        updateTimeDisplay();
                    };
                    
                    // Add both click and touch events for better mobile support
                    button.addEventListener('click', handlePresetSelection);
                    button.addEventListener('touchend', handlePresetSelection, { passive: true });
                    
                    // Prevent default touch behavior to avoid double-firing
                    button.addEventListener('touchstart', (e) => {
                        e.stopPropagation();
                    }, { passive: true });
                });
                
                // Done button handler
                const handleDoneButtonSelection = (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    closeTimePicker();
                };
                
                // Add both click and touch events for better mobile support
                doneButton.addEventListener('click', handleDoneButtonSelection);
                doneButton.addEventListener('touchend', handleDoneButtonSelection, { passive: true });
                
                // Prevent default touch behavior to avoid double-firing
                doneButton.addEventListener('touchstart', (e) => {
                    e.stopPropagation();
                }, { passive: true });
                
                // Outside click handling is now managed by the popup manager
            }
            
            // Position and show the dropdown
            const dropdown = timePickerDropdown.querySelector('.pill-dropdown');
            
            // Smart positioning to avoid scrolling
            const dropdownWidth = 280;
            const dropdownHeight = 300; // Approximate height of compact time picker
            
            // Center horizontally but ensure it fits
            const left = Math.max(16, Math.min(window.innerWidth - dropdownWidth - 16, (window.innerWidth - dropdownWidth) / 2));
            
            // Position vertically to fit on screen (slightly higher)
            let top = Math.max(16, (window.innerHeight - dropdownHeight) * 0.45);
            
            // On mobile, position higher but still avoid keyboard issues
            if (window.innerWidth <= 768) {
                top = Math.max(16, Math.min(window.innerHeight * 0.3, (window.innerHeight - dropdownHeight) * 0.4));
            }
            
            dropdown.style.left = left + 'px';
            dropdown.style.top = top + 'px';
            
            // Use popup manager to open the time picker
            popupManager.openPopup(popupManager.popupTypes.TIME_PICKER, dropdown);
            
            // Show the dropdown
            dropdown.style.display = 'block';
            dropdown.classList.add('visible');
            
            // Prevent body scrolling while time picker is open
            document.body.classList.add('time-picker-open');
        }
        
        function closeTimePicker() {
            // Use popup manager to close the time picker
            if (popupManager.getActivePopupType() === popupManager.popupTypes.TIME_PICKER) {
                popupManager.closeActivePopup();
            } else {
                // Fallback: close directly if popup manager isn't tracking it
                const dropdown = document.getElementById('time-picker-dropdown');
                if (dropdown) {
                    const pillDropdown = dropdown.querySelector('.pill-dropdown');
                    if (pillDropdown) {
                        pillDropdown.style.display = 'none';
                        pillDropdown.classList.remove('visible');
                    }
                }
                document.body.classList.remove('time-picker-open');
            }
        }
        
        // --- Day Dropdown Functions ---
        // Note: The main toggleDayDropdown function is defined later in the file
        // This old implementation has been removed to prevent conflicts
        
        function positionMobileDropdown(dropdown, pill) {
            const pillRect = pill.getBoundingClientRect();
            const viewportHeight = window.innerHeight;
            
            // Position dropdown below the pill, but ensure it's visible
            let top = pillRect.bottom + 8;
            
            // If dropdown would go off screen, position it above the pill
            const dropdownHeight = 300; // Approximate height
            if (top + dropdownHeight > viewportHeight - 20) {
                top = pillRect.top - dropdownHeight - 8;
            }
            
            // Ensure it doesn't go above viewport
            if (top < 20) {
                top = 20;
            }
            
            dropdown.style.top = top + 'px';
            dropdown.style.left = '1rem';
            dropdown.style.right = '1rem';
            dropdown.style.width = 'auto';
        }
        
        // OLD FUNCTION DISABLED - conflicts with new implementation
        // function setupDayDropdownOptions(dropdown, pill) {
        //     const options = dropdown.querySelectorAll('.dropdown-option');
        //     // This has been replaced by the new toggleDayDropdown function
        // }
        
        // OLD FUNCTION DISABLED - conflicts with new implementation
        // function selectDayOption(option, dropdown, pill) {
        //     // This has been replaced by the new toggleDayDropdown function
        // }
        
        function updateDayFilter(newDayValue) {
            if (window.MicFinderState && window.MicFinderFilters && window.MicFinderApp) {
                const currentFilters = window.MicFinderState.getActiveFilters();
                
                // Update day filter
                const newFilters = { ...currentFilters };
                if (newDayValue && newDayValue.trim()) {
                    newFilters.day = newDayValue;
                } else {
                    delete newFilters.day;
                }
                
                console.log('🗓️ [Day Dropdown] Updating day filter:', newDayValue);
                
                // Temporarily disable auto-pill rendering
                window._disablePillRerender = true;
                
                // Apply the new filters
                window.MicFinderState.setActiveFilters(newFilters);
                window.MicFinderFilters.applyAllFilters();
                window.MicFinderApp.render();
                
                // Re-enable auto-pill rendering
                window._disablePillRerender = false;
                
                // Update modal day pills to stay in sync
                updateModalDaySelection(newDayValue);
            }
        }
        
        function updateModalDaySelection(selectedDay) {
            // Update the modal day pills to match the dropdown selection
            const modalDayPills = document.querySelectorAll('#dayOfWeek-filters .day-pill');
            modalDayPills.forEach(pill => {
                if (pill.dataset.day === 'any') {
                    // "Any Day" is active when no specific day is selected
                    pill.classList.toggle('active', !selectedDay || !selectedDay.trim());
                } else {
                    // Specific days are active when they match the selection
                    pill.classList.toggle('active', pill.dataset.day === selectedDay);
                }
            });
            
            // Update mobile day select if it exists
            const mobileDaySelect = document.getElementById('mobile-day-select');
            if (mobileDaySelect) {
                mobileDaySelect.value = selectedDay || '';
            }
            
            // Also update the internal filterState to keep things in sync
            if (typeof filterState !== 'undefined') {
                filterState.dayOfWeek.clear();
                if (selectedDay && selectedDay.trim()) {
                    filterState.dayOfWeek.add(selectedDay);
                }
            }
        }
        
        // Function to ensure pills stay in sync with global state
        function syncPillsWithGlobalState() {
            if (window.MicFinderState) {
                const globalFilters = window.MicFinderState.getActiveFilters();
                
                // Update day selection in modal to match global state
                if (globalFilters.day && globalFilters.day !== '') {
                    const selectedDay = Array.isArray(globalFilters.day) ? globalFilters.day[0] : globalFilters.day;
                    updateModalDaySelection(selectedDay);
                } else {
                    // No day selected or "Any Day" - update to show "Any Day" as active
                    updateModalDaySelection('');
                }
            }
        }
    </script>
</head>
<body class="h-screen flex flex-col">
    <!-- Skip to main content link for accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Loading Spinner -->
    <div id="loading-spinner" class="loading-spinner">
        <div class="spinner"></div>
    </div>

        <!-- Enhanced Intro Overlay -->
    <div id="intro-overlay" class="hidden fixed inset-0 bg-black bg-opacity-95 z-[60] flex items-center justify-center p-3" style="backdrop-filter: blur(4px);">
        <div class="bg-white rounded-2xl max-w-md w-full max-h-[90vh] overflow-y-auto p-6 text-center shadow-[0_20px_60px_rgba(0,0,0,0.8)] border-2 border-gray-300 mobile-intro-modal" style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);">
            <!-- Dynamic Header -->
            <div class="mb-4">
                <h2 id="dynamic-welcome-title" class="text-2xl font-black text-gray-900 mb-2 drop-shadow-sm">Ready to find your perfect stage?</h2>
                <p id="dynamic-welcome-subtitle" class="text-sm text-gray-700 font-medium">Discover local comedy venues and open mics</p>
            </div>
            
            <!-- Skip Option for Return Users -->
            <div id="return-user-banner" class="hidden mb-4 p-3 bg-blue-50 rounded-xl border border-blue-200">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center">
                            <span class="text-white text-xs">👋</span>
                        </div>
                        <span class="text-blue-800 font-semibold text-sm">Welcome back!</span>
                    </div>
                    <button id="skip-intro-btn" class="text-blue-600 hover:text-blue-800 font-medium text-xs underline">
                        Skip intro →
                    </button>
                </div>
            </div>

            <!-- Benefit-Focused Features -->
            <div class="text-left space-y-3 mb-6">
                <div class="flex items-center gap-3 p-3 rounded-lg bg-blue-50 hover:bg-blue-100 transition-colors duration-200 touch-manipulation">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center text-white font-black text-sm shadow-lg flex-shrink-0">🔍</div>
                    <div>
                        <div class="text-gray-900 font-bold text-base mb-0.5">Find your perfect stage in seconds</div>
                        <div class="text-gray-700 font-medium text-sm">Discover venues that match your style and schedule</div>
                </div>
                </div>
                <div id="filters-tutorial-trigger" class="flex items-center gap-3 p-3 rounded-lg bg-green-50 hover:bg-green-100 cursor-pointer transition-colors duration-200 touch-manipulation" role="button" tabindex="0" aria-label="Learn about smart filtering">
                    <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-green-600 rounded-full flex items-center justify-center text-white font-black text-sm shadow-lg flex-shrink-0">⚡</div>
                    <div>
                        <div class="text-gray-900 font-bold text-base mb-0.5">Never miss a show that fits your schedule</div>
                        <div class="text-gray-700 font-medium text-sm">Smart filters find exactly what you're looking for</div>
                </div>
                </div>
                <div class="flex items-center gap-3 p-3 rounded-lg bg-purple-50 hover:bg-purple-100 transition-colors duration-200 touch-manipulation">
                    <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-purple-600 rounded-full flex items-center justify-center text-white font-black text-sm shadow-lg flex-shrink-0">🗺️</div>
                    <div>
                        <div class="text-gray-900 font-bold text-base mb-0.5">Explore your comedy scene</div>
                        <div class="text-gray-700 font-medium text-sm">Discover venues, times, and performer communities</div>
            </div>
                </div>
            </div>

            <!-- Enhanced Smart CTA Button -->
            <div class="space-y-3">
                <button id="smart-start-btn" class="w-full bg-gradient-to-r from-violet-600 to-purple-600 text-white px-6 py-4 rounded-xl hover:from-violet-700 hover:to-purple-700 font-bold text-base shadow-lg transition-all duration-300 transform hover:scale-105 border-2 border-violet-500 touch-manipulation">
                    <div class="flex items-center justify-center gap-2">
                        <span>🚀</span>
                        <span>Start discovering venues</span>
                    </div>
                    <div class="text-sm font-normal opacity-90 mt-1">
                        Interactive walkthrough included
                    </div>
                </button>
                <div class="text-center">
                    <button id="skip-walkthrough" class="text-gray-400 hover:text-gray-300 text-sm underline transition-colors duration-200">
                        Skip walkthrough, go direct
            </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Add this flex container near the top of <body>, before the rest of the content -->
    <div id="search-and-filters-row"
         class="fixed top-8 left-0 right-0 z-50 flex flex-col items-start gap-4 pointer-events-none"
         style="width:100%; background:transparent;">
      <!-- Search Bar Row -->
      <div class="flex flex-col w-full pointer-events-auto">
        <!-- Search Input -->
        <div class="flex flex-row items-center gap-4 w-full">
          <div id="map-search-bar" class="min-w-0 flex-grow" style="min-width: 0;">
            <div class="flex items-center rounded-full px-3 py-1 w-full relative bg-gray-900/90 shadow-lg" style="pointer-events: auto;">
                <input id="search-input" type="text" placeholder="Search mics and venues" class="flex-grow bg-transparent outline-none text-gray-100 text-sm px-1 placeholder-gray-400" autocomplete="off" style="min-width:0; background: transparent !important; background-color: transparent !important; border: none !important; color: #f3f4f6 !important;" />
                <button id="search-btn" class="ml-1 text-gray-400 hover:text-indigo-400 focus:outline-none">
                    <i class="fa fa-search fa-lg" aria-hidden="true"></i>
                </button>
                <!-- Clear (x) button -->
                <button id="clear-search-btn" class="ml-1 text-gray-400 hover:text-indigo-400 focus:outline-none hidden" aria-label="Clear search">
                    <i class="fa fa-times fa-lg" aria-hidden="true"></i>
                </button>
                <!-- Help/Info button -->
                <button id="show-intro-btn" class="ml-1 text-gray-400 hover:text-indigo-400 focus:outline-none" aria-label="Show intro">
                    <i class="fa fa-question-circle fa-lg" aria-hidden="true"></i>
                </button>
                <!-- Autocomplete Dropdown -->
                <div id="autocomplete-dropdown" class="autocomplete-dropdown hidden absolute top-full left-0 right-0 mt-1 z-50 max-h-60 overflow-y-auto">
                    <!-- Suggestions will be populated here -->
                </div>
            </div>
          </div>
          <div class="w-50"></div>
          <!-- Pills Row - Desktop Layout -->
          <div class="flex flex-row items-center min-w-[1.5rem] h-12 ml-80 mr-40 hidden lg:flex pointer-events-auto">
            <button id="modal-button" class="bg-gray-100 text-gray-800 border border-gray-400 shadow-md hover:bg-gray-200 hover:border-gray-500 flex-shrink-0 mr-2 text-sm font-medium py-2.5 px-5 rounded-xl transition-colors flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M11.5 2a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3M9.05 3a2.5 2.5 0 0 1 4.9 0H16v1h-2.05a2.5 2.5 0 0 1-4.9 0H0V3zM4.5 7a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3M2.05 8a2.5 2.5 0 0 1 4.9 0H16v1H6.95a2.5 2.5 0 0 1-4.9 0H0V8zm9.45 4a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3m-2.45 1a2.5 2.5 0 0 1 4.9 0H16v1h-2.05a2.5 2.5 0 0 1-4.9 0H0v-1z"/>
              </svg>
              <span id="all-filters-text">All Filters</span>
            </button>
            <div id="active-pills-row" class="flex flex-row gap-2 items-center min-w-[1.5rem] h-12 overflow-x-auto">
              <!-- Only filter pills will be rendered here by JS -->
            </div>
          </div>
        </div>
        
        <!-- Pills Row - Mobile/Minimized Layout -->
        <div class="mobile-pills-row w-full flex flex-row items-center lg:hidden pointer-events-auto px-4" style="margin-top: 2.75rem;">
          <div id="active-pills-row-mobile"
            class="flex flex-row items-center gap-2 overflow-x-auto">
            <!-- All Filters button and filter pills will be rendered here by JS -->
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Element -->
    <div id="filter-modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden items-center justify-center p-4">
        <div id="modal-content" class="bg-gray-900/80 backdrop-blur-sm border border-white/10 rounded-lg shadow-xl w-full max-w-2xl flex flex-col">
            <header class="p-4 flex-shrink-0 flex items-center justify-between">
                <h2 class="text-xl font-bold text-white">All Filters</h2>
                <button id="close-modal-x" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            </header>
            <main class="p-6 space-y-4 text-gray-200 overflow-y-auto border-y border-white/10">
                <!-- Day of Week Filter -->
                <div>
                    <h3 class="flex items-center text-lg font-semibold mb-3 text-white">
                        Day of Week
                    </h3>
                    <!-- Pills for desktop -->
                    <div class="flex flex-wrap gap-2" id="dayOfWeek-filters">
                        <button class="day-pill" data-day="any">Any Day</button>
                        <button class="day-pill" data-day="Monday">Mon</button>
                        <button class="day-pill" data-day="Tuesday">Tue</button>
                        <button class="day-pill" data-day="Wednesday">Wed</button>
                        <button class="day-pill" data-day="Thursday">Thu</button>
                        <button class="day-pill" data-day="Friday">Fri</button>
                        <button class="day-pill" data-day="Saturday">Sat</button>
                        <button class="day-pill" data-day="Sunday">Sun</button>
                    </div>
                    <!-- Dropdown for mobile -->
                    <div class="mobile-day-select-wrapper" style="display:none;">
                        <select id="mobile-day-select" class="mobile-day-select">
                            <option value="">Any Day</option>
                            <option value="Monday">Monday</option>
                            <option value="Tuesday">Tuesday</option>
                            <option value="Wednesday">Wednesday</option>
                            <option value="Thursday">Thursday</option>
                            <option value="Friday">Friday</option>
                            <option value="Saturday">Saturday</option>
                            <option value="Sunday">Sunday</option>
                        </select>
                        <!-- Removed the X close button -->
                    </div>
                </div>
                <!-- Time & Schedule Filter (Custom Inputs) -->
                <div class="border-t border-white/10 pt-4">
                    <h3 class="flex items-center text-lg font-semibold mb-3 text-white">
                        Time & Schedule
                    </h3>
                    <div class="flex items-center gap-4">
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-gray-400">From</label>
                            <div id="time-from-picker" class="mt-9"></div>
                        </div>
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-gray-400">To</label>
                            <div id="time-to-picker" class="mt-9"></div>
                        </div>
                    </div>
                </div>
                <!-- Location Filter -->
                <div class="border-t border-white/10 pt-4">
                    <h3 class="flex items-center text-lg font-semibold mb-3 text-white">
                        Location
                    </h3>
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-x-4 gap-y-2" id="location-filters"></div>
                </div>
                <!-- Details Filter -->
                <div class="border-t border-white/10 pt-4">
                    <h3 class="flex items-center text-lg font-semibold mb-3 text-white">
                        Details
                    </h3>
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-x-4 gap-y-2" id="details-filters"></div>
                </div>
                <!-- Favorites Filter -->
                <div class="border-t border-white/10 pt-4">
                    <h3 class="flex items-center text-lg font-semibold mb-3 text-white">
                        Favorites
                    </h3>
                    <div id="favorites-filter" class="flex items-center"></div>
                </div>
            </main>
            <footer class="p-4 flex-shrink-0 flex justify-between items-center gap-8">
                <button id="clear-filters" class="font-bold text-white hover:text-gray-300 underline">Clear all</button>
                <button id="apply-filters" class="bg-violet-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-violet-700">Show results</button>
            </footer>
        </div>
    </div>

    <!-- Context Menu for Reset to Default Filters -->
    <div id="reset-context-menu" class="fixed border border-gray-300 rounded-lg shadow-lg z-50 hidden" style="background-color: #1f2937 !important;">
        <div class="py-1">
            <button id="reset-to-default-filters" class="w-full text-left px-4 py-2 text-sm rounded-t-lg" style="background-color: #1f2937 !important; color: #FFFFFF !important; font-weight: 500 !important;">
                Reset to Default Filters
            </button>
        </div>
    </div>

    <div class="flex flex-row flex-grow overflow-hidden">
        
        <main class="flex-1 bg-gray-200" id="main-content">
             <div id="map" role="application" aria-label="Interactive map showing comedy mic locations">
                 <div class="map-controls" role="toolbar" aria-label="Map controls">
                     <button id="directions-btn" class="map-control-btn text-blue-600 hover:text-blue-800 focus:outline-none" title="Find my location" aria-label="Find my location" style="display: block !important; visibility: visible !important;">
                         <i class="fa fa-location-arrow fa-lg" aria-hidden="true"></i>
                     </button>
                     <button class="map-control-btn" id="zoom-to-fit-btn" title="Reset map view" aria-label="Reset map view"><i class="fa-solid fa-expand-arrows-alt" aria-hidden="true"></i></button>
                 </div>
             </div>
        </main>

        <aside id="right-sidebar" class="sidebar w-96 bg-gray-800 border-l border-gray-700 flex flex-col flex-shrink-0" role="complementary" aria-label="Mic list">
            <div class="flex justify-between items-center p-4 border-b border-gray-700 flex-shrink-0">
                <button id="right-sidebar-toggle" class="p-2 text-gray-500 hover:text-indigo-600 desktop-only" aria-label="Toggle sidebar">
                    <i class="fa-solid fa-chevron-right" aria-hidden="true"></i>
                </button>
                <div class="sidebar-header-text flex-grow ml-4">
                     <h2 id="results-heading" class="text-lg font-bold text-gray-100">Mics for Today <span id="mic-count" class="">(0)</span></h2>
                     <div id="last-updated" class="text-sm text-gray-400 mt-1">Last updated: <span id="last-updated-time">--:--</span></div>
                </div>
                <button class="mobile-header-btn mobile-only" id="mobile-list-close" title="Close" aria-label="Close list view">
                    <i class="fa-solid fa-times" aria-hidden="true"></i>
                </button>
            </div>
            <div class="sidebar-content flex-grow flex flex-col min-h-0">
                <div class="p-4 flex flex-col gap-4 border-b border-gray-700">
                    <div class="flex items-center justify-between">
                        <label for="map-filter-toggle" class="text-sm text-gray-600" id="map-filter-label">Showing all mics in sidebar</label>
                        <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="toggle" id="map-filter-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" aria-label="Filter mics to map view only"/>
                            <label for="map-filter-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                    </div>
                </div>
                <div class="px-4 py-2 text-lg font-bold text-gray-100 bg-gray-800" id="results-label">Map Results <span id="results-count">(0)</span></div>
                <div id="mic-list" class="flex-grow overflow-y-auto custom-scrollbar" role="list" aria-label="List of comedy mics"></div>
            </div>
        </aside>
    </div>

    <!-- Modal for Expanded Mic Details -->
    <div id="mic-detail-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4 transition-opacity duration-300" 
         role="dialog" 
         aria-modal="true" 
         aria-labelledby="modal-title" 
         aria-describedby="modal-description">
        <div id="mic-detail-modal-content" class="bg-white rounded-2xl shadow-xl w-full overflow-y-auto opacity-0">
            <!-- Content is injected by JavaScript -->
        </div>
    </div>

    <!-- Day Selection Popup -->
    <div id="day-selection-popup" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-gray-900 border border-gray-700 rounded-2xl shadow-xl w-full max-w-xs p-4">
            <div class="text-center mb-3">
                <h3 class="text-base font-semibold text-white">Select Day</h3>
            </div>
            <div class="space-y-1">
                <button class="day-option w-full text-left px-3 py-2 rounded-lg text-white hover:bg-gray-700 transition-colors text-sm" data-value="Monday">Monday</button>
                <button class="day-option w-full text-left px-3 py-2 rounded-lg text-white hover:bg-gray-700 transition-colors text-sm" data-value="Tuesday">Tuesday</button>
                <button class="day-option w-full text-left px-3 py-2 rounded-lg text-white hover:bg-gray-700 transition-colors text-sm" data-value="Wednesday">Wednesday</button>
                <button class="day-option w-full text-left px-3 py-2 rounded-lg text-white hover:bg-gray-700 transition-colors text-sm" data-value="Thursday">Thursday</button>
                <button class="day-option w-full text-left px-3 py-2 rounded-lg text-white hover:bg-gray-700 transition-colors text-sm" data-value="Friday">Friday</button>
                <button class="day-option w-full text-left px-3 py-2 rounded-lg text-white hover:bg-gray-700 transition-colors text-sm" data-value="Saturday">Saturday</button>
                <button class="day-option w-full text-left px-3 py-2 rounded-lg text-white hover:bg-gray-700 transition-colors text-sm" data-value="Sunday">Sunday</button>
                <button class="day-option w-full text-left px-3 py-2 rounded-lg text-white hover:bg-gray-700 transition-colors text-sm" data-value="">Any Day</button>
            </div>
            <div class="mt-4 text-center">
                <button id="close-day-popup" class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition-colors text-sm">Cancel</button>
            </div>
        </div>
    </div>



    <!-- Borough Selection Popup -->
    <div id="borough-selection-popup" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-gray-900 border border-gray-700 rounded-2xl shadow-xl w-full max-w-sm p-6">
            <div class="text-center mb-4">
                <h3 class="text-lg font-semibold text-white">Select Borough</h3>
            </div>
            <div class="space-y-2">
                <button class="borough-option w-full text-left px-4 py-3 rounded-lg text-white hover:bg-gray-700 transition-colors" data-value="Manhattan">Manhattan</button>
                <button class="borough-option w-full text-left px-4 py-3 rounded-lg text-white hover:bg-gray-700 transition-colors" data-value="Brooklyn">Brooklyn</button>
                <button class="borough-option w-full text-left px-4 py-3 rounded-lg text-white hover:bg-gray-700 transition-colors" data-value="Queens">Queens</button>
                <button class="borough-option w-full text-left px-4 py-3 rounded-lg text-white hover:bg-gray-700 transition-colors" data-value="">Any Borough</button>
            </div>
            <div class="mt-6 text-center">
                <button id="close-borough-popup" class="px-6 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition-colors">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Neighborhood Selection Popup -->
    <div id="neighborhood-selection-popup" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-gray-900 border border-gray-700 rounded-2xl shadow-xl w-full max-w-sm p-6 max-h-96 overflow-y-auto">
            <div class="text-center mb-4">
                <h3 class="text-lg font-semibold text-white">Select Neighborhoods</h3>
                <p class="text-sm text-gray-400 mt-1">Select multiple neighborhoods</p>
            </div>
            <div class="space-y-2" id="neighborhood-options">
                <!-- Neighborhood options will be populated dynamically -->
            </div>
            <div class="mt-6 text-center">
                <button id="close-neighborhood-popup" class="px-6 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition-colors">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Details Selection Popup -->
    <div id="details-selection-popup" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-gray-900 border border-gray-700 rounded-2xl shadow-xl w-full max-w-sm p-6">
            <div class="text-center mb-4">
                <h3 class="text-lg font-semibold text-white">Select Details</h3>
            </div>
            <div class="space-y-2">
                <button class="detail-option w-full text-left px-4 py-3 rounded-lg text-white hover:bg-gray-700 transition-colors" data-value="Free">Free</button>
                <button class="detail-option w-full text-left px-4 py-3 rounded-lg text-white hover:bg-gray-700 transition-colors" data-value="Paid">Paid</button>
                <button class="detail-option w-full text-left px-4 py-3 rounded-lg text-white hover:bg-gray-700 transition-colors" data-value="1 Item Min">1 Item Min</button>
                <button class="detail-option w-full text-left px-4 py-3 rounded-lg text-white hover:bg-gray-700 transition-colors" data-value="In-person Sign-up">In-person Sign-up</button>
                <button class="detail-option w-full text-left px-4 py-3 rounded-lg text-white hover:bg-gray-700 transition-colors" data-value="Online Sign-up">Online Sign-up</button>
                <button class="detail-option w-full text-left px-4 py-3 rounded-lg text-white hover:bg-gray-700 transition-colors" data-value="">Any Details</button>
            </div>
            <div class="mt-6 text-center">
                <button id="close-details-popup" class="px-6 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition-colors">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Modal for Adding/Editing Mics -->
    <div id="add-mic-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4">
        <div class="bg-gray-800 border border-gray-700 rounded-2xl shadow-xl w-full max-w-lg max-h-full overflow-y-auto">
            <div class="p-6 space-y-4">
                <div class="flex justify-between items-center">
                    <h2 id="form-title" class="text-2xl font-bold text-gray-100">Add New Mic</h2>
                    <button id="close-modal-btn" class="text-gray-400 hover:text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <form id="add-mic-form" class="space-y-4">
                    
                    <input type="hidden" id="mic-id">
    
                    <div>
                        <label for="venue" class="block text-sm font-medium text-gray-300">Venue Name</label>
                        <input type="text" id="venue" class="mt-1 block w-full bg-gray-700 border-gray-600 text-white rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                    </div>
    
                    <div>
                        <label for="address" class="block text-sm font-medium text-gray-300">Address</label>
                        <input type="text" id="address" class="mt-1 block w-full bg-gray-700 border-gray-600 text-white rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="lat" class="block text-sm font-medium text-gray-300">Latitude</label>
                            <input type="number" step="any" id="lat" class="mt-1 block w-full bg-gray-700 border-gray-600 text-white rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                        </div>
                        <div>
                            <label for="lon" class="block text-sm font-medium text-gray-300">Longitude</label>
                            <input type="number" step="any" id="lon" class="mt-1 block w-full bg-gray-700 border-gray-600 text-white rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                        </div>
                    </div>
    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="day" class="block text-sm font-medium text-gray-300">Day of Week</label>
                            <select id="day" class="mt-1 block w-full bg-gray-700 border-gray-600 text-white rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                <option>Monday</option>
                                <option>Tuesday</option>
                                <option>Wednesday</option>
                                <option>Thursday</option>
                                <option>Friday</option>
                                <option>Saturday</option>
                                <option>Sunday</option>
                            </select>
                        </div>
                        <div>
                            <label for="time" class="block text-sm font-medium text-gray-300">Time (e.g., 7:30 PM)</label>
                            <input type="text" id="time" class="mt-1 block w-full bg-gray-700 border-gray-600 text-white rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        </div>
                    </div>
    
                    <div>
                        <label for="borough" class="block text-sm font-medium text-gray-300">Borough</label>
                        <input type="text" id="borough" class="mt-1 block w-full bg-gray-700 border-gray-600 text-white rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
    
                    <div>
                        <label for="cost" class="block text-sm font-medium text-gray-300">Cost (e.g., Free, $5)</label>
                        <input type="text" id="cost" class="mt-1 block w-full bg-gray-700 border-gray-600 text-white rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
    
                    <div>
                        <label for="details" class="block text-sm font-medium text-gray-300">Details (e.g., 5 min, Lottery)</label>
                        <textarea id="details" rows="3" class="mt-1 block w-full bg-gray-700 border-gray-600 text-white rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></textarea>
                    </div>
    
                    <div class="flex justify-end pt-4 space-x-2 border-t border-gray-700">
                        <button type="button" id="cancel-add-mic" class="px-4 py-2 bg-gray-600 text-gray-200 rounded-md hover:bg-gray-500">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Save Mic</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Hover Card Element -->
    <div id="hover-card" class="hover-card">
        <div class="hover-card-title"></div>
        <div class="hover-card-content"></div>
    </div>

    <!-- Bottom Bar: Only for Minimized/Mobile View -->
    <div id="bottom-bar-mobile">
        <div class="bottom-bar-content">
            <!-- Left: Selected mic info -->
            <div class="bottom-bar-left">
                <div class="bottom-bar-info" id="bottom-bar-info" style="display: none;">
                    <div class="title" id="bottom-selection-title"></div>
                    <div class="subtitle" id="bottom-selection-subtitle"></div>
                </div>
            </div>
            <!-- Center: All actions centered -->
            <div class="bottom-bar-center">
                <button class="quick-action-btn" id="find-location-btn-mobile" title="Find my location" aria-label="Find my location">
                    <i class="fa fa-location-arrow" aria-hidden="true"></i>
                    <span class="btn-label">My Location</span>
                </button>
                <button class="quick-action-btn" id="reset-map-btn-mobile" title="Reset map view" aria-label="Reset map view">
                    <i class="fa-solid fa-expand-arrows-alt" aria-hidden="true"></i>
                    <span class="btn-label">Recenter</span>
                </button>
                <button class="quick-action-btn" id="favorites-btn-mobile" title="Show favorites" aria-label="Show favorites">
                    <i class="fa-regular fa-star" aria-hidden="true"></i>
                    <span class="btn-label">Favorites</span>
                </button>
                <button class="quick-action-btn" id="filters-btn-mobile" title="All filters" aria-label="All filters">
                    <i class="fa-solid fa-filter" aria-hidden="true"></i>
                    <span class="btn-label">Filters</span>
                </button>
                <button class="quick-action-btn" id="list-view-btn-mobile" title="List view" aria-label="Switch to list view">
                    <i class="fa-solid fa-list" aria-hidden="true"></i>
                    <span class="btn-label">Mics</span>
                </button>
            </div>
            <!-- Right: Empty -->
            <div class="bottom-bar-right">
            </div>
        </div>
    </div>
    <style>
    /* Bottom bar for minimized/mobile view only */
    #bottom-bar-mobile {
        display: none;
    }
    @media (max-width: 1023px) {
        #bottom-bar-mobile {
            display: block;
            position: fixed;
            left: 0; 
            right: 0; 
            bottom: 0;
            z-index: 9999;
            background: #18191a;
            border-top: 1px solid rgba(0,0,0,0.1);
            box-shadow: 0 -2px 8px rgba(0,0,0,0.12);
            padding: 0.5rem 0.75rem;
            transform: none !important;
            transition: none !important;
            will-change: auto;
        }
        .bottom-bar-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            position: relative;
            transform: none !important;
            transition: none !important;
        }
        .bottom-bar-left, .bottom-bar-center, .bottom-bar-right {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .bottom-bar-left { 
            position: absolute;
            left: 0;
            flex: 0;
            min-width: 0; 
        }
        .bottom-bar-center {
            justify-content: center;
            gap: 1.5rem;
        }
        .bottom-bar-right { 
            position: absolute;
            right: 0;
            flex: 0;
        }
        .bottom-bar-info .title {
            color: white;
            font-size: 0.85rem;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .bottom-bar-info .subtitle {
            color: #9ca3af;
            font-size: 0.75rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .quick-action-btn, .bottom-bar-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 60px; height: 60px;
            background: rgba(255,255,255,0.12);
            border: 1px solid rgba(255,255,255,0.25);
            border-radius: 12px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            gap: 4px;
        }
        .bottom-bar-btn.primary {
            background: #3b82f6;
            border-color: #3b82f6;
        }
        .bottom-bar-btn.primary:hover {
            background: #2563eb;
            border-color: #2563eb;
        }
        .quick-action-btn:hover, .bottom-bar-btn:hover {
            background: rgba(255,255,255,0.18);
        }
        
        /* Text label styling */
        .btn-label {
            font-size: 0.75rem;
            color: #ffffff;
            text-align: center;
            line-height: 1.2;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            letter-spacing: 0.02em;
        }
        /* Hide map controls in minimized/mobile view */
        .map-controls {
            display: none !important;
        }
        
        /* Ensure body doesn't interfere with bottom bar */
        body {
            padding-bottom: 0 !important;
            margin-bottom: 0 !important;
        }
        
        /* Ensure main content doesn't push bottom bar */
        main {
            padding-bottom: 0 !important;
            margin-bottom: 0 !important;
        }
        
        /* Mobile sidebar styles */
        @media (max-width: 1023px) {
            /* Additional mobile-specific bottom bar adjustments */
            @media (max-width: 480px) {
                #bottom-bar-mobile {
                    padding: 1rem 1rem;
                }
                .bottom-bar-content {
                    margin: 0 0.5rem;
                }
                .bottom-bar-center {
                    gap: 1rem;
                }
            }
            #right-sidebar {
                position: fixed !important;
                top: 0 !important;
                right: -100% !important;
                width: 100% !important;
                height: 100vh !important;
                z-index: 1000 !important;
                transform: translateX(100%) !important;
                transition: transform 0.3s ease !important;
                display: none !important;
                background: #232533 !important;
                border-left: none !important;
            }
            
            #right-sidebar.mobile-open {
                right: 0 !important;
                transform: translateX(0) !important;
                display: flex !important;
            }
            
            /* Ensure mobile close button is visible */
            #mobile-list-close {
                display: flex !important;
                align-items: center;
                justify-content: center;
                width: 44px;
                height: 44px;
                background: none;
                border: none;
                color: #9ca3af;
                font-size: 1.5rem;
                cursor: pointer;
                transition: color 0.2s;
            }
            
            #mobile-list-close:hover {
                color: #fff;
            }
            
            /* Hide desktop close button on mobile */
            #right-sidebar-toggle {
                display: none !important;
            }
            
            /* Ensure proper scrolling in mobile sidebar */
            #right-sidebar .sidebar-content {
                flex: 1;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            /* Mobile sidebar header styling */
            #right-sidebar .flex.justify-between.items-center.p-4 {
                background: #232533 !important;
                border-bottom: 1px solid #374151 !important;
                position: sticky;
                top: 0;
                z-index: 10;
            }
            
            /* Ensure mic list takes full height */
            #mic-list {
                flex: 1;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 2rem; /* Add bottom padding to prevent cut-off */
            }
        }
    }
    </style>

    <script>
        // --- State Management ---
        let filterState = {
            dayOfWeek: new Set(),
            time: { from: '', to: '' },
            locations: new Set(),
            details: new Set(),
            favorites: new Set()
        };
        const locationOptions = ["Manhattan", "Brooklyn", "Queens"];
        const detailOptions = ["Free", "Paid", "1 Item Min", "In-person Sign-up", "Online Sign-up"];
        const modalButton = document.getElementById('modal-button');
        const filterModal = document.getElementById('filter-modal');
        const closeModalX = document.getElementById('close-modal-x');
        const applyFiltersButton = document.getElementById('apply-filters');
        const clearFiltersButton = document.getElementById('clear-filters');
        const filtersScrollContainer = document.getElementById('filters-scroll-container');
        const allFiltersText = document.getElementById('all-filters-text');
        const createCustomTimePicker = (containerId) => {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = `
                <div class="custom-time-picker">
                    <div class="relative"><button class="time-part" data-part="hour">12</button><div class="time-dropdown hidden top-full mt-1" data-part="hour"></div></div>
                    <span class="text-white mx-1">:</span>
                    <div class="relative"><button class="time-part" data-part="minute">00</button><div class="time-dropdown hidden top-full mt-1" data-part="minute"></div></div>
                    <div class="relative"><button class="time-part" data-part="period">AM</button><div class="time-dropdown hidden top-full mt-1" data-part="period"></div></div>
                </div>
            `;
            const parts = {
                hour: container.querySelector('button[data-part="hour"]'),
                minute: container.querySelector('button[data-part="minute"]'),
                period: container.querySelector('button[data-part="period"]')
            };
            const dropdowns = {
                hour: container.querySelector('.time-dropdown[data-part="hour"]'),
                minute: container.querySelector('.time-dropdown[data-part="minute"]'),
                period: container.querySelector('.time-dropdown[data-part="period"]')
            };
            dropdowns.hour.innerHTML = Array.from({length: 12}, (_, i) => `<div class="time-dropdown-option">${i + 1}</div>`).join('');
            dropdowns.minute.innerHTML = ['00', '15', '30', '45'].map(m => `<div class="time-dropdown-option">${m}</div>`).join('');
            dropdowns.period.innerHTML = `<div class="time-dropdown-option">AM</div><div class="time-dropdown-option">PM</div>`;
            Object.keys(parts).forEach(part => {
                const button = parts[part];
                const dropdown = dropdowns[part];
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const isHidden = dropdown.classList.contains('hidden');
                    closeAllDropdowns();
                    if(isHidden) dropdown.classList.remove('hidden');
                });
                dropdown.addEventListener('click', (e) => {
                    if (e.target.classList.contains('time-dropdown-option')) {
                        button.textContent = e.target.textContent;
                        dropdown.classList.add('hidden');
                        
                        // Update filterState with new time values
                        filterState.time.from = readPickerState('time-from-picker');
                        filterState.time.to = readPickerState('time-to-picker');
                        
                        // Update global filters and re-render
                        const newFilters = {};
                        newFilters.customTimeStart = filterState.time.from ? to12HourString(filterState.time.from) : '';
                        newFilters.customTimeEnd = filterState.time.to ? to12HourString(filterState.time.to) : '';
                        
                        // Preserve existing filters
                        const existingFilters = window.MicFinderState ? window.MicFinderState.getActiveFilters() : {};
                        Object.assign(newFilters, existingFilters);
                        
                        // Mark that time was set via sidebar
                        if (newFilters.customTimeStart && newFilters.customTimeEnd) {
                            newFilters.timeSetViaModal = true;
                        }
                        
                        // Update global state and re-render
                        if (window.MicFinderState && window.MicFinderFilters) {
                            window.MicFinderState.setActiveFilters(newFilters);
                            window.MicFinderFilters.saveFilterState(newFilters);
                            window.MicFinderApp.render();
                        }
                        
                        // Re-render pills when time changes
                        setTimeout(renderActivePills, 0);
                    }
                });
            });
        };
        const closeAllDropdowns = () => document.querySelectorAll('.time-dropdown').forEach(d => d.classList.add('hidden'));
        const updatePickerFromState = (pickerId, timeStr) => {
            if (!timeStr) return;
            const container = document.getElementById(pickerId);
            if (!container) return;
            const [hour24, minute] = timeStr.split(':').map(Number);
            const period = hour24 >= 12 ? 'PM' : 'AM';
            let hour12 = hour24 % 12;
            if (hour12 === 0) hour12 = 12;
            container.querySelector('button[data-part="hour"]').textContent = hour12;
            container.querySelector('button[data-part="minute"]').textContent = minute.toString().padStart(2, '0');
            container.querySelector('button[data-part="period"]').textContent = period;
        };
        const readPickerState = (pickerId) => {
            const container = document.getElementById(pickerId);
            if (!container) return '00:00';
            let hour = parseInt(container.querySelector('button[data-part="hour"]').textContent);
            const minute = parseInt(container.querySelector('button[data-part="minute"]').textContent);
            const period = container.querySelector('button[data-part="period"]').textContent;
            if (period === 'PM' && hour !== 12) hour += 12;
            else if (period === 'AM' && hour === 12) hour = 0;
            return `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
        };
        createCustomTimePicker('time-from-picker');
        createCustomTimePicker('time-to-picker');
        const createCheckboxes = (containerId, options) => {
            const container = document.getElementById(containerId);
            container.innerHTML = options.map(opt => `<label class="flex items-center cursor-pointer"><input type="checkbox" value="${opt}" class="custom-checkbox"><span class="ml-2 text-gray-200">${opt}</span></label>`).join('');
        };
        document.querySelectorAll('.day-pill').forEach(pill => {
            pill.addEventListener('click', function () {
                // Only allow one active day at a time
                document.querySelectorAll('.day-pill').forEach(p => p.classList.remove('active'));
                this.classList.add('active');

                // Get selected day
                const selectedDay = this.dataset.day;
                
                // Handle "Any Day" selection
                let fromTime, toTime;
                
                if (selectedDay === 'any') {
                    // Clear day filter and set default time range
                    filterState.dayOfWeek.clear();
                    fromTime = '10:00';
                    toTime = '23:45';
                    
                    // Update global state to reflect "Any Day" selection
                    if (window.MicFinderState && window.MicFinderFilters && window.MicFinderApp) {
                        const filters = window.MicFinderState.getActiveFilters();
                        filters.day = ''; // Empty string for "Any Day"
                        window.MicFinderState.setActiveFilters(filters);
                        window.MicFinderFilters.saveFilterState(filters);
                        window.MicFinderApp.render();
                        
                        // Sync modal state to reflect the change
                        setTimeout(() => {
                            syncModalFromGlobalState();
                        }, 0);
                    }
                    
                    // Close the modal if it's open
                    const modal = document.querySelector('#filter-modal');
                    if (modal && !modal.classList.contains('hidden')) {
                        closeModal();
                    }
                } else {
                    // Clear any "any" selection and add the specific day
                    filterState.dayOfWeek.clear();
                    filterState.dayOfWeek.add(selectedDay);
                    
                    // Update global state to reflect specific day selection
                    if (window.MicFinderState && window.MicFinderFilters && window.MicFinderApp) {
                        const filters = window.MicFinderState.getActiveFilters();
                        filters.day = selectedDay;
                        window.MicFinderState.setActiveFilters(filters);
                        window.MicFinderFilters.saveFilterState(filters);
                        window.MicFinderApp.render();
                        
                        // Sync modal state to reflect the change
                        setTimeout(() => {
                            syncModalFromGlobalState();
                        }, 0);
                    }
                    
                    const today = new Date();
                    const daysOfWeek = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
                    const todayName = daysOfWeek[today.getDay()];

                    if (selectedDay === todayName) {
                        // Today: current time (rounded to nearest 15 min) - 11:45 PM
                        let hours = today.getHours();
                        let minutes = today.getMinutes();
                        let snappedMinutes = Math.round(minutes / 15) * 15;
                        if (snappedMinutes === 60) {
                            snappedMinutes = 0;
                            hours = (hours + 1) % 24;
                        }
                        fromTime = `${hours.toString().padStart(2, '0')}:${snappedMinutes.toString().padStart(2, '0')}`;
                        toTime = '23:45';
                    } else {
                        // All other days: 10:00 AM - 11:45 PM
                        fromTime = '10:00';
                        toTime = '23:45';
                    }
                }

                updatePickerFromState('time-from-picker', fromTime);
                updatePickerFromState('time-to-picker', toTime);
                filterState.time.from = fromTime;
                filterState.time.to = toTime;

                // Do NOT update global filter state or results here (except for "Any Day")
                renderActivePills();
            });
        });
        const pillsRow = document.getElementById('active-pills-row');
        const pillsRowMobile = document.getElementById('active-pills-row-mobile');
        // Throttling for renderActivePills to prevent performance issues
        let lastRenderActivePillsTime = 0;
        let pendingRenderActivePills = null;
        
        const renderActivePills = () => {
            // Throttle to prevent excessive calls causing performance violations
            const now = Date.now();
            if (pendingRenderActivePills) {
                return; // Already scheduled
            }
            
            if (now - lastRenderActivePillsTime < 100) {
                // Schedule for later if called too frequently
                pendingRenderActivePills = setTimeout(() => {
                    pendingRenderActivePills = null;
                    renderActivePillsImmediate();
                }, 100);
                return;
            }
            
            renderActivePillsImmediate();
        };
        
        const renderActivePillsImmediate = () => {
            lastRenderActivePillsTime = Date.now();
            // Reduced logging to prevent spam
            if (Math.random() < 0.1) { // Only log 10% of the time
                console.log('🏷️ [PILLS] renderActivePills executed');
            }
            
            // Ensure "Any Day" pill exists in modal
            ensureAnyDayPillExists();
            
            // Desktop: only filter pills in scrollable, All Filters outside
            if (pillsRow) {
                pillsRow.innerHTML = '';
                let totalFilters = 0;
                const createPill = (value, category, displayValue = value) => {
                    const pill = document.createElement('button');
                    pill.className = 'pill active-pill-item bg-gray-900/80 backdrop-blur-sm text-white border-white/10 shadow-md';
                    if (category === 'time') pill.classList.add('time-pill');
                    if (category === 'dayOfWeek') {
                        pill.setAttribute('data-type', 'day');
                        pill.classList.add('day-filter-pill');
                    }
                    
                    // Different structure for different pill types
                    if (category === 'time') {
                        pill.innerHTML = `${displayValue} <i class="fa-solid fa-clock ml-2 text-gray-300" style="font-size: 0.75rem;"></i>`;
                        
                        // Function to handle time pill interaction
                        const handleTimePillSelection = (e) => {
                            e.stopPropagation();
                            e.preventDefault();
                            console.log('🕒 Time pill clicked - opening time picker');
                            openTimePicker();
                        };
                        
                        // Add click event for desktop and long-press for mobile
                        pill.addEventListener('click', handleTimePillSelection);
                        
                        // Long-press detection for mobile (prevents accidental activation during scrolling)
                        let longPressTimer = null;
                        let touchStartTime = 0;
                        let touchStartX = 0;
                        let touchStartY = 0;
                        
                        pill.addEventListener('touchstart', (e) => {
                            e.stopPropagation();
                            touchStartTime = Date.now();
                            touchStartX = e.touches[0].clientX;
                            touchStartY = e.touches[0].clientY;
                            
                            // Start long-press timer
                            longPressTimer = setTimeout(() => {
                                console.log('⏱️ [PILL] Long press detected on time pill - activating');
                                handleTimePillSelection(e);
                            }, 500); // 500ms long press
                        }, { passive: true });
                        
                        pill.addEventListener('touchend', (e) => {
                            // Clear long-press timer
                            if (longPressTimer) {
                                clearTimeout(longPressTimer);
                                longPressTimer = null;
                            }
                            
                            // Check if this was a quick tap (not a scroll)
                            const touchDuration = Date.now() - touchStartTime;
                            const touchEndX = e.changedTouches[0].clientX;
                            const touchEndY = e.changedTouches[0].clientY;
                            const distance = Math.sqrt(
                                Math.pow(touchEndX - touchStartX, 2) + 
                                Math.pow(touchEndY - touchStartY, 2)
                            );
                            
                            // Only activate on quick tap (short duration, small distance)
                            if (touchDuration < 300 && distance < 20) {
                                console.log('👆 [PILL] Quick tap detected on time pill - activating');
                                handleTimePillSelection(e);
                            }
                        }, { passive: true });
                        
                        pill.addEventListener('touchcancel', (e) => {
                            // Clear long-press timer on touch cancel
                            if (longPressTimer) {
                                clearTimeout(longPressTimer);
                                longPressTimer = null;
                            }
                        }, { passive: true });
                    } else if (category === 'dayOfWeek') {
                        // Create simple pill for day of week - opens popup when clicked
                        pill.innerHTML = `${displayValue} <i class="fa-solid fa-chevron-down"></i>`;
                        
                        // Click event for desktop
                        pill.addEventListener('click', (e) => {
                            e.stopPropagation();
                            e.preventDefault();
                            console.log('🗓️ [DESKTOP] Day pill clicked - opening popup!');
                            openDaySelectionPopup(value);
                        });
                        
                        // Long-press detection for mobile (prevents accidental activation during scrolling)
                        let longPressTimer = null;
                        let touchStartTime = 0;
                        let touchStartX = 0;
                        let touchStartY = 0;
                        
                        pill.addEventListener('touchstart', (e) => {
                            e.stopPropagation();
                            touchStartTime = Date.now();
                            touchStartX = e.touches[0].clientX;
                            touchStartY = e.touches[0].clientY;
                            
                            // Start long-press timer
                            longPressTimer = setTimeout(() => {
                                console.log('⏱️ [PILL] Long press detected on day pill - opening popup');
                                openDaySelectionPopup(value);
                            }, 500); // 500ms long press
                        }, { passive: true });
                        
                        pill.addEventListener('touchend', (e) => {
                            // Clear long-press timer
                            if (longPressTimer) {
                                clearTimeout(longPressTimer);
                                longPressTimer = null;
                            }
                            
                            // Check if this was a quick tap (not a scroll)
                            const touchDuration = Date.now() - touchStartTime;
                            const touchEndX = e.changedTouches[0].clientX;
                            const touchEndY = e.changedTouches[0].clientY;
                            const distance = Math.sqrt(
                                Math.pow(touchEndX - touchStartX, 2) + 
                                Math.pow(touchEndY - touchStartY, 2)
                            );
                            
                            // Only activate on quick tap (short duration, small distance)
                            if (touchDuration < 300 && distance < 20) {
                                console.log('👆 [PILL] Quick tap detected on day pill - opening popup');
                                openDaySelectionPopup(value);
                            }
                        }, { passive: true });
                        
                        pill.addEventListener('touchcancel', (e) => {
                            // Clear long-press timer on touch cancel
                            if (longPressTimer) {
                                clearTimeout(longPressTimer);
                                longPressTimer = null;
                            }
                        }, { passive: true });
                    } else if (category === 'locations') {
                        // Create simple pill for borough - opens popup when clicked
                        pill.setAttribute('data-type', 'location');
                        pill.classList.add('location-filter-pill');
                        pill.innerHTML = `${displayValue} <i class="fa-solid fa-chevron-down"></i>`;
                        
                        // Click event for desktop
                        pill.addEventListener('click', (e) => {
                            e.stopPropagation();
                            e.preventDefault();
                            console.log('🏢 [DESKTOP] Borough pill clicked - opening popup!');
                            openBoroughSelectionPopup(value);
                        });
                        
                        // Long-press detection for mobile (prevents accidental activation during scrolling)
                        let longPressTimer = null;
                        let touchStartTime = 0;
                        let touchStartX = 0;
                        let touchStartY = 0;
                        
                        pill.addEventListener('touchstart', (e) => {
                            e.stopPropagation();
                            touchStartTime = Date.now();
                            touchStartX = e.touches[0].clientX;
                            touchStartY = e.touches[0].clientY;
                            
                            // Start long-press timer
                            longPressTimer = setTimeout(() => {
                                console.log('⏱️ [PILL] Long press detected on borough pill - opening popup');
                                openBoroughSelectionPopup(value);
                            }, 500); // 500ms long press
                        }, { passive: true });
                        
                        pill.addEventListener('touchend', (e) => {
                            // Clear long-press timer
                            if (longPressTimer) {
                                clearTimeout(longPressTimer);
                                longPressTimer = null;
                            }
                            
                            // Check if this was a quick tap (not a scroll)
                            const touchDuration = Date.now() - touchStartTime;
                            const touchEndX = e.changedTouches[0].clientX;
                            const touchEndY = e.changedTouches[0].clientY;
                            const distance = Math.sqrt(
                                Math.pow(touchEndX - touchStartX, 2) + 
                                Math.pow(touchEndY - touchStartY, 2)
                            );
                            
                            // Only activate on quick tap (short duration, small distance)
                            if (touchDuration < 300 && distance < 20) {
                                console.log('👆 [PILL] Quick tap detected on borough pill - opening popup');
                                openBoroughSelectionPopup(value);
                            }
                        }, { passive: true });
                        
                        pill.addEventListener('touchcancel', (e) => {
                            // Clear long-press timer on touch cancel
                            if (longPressTimer) {
                                clearTimeout(longPressTimer);
                                longPressTimer = null;
                            }
                        }, { passive: true });
                    } else if (category === 'neighborhoods') {
                        // Create simple pill for neighborhood - opens popup when clicked
                        pill.setAttribute('data-type', 'neighborhood');
                        pill.classList.add('neighborhood-filter-pill');
                        pill.innerHTML = `${displayValue} <i class="fa-solid fa-chevron-down"></i>`;
                        
                        // Click event for desktop
                        pill.addEventListener('click', (e) => {
                            e.stopPropagation();
                            e.preventDefault();
                            console.log('🏘️ [DESKTOP] Neighborhood pill clicked - opening popup!');
                            openNeighborhoodSelectionPopup(value);
                        });
                        
                        // Long-press detection for mobile (prevents accidental activation during scrolling)
                        let longPressTimer = null;
                        let touchStartTime = 0;
                        let touchStartX = 0;
                        let touchStartY = 0;
                        
                        pill.addEventListener('touchstart', (e) => {
                            e.stopPropagation();
                            touchStartTime = Date.now();
                            touchStartX = e.touches[0].clientX;
                            touchStartY = e.touches[0].clientY;
                            
                            // Start long-press timer
                            longPressTimer = setTimeout(() => {
                                console.log('⏱️ [PILL] Long press detected on neighborhood pill - opening popup');
                                openNeighborhoodSelectionPopup(value);
                            }, 500); // 500ms long press
                        }, { passive: true });
                        
                        pill.addEventListener('touchend', (e) => {
                            // Clear long-press timer
                            if (longPressTimer) {
                                clearTimeout(longPressTimer);
                                longPressTimer = null;
                            }
                            
                            // Check if this was a quick tap (not a scroll)
                            const touchDuration = Date.now() - touchStartTime;
                            const touchEndX = e.changedTouches[0].clientX;
                            const touchEndY = e.changedTouches[0].clientY;
                            const distance = Math.sqrt(
                                Math.pow(touchEndX - touchStartX, 2) + 
                                Math.pow(touchEndY - touchStartY, 2)
                            );
                            
                            // Only activate on quick tap (short duration, small distance)
                            if (touchDuration < 300 && distance < 20) {
                                console.log('👆 [PILL] Quick tap detected on neighborhood pill - opening popup');
                                openNeighborhoodSelectionPopup(value);
                            }
                        }, { passive: true });
                        
                        pill.addEventListener('touchcancel', (e) => {
                            // Clear long-press timer on touch cancel
                            if (longPressTimer) {
                                clearTimeout(longPressTimer);
                                longPressTimer = null;
                            }
                        }, { passive: true });
                    } else if (category === 'details') {
                        // Create simple pill for details - opens popup when clicked
                        pill.setAttribute('data-type', 'details');
                        pill.classList.add('details-filter-pill');
                        pill.innerHTML = `${displayValue} <i class="fa-solid fa-chevron-down"></i>`;
                        
                        // Click event for desktop
                        pill.addEventListener('click', (e) => {
                            e.stopPropagation();
                            e.preventDefault();
                            console.log('📝 [DESKTOP] Details pill clicked - opening popup!');
                            openDetailsSelectionPopup(value);
                        });
                        
                        // Long-press detection for mobile (prevents accidental activation during scrolling)
                        let longPressTimer = null;
                        let touchStartTime = 0;
                        let touchStartX = 0;
                        let touchStartY = 0;
                        
                        pill.addEventListener('touchstart', (e) => {
                            e.stopPropagation();
                            touchStartTime = Date.now();
                            touchStartX = e.touches[0].clientX;
                            touchStartY = e.touches[0].clientY;
                            
                            // Start long-press timer
                            longPressTimer = setTimeout(() => {
                                console.log('⏱️ [PILL] Long press detected on details pill - opening popup');
                                openDetailsSelectionPopup(value);
                            }, 500); // 500ms long press
                        }, { passive: true });
                        
                        pill.addEventListener('touchend', (e) => {
                            // Clear long-press timer
                            if (longPressTimer) {
                                clearTimeout(longPressTimer);
                                longPressTimer = null;
                            }
                            
                            // Check if this was a quick tap (not a scroll)
                            const touchDuration = Date.now() - touchStartTime;
                            const touchEndX = e.changedTouches[0].clientX;
                            const touchEndY = e.changedTouches[0].clientY;
                            const distance = Math.sqrt(
                                Math.pow(touchEndX - touchStartX, 2) + 
                                Math.pow(touchEndY - touchStartY, 2)
                            );
                            
                            // Only activate on quick tap (short duration, small distance)
                            if (touchDuration < 300 && distance < 20) {
                                console.log('👆 [PILL] Quick tap detected on details pill - opening popup');
                                openDetailsSelectionPopup(value);
                            }
                        }, { passive: true });
                        
                        pill.addEventListener('touchcancel', (e) => {
                            // Clear long-press timer on touch cancel
                            if (longPressTimer) {
                                clearTimeout(longPressTimer);
                                longPressTimer = null;
                            }
                        }, { passive: true });
                    } else {
                        pill.innerHTML = `${displayValue} <span class="ml-2 font-mono text-gray-300 hover:text-white">×</span>`;
                        pill.addEventListener('click', () => removeFilter(category, value));
                    }
                    
                    pillsRow.appendChild(pill);
                    totalFilters++;
                };
                const globalFilters = window.MicFinderState ? window.MicFinderState.getActiveFilters() : filterState;
                console.log('🏷️ [PILLS] Current globalFilters:', globalFilters);
                // Handle day filters - show "Any Day" for empty/undefined/null, specific days otherwise
                if (globalFilters.day !== undefined && globalFilters.day !== null && globalFilters.day !== '') {
                    if (Array.isArray(globalFilters.day)) {
                        globalFilters.day.forEach(day => createPill(day, 'dayOfWeek'));
                    } else if (typeof globalFilters.day === 'string') {
                        createPill(globalFilters.day, 'dayOfWeek');
                    }
                } else {
                    // No day selected or empty string - show "Any Day" pill
                    createPill('Any Day', 'dayOfWeek');
                }
                if (globalFilters.customTimeStart && globalFilters.customTimeEnd) {
                    // Show the pill if it was set via modal, OR if it's not the default range
                    const isDefaultTimeRange = globalFilters.customTimeStart === '10:00 AM' && globalFilters.customTimeEnd === '11:45 PM';
                    const shouldShowPill = globalFilters.timeSetViaModal || !isDefaultTimeRange;
                    console.log('🕐 [PILL] Time pill logic:', {
                        customTimeStart: globalFilters.customTimeStart,
                        customTimeEnd: globalFilters.customTimeEnd,
                        timeSetViaModal: globalFilters.timeSetViaModal,
                        isDefaultTimeRange: isDefaultTimeRange,
                        shouldShowPill: shouldShowPill
                    });
                    if (shouldShowPill) {
                        console.log('🕐 [PILL] Creating time pill:', `${globalFilters.customTimeStart} - ${globalFilters.customTimeEnd}`);
                        createPill('time-range', 'time', `${globalFilters.customTimeStart} - ${globalFilters.customTimeEnd}`);
                    } else {
                        console.log('🕐 [PILL] NOT creating time pill (default range and not set via modal)');
                    }
                }
                if (globalFilters.borough && Array.isArray(globalFilters.borough)) {
                    globalFilters.borough.forEach(loc => createPill(loc, 'locations'));
                }
                if (globalFilters.neighborhood && Array.isArray(globalFilters.neighborhood)) {
                    globalFilters.neighborhood.forEach(hood => createPill(hood, 'neighborhoods'));
                }
                if (globalFilters.cost && Array.isArray(globalFilters.cost)) {
                    globalFilters.cost.forEach(det => createPill(det, 'details'));
                }
                if (globalFilters.signup && Array.isArray(globalFilters.signup)) {
                    globalFilters.signup.forEach(det => createPill(det, 'details'));
                }
                if (globalFilters.showFavorites) {
                    createPill('Show Favorites Only', 'favorites');
                }
                const allFiltersText = document.getElementById('all-filters-text');
                if (allFiltersText) {
                    allFiltersText.textContent = totalFilters > 0 ? `All Filters (${totalFilters})` : 'All Filters';
                }
            }
            // Mobile: All Filters and filter pills in same row
            if (pillsRowMobile) {
                console.log('[MOBILE PILLS] Rendering mobile pills...');
                pillsRowMobile.innerHTML = '';
                // Create All Filters button first (positioned absolutely)
                const allFiltersBtn = document.createElement('button');
                allFiltersBtn.id = 'modal-button-mobile';
                allFiltersBtn.className = 'bg-gray-100 text-gray-800 border border-gray-400 shadow-md hover:bg-gray-200 hover:border-gray-500 flex-shrink-0 mr-2 text-sm font-medium py-2.5 px-5 rounded-xl transition-colors flex items-center gap-2';
                allFiltersBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M11.5 2a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3M9.05 3a2.5 2.5 0 0 1 4.9 0H16v1h-2.05a2.5 2.5 0 0 1-4.9 0H0V3zM4.5 7a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3M2.05 8a2.5 2.5 0 0 1 4.9 0H16v1H6.95a2.5 2.5 0 0 1-4.9 0H0V8zm9.45 4a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3m-2.45 1a2.5 2.5 0 0 1 4.9 0H16v1h-2.05a2.5 2.5 0 0 1-4.9 0H0v-1z"/>
                    </svg>
                    <span id="all-filters-text-mobile">All Filters</span>
                `;
                allFiltersBtn.addEventListener('click', openModal);
                pillsRowMobile.appendChild(allFiltersBtn);
                console.log('[MOBILE PILLS] All Filters button added');
                
                // Then render filter pills (these will scroll)
                const scrollPills = pillsRowMobile;
                let totalFilters = 0;
                const createPill = (value, category, displayValue = value) => {
                    const pill = document.createElement('button');
                    pill.className = 'pill active-pill-item bg-gray-900/80 backdrop-blur-sm text-white border-white/10 shadow-md hover:bg-black/70';
                    if (category === 'time') pill.classList.add('time-pill');
                    if (category === 'dayOfWeek') {
                        pill.setAttribute('data-type', 'day');
                        pill.classList.add('day-filter-pill');
                    }
                    
                    if (category === 'time') {
                        pill.innerHTML = `${displayValue} <span class="ml-2 text-gray-300 hover:text-white">🕒</span>`;
                        
                        // Function to handle mobile time pill interaction
                        const handleMobileTimePillSelection = (e) => {
                            e.stopPropagation();
                            e.preventDefault();
                            console.log('🕒 Mobile time pill clicked - opening time picker');
                            openTimePicker();
                        };
                        
                        // Add click event for desktop and long-press for mobile
                        pill.addEventListener('click', handleMobileTimePillSelection);
                        
                        // Long-press detection for mobile (prevents accidental activation during scrolling)
                        let longPressTimer = null;
                        let touchStartTime = 0;
                        let touchStartX = 0;
                        let touchStartY = 0;
                        
                        pill.addEventListener('touchstart', (e) => {
                            e.stopPropagation();
                            touchStartTime = Date.now();
                            touchStartX = e.touches[0].clientX;
                            touchStartY = e.touches[0].clientY;
                            
                            // Start long-press timer
                            longPressTimer = setTimeout(() => {
                                console.log('⏱️ [PILL] Long press detected on mobile time pill - activating');
                                handleMobileTimePillSelection(e);
                            }, 500); // 500ms long press
                        }, { passive: true });
                        
                        pill.addEventListener('touchend', (e) => {
                            // Clear long-press timer
                            if (longPressTimer) {
                                clearTimeout(longPressTimer);
                                longPressTimer = null;
                            }
                            
                            // Check if this was a quick tap (not a scroll)
                            const touchDuration = Date.now() - touchStartTime;
                            const touchEndX = e.changedTouches[0].clientX;
                            const touchEndY = e.changedTouches[0].clientY;
                            const distance = Math.sqrt(
                                Math.pow(touchEndX - touchStartX, 2) + 
                                Math.pow(touchEndY - touchStartY, 2)
                            );
                            
                            // Only activate on quick tap (short duration, small distance)
                            if (touchDuration < 300 && distance < 20) {
                                console.log('👆 [PILL] Quick tap detected on mobile time pill - activating');
                                handleMobileTimePillSelection(e);
                            }
                        }, { passive: true });
                        
                        pill.addEventListener('touchcancel', (e) => {
                            // Clear long-press timer on touch cancel
                            if (longPressTimer) {
                                clearTimeout(longPressTimer);
                                longPressTimer = null;
                            }
                        }, { passive: true });
                    } else if (category === 'dayOfWeek') {
                        // Create simple pill for day of week - opens popup when clicked
                        pill.innerHTML = `${displayValue} <i class="fa-solid fa-chevron-down"></i>`;
                        
                        // Click event for desktop
                        pill.addEventListener('click', (e) => {
                            e.stopPropagation();
                            e.preventDefault();
                            console.log('🗓️ [MOBILE] Day pill clicked - opening popup!');
                            openDaySelectionPopup(value);
                        });
                        
                        // Long-press detection for mobile (prevents accidental activation during scrolling)
                        let longPressTimer = null;
                        let touchStartTime = 0;
                        let touchStartX = 0;
                        let touchStartY = 0;
                        
                        pill.addEventListener('touchstart', (e) => {
                            e.stopPropagation();
                            touchStartTime = Date.now();
                            touchStartX = e.touches[0].clientX;
                            touchStartY = e.touches[0].clientY;
                            
                            // Start long-press timer
                            longPressTimer = setTimeout(() => {
                                console.log('⏱️ [PILL] Long press detected on mobile day pill - opening popup');
                                openDaySelectionPopup(value);
                            }, 500); // 500ms long press
                        }, { passive: true });
                        
                        pill.addEventListener('touchend', (e) => {
                            // Clear long-press timer
                            if (longPressTimer) {
                                clearTimeout(longPressTimer);
                                longPressTimer = null;
                            }
                            
                            // Check if this was a quick tap (not a scroll)
                            const touchDuration = Date.now() - touchStartTime;
                            const touchEndX = e.changedTouches[0].clientX;
                            const touchEndY = e.changedTouches[0].clientY;
                            const distance = Math.sqrt(
                                Math.pow(touchEndX - touchStartX, 2) + 
                                Math.pow(touchEndY - touchStartY, 2)
                            );
                            
                            // Only activate on quick tap (short duration, small distance)
                            if (touchDuration < 300 && distance < 20) {
                                console.log('👆 [PILL] Quick tap detected on mobile day pill - opening popup');
                                openDaySelectionPopup(value);
                            }
                        }, { passive: true });
                        
                        pill.addEventListener('touchcancel', (e) => {
                            // Clear long-press timer on touch cancel
                            if (longPressTimer) {
                                clearTimeout(longPressTimer);
                                longPressTimer = null;
                            }
                        }, { passive: true });
                    } else if (category === 'locations') {
                        // Create simple pill for borough - opens popup when clicked
                        pill.setAttribute('data-type', 'location');
                        pill.classList.add('location-filter-pill');
                        pill.innerHTML = `${displayValue} <i class="fa-solid fa-chevron-down"></i>`;
                        
                        // Click event for desktop
                        pill.addEventListener('click', (e) => {
                            e.stopPropagation();
                            e.preventDefault();
                            console.log('🏢 [MOBILE] Borough pill clicked - opening popup!');
                            openBoroughSelectionPopup(value);
                        });
                        
                        // Long-press detection for mobile (prevents accidental activation during scrolling)
                        let longPressTimer = null;
                        let touchStartTime = 0;
                        let touchStartX = 0;
                        let touchStartY = 0;
                        
                        pill.addEventListener('touchstart', (e) => {
                            e.stopPropagation();
                            touchStartTime = Date.now();
                            touchStartX = e.touches[0].clientX;
                            touchStartY = e.touches[0].clientY;
                            
                            // Start long-press timer
                            longPressTimer = setTimeout(() => {
                                console.log('⏱️ [PILL] Long press detected on mobile borough pill - opening popup');
                                openBoroughSelectionPopup(value);
                            }, 500); // 500ms long press
                        }, { passive: true });
                        
                        pill.addEventListener('touchend', (e) => {
                            // Clear long-press timer
                            if (longPressTimer) {
                                clearTimeout(longPressTimer);
                                longPressTimer = null;
                            }
                            
                            // Check if this was a quick tap (not a scroll)
                            const touchDuration = Date.now() - touchStartTime;
                            const touchEndX = e.changedTouches[0].clientX;
                            const touchEndY = e.changedTouches[0].clientY;
                            const distance = Math.sqrt(
                                Math.pow(touchEndX - touchStartX, 2) + 
                                Math.pow(touchEndY - touchStartY, 2)
                            );
                            
                            // Only activate on quick tap (short duration, small distance)
                            if (touchDuration < 300 && distance < 20) {
                                console.log('👆 [PILL] Quick tap detected on mobile borough pill - opening popup');
                                openBoroughSelectionPopup(value);
                            }
                        }, { passive: true });
                        
                        pill.addEventListener('touchcancel', (e) => {
                            // Clear long-press timer on touch cancel
                            if (longPressTimer) {
                                clearTimeout(longPressTimer);
                                longPressTimer = null;
                            }
                        }, { passive: true });
                    } else if (category === 'details') {
                        // Create simple pill for details - opens popup when clicked
                        pill.setAttribute('data-type', 'details');
                        pill.classList.add('details-filter-pill');
                        pill.innerHTML = `${displayValue} <i class="fa-solid fa-chevron-down"></i>`;
                        
                        // Click event for desktop
                        pill.addEventListener('click', (e) => {
                            e.stopPropagation();
                            e.preventDefault();
                            console.log('📝 [MOBILE] Details pill clicked - opening popup!');
                            openDetailsSelectionPopup(value);
                        });
                        
                        // Long-press detection for mobile (prevents accidental activation during scrolling)
                        let longPressTimer = null;
                        let touchStartTime = 0;
                        let touchStartX = 0;
                        let touchStartY = 0;
                        
                        pill.addEventListener('touchstart', (e) => {
                            e.stopPropagation();
                            touchStartTime = Date.now();
                            touchStartX = e.touches[0].clientX;
                            touchStartY = e.touches[0].clientY;
                            
                            // Start long-press timer
                            longPressTimer = setTimeout(() => {
                                console.log('⏱️ [PILL] Long press detected on mobile details pill - opening popup');
                                openDetailsSelectionPopup(value);
                            }, 500); // 500ms long press
                        }, { passive: true });
                        
                        pill.addEventListener('touchend', (e) => {
                            // Clear long-press timer
                            if (longPressTimer) {
                                clearTimeout(longPressTimer);
                                longPressTimer = null;
                            }
                            
                            // Check if this was a quick tap (not a scroll)
                            const touchDuration = Date.now() - touchStartTime;
                            const touchEndX = e.changedTouches[0].clientX;
                            const touchEndY = e.changedTouches[0].clientY;
                            const distance = Math.sqrt(
                                Math.pow(touchEndX - touchStartX, 2) + 
                                Math.pow(touchEndY - touchStartY, 2)
                            );
                            
                            // Only activate on quick tap (short duration, small distance)
                            if (touchDuration < 300 && distance < 20) {
                                console.log('👆 [PILL] Quick tap detected on mobile details pill - opening popup');
                                openDetailsSelectionPopup(value);
                            }
                        }, { passive: true });
                        
                        pill.addEventListener('touchcancel', (e) => {
                            // Clear long-press timer on touch cancel
                            if (longPressTimer) {
                                clearTimeout(longPressTimer);
                                longPressTimer = null;
                            }
                        }, { passive: true });
                    } else {
                        pill.innerHTML = `${displayValue} <span class="ml-2 font-mono text-gray-300 hover:text-white">×</span>`;
                        pill.addEventListener('click', () => removeFilter(category, value));
                    }
                    
                    scrollPills.appendChild(pill);
                    totalFilters++;
                    console.log('[MOBILE PILLS] Created pill:', displayValue, 'Category:', category);
                };
                const globalFilters = window.MicFinderState ? window.MicFinderState.getActiveFilters() : filterState;
                console.log('🏷️ [PILLS] Current globalFilters:', globalFilters);
                console.log('[MOBILE PILLS] Global filters:', globalFilters);
                
                // Handle day filters - show "Any Day" for empty/undefined/null, specific days otherwise
                if (globalFilters.day !== undefined && globalFilters.day !== null && globalFilters.day !== '') {
                    if (Array.isArray(globalFilters.day)) {
                        globalFilters.day.forEach(day => createPill(day, 'dayOfWeek'));
                    } else if (typeof globalFilters.day === 'string') {
                        createPill(globalFilters.day, 'dayOfWeek');
                    }
                } else {
                    // No day selected or empty string - show "Any Day" pill
                    createPill('Any Day', 'dayOfWeek');
                }
                if (globalFilters.customTimeStart && globalFilters.customTimeEnd) {
                    // Show the pill if it was set via modal, OR if it's not the default range
                    const isDefaultTimeRange = globalFilters.customTimeStart === '10:00 AM' && globalFilters.customTimeEnd === '11:45 PM';
                    const shouldShowPill = globalFilters.timeSetViaModal || !isDefaultTimeRange;
                    console.log('🕐 [PILL] Time pill logic:', {
                        customTimeStart: globalFilters.customTimeStart,
                        customTimeEnd: globalFilters.customTimeEnd,
                        timeSetViaModal: globalFilters.timeSetViaModal,
                        isDefaultTimeRange: isDefaultTimeRange,
                        shouldShowPill: shouldShowPill
                    });
                    if (shouldShowPill) {
                        console.log('🕐 [PILL] Creating time pill:', `${globalFilters.customTimeStart} - ${globalFilters.customTimeEnd}`);
                        createPill('time-range', 'time', `${globalFilters.customTimeStart} - ${globalFilters.customTimeEnd}`);
                    } else {
                        console.log('🕐 [PILL] NOT creating time pill (default range and not set via modal)');
                    }
                }
                if (globalFilters.borough && Array.isArray(globalFilters.borough)) {
                    globalFilters.borough.forEach(loc => createPill(loc, 'locations'));
                }
                if (globalFilters.cost && Array.isArray(globalFilters.cost)) {
                    globalFilters.cost.forEach(det => createPill(det, 'details'));
                }
                if (globalFilters.signup && Array.isArray(globalFilters.signup)) {
                    globalFilters.signup.forEach(det => createPill(det, 'details'));
                }
                if (globalFilters.showFavorites) {
                    createPill('Show Favorites Only', 'favorites');
                }
                
                const allFiltersTextMobile = document.getElementById('all-filters-text-mobile');
                if (allFiltersTextMobile) {
                    allFiltersTextMobile.textContent = totalFilters > 0 ? `All Filters (${totalFilters})` : 'All Filters';
                }
                
                // Update the button text as well
                const modalBtn = pillsRowMobile.querySelector('#modal-button-mobile');
                if (modalBtn) {
                    const btnText = modalBtn.querySelector('#all-filters-text-mobile');
                    if (btnText) {
                        btnText.textContent = totalFilters > 0 ? `All Filters (${totalFilters})` : 'All Filters';
                    }
                }
                
                // Test the layout after rendering
                setTimeout(() => {
                    console.log('[MOBILE PILLS] === LAYOUT TEST ===');
                    console.log('[MOBILE PILLS] Container exists:', !!pillsRowMobile);
                    console.log('[MOBILE PILLS] Container display:', getComputedStyle(pillsRowMobile).display);
                    console.log('[MOBILE PILLS] Container visibility:', getComputedStyle(pillsRowMobile).visibility);
                    console.log('[MOBILE PILLS] Container opacity:', getComputedStyle(pillsRowMobile).opacity);
                    console.log('[MOBILE PILLS] Container dimensions:', {
                        width: pillsRowMobile.offsetWidth,
                        height: pillsRowMobile.offsetHeight,
                        scrollWidth: pillsRowMobile.scrollWidth,
                        clientWidth: pillsRowMobile.clientWidth
                    });
                    
                    // Check parent container
                    const parentContainer = pillsRowMobile.closest('.mobile-pills-row');
                    if (parentContainer) {
                        console.log('[MOBILE PILLS] Parent container display:', getComputedStyle(parentContainer).display);
                        console.log('[MOBILE PILLS] Parent container visibility:', getComputedStyle(parentContainer).visibility);
                        console.log('[MOBILE PILLS] Parent container dimensions:', {
                            width: parentContainer.offsetWidth,
                            height: parentContainer.offsetHeight
                        });
                    }
                    
                    // Check if we're on mobile/tablet view
                    console.log('[MOBILE PILLS] Window width:', window.innerWidth);
                    console.log('[MOBILE PILLS] lg:hidden should be active:', window.innerWidth < 1024);
                    const testAllFiltersBtn = pillsRowMobile.querySelector('#modal-button-mobile');
                    
                    if (testAllFiltersBtn) {
                        const btnRect = testAllFiltersBtn.getBoundingClientRect();
                        console.log('[MOBILE PILLS] All Filters button position:', {
                            left: btnRect.left,
                            right: btnRect.right,
                            width: btnRect.width
                        });
                    }
                    
                    const pills = pillsRowMobile.querySelectorAll('.pill');
                    console.log('[MOBILE PILLS] Pills container position:', {
                        left: pillsRowMobile.getBoundingClientRect().left,
                        right: pillsRowMobile.getBoundingClientRect().right,
                        width: pillsRowMobile.getBoundingClientRect().width,
                        scrollWidth: pillsRowMobile.scrollWidth,
                        clientWidth: pillsRowMobile.clientWidth,
                        canScroll: pillsRowMobile.scrollWidth > pillsRowMobile.clientWidth
                    });
                    
                    if (pills.length > 0) {
                        const firstPill = pills[0];
                        const firstPillRect = firstPill.getBoundingClientRect();
                        console.log('[MOBILE PILLS] First pill position:', {
                            left: firstPillRect.left,
                            right: firstPillRect.right,
                            width: firstPillRect.width
                        });
                        
                        // Check if first pill can overlap with All Filters button
                        if (testAllFiltersBtn) {
                            const btnRect = testAllFiltersBtn.getBoundingClientRect();
                            const canOverlap = firstPillRect.left < btnRect.right;
                            console.log('[MOBILE PILLS] Can first pill overlap with All Filters button?', canOverlap);
                            
                            if (canOverlap) {
                                console.warn('[MOBILE PILLS] ⚠️ WARNING: First pill can still overlap with All Filters button!');
                            } else {
                                console.log('[MOBILE PILLS] ✅ SUCCESS: First pill cannot overlap with All Filters button');
                            }
                        }
                    }
                }, 100);
            }
        };
        const syncStateFromModal = () => {
            filterState.dayOfWeek.clear();
            document.querySelectorAll('#dayOfWeek-filters .day-pill.active').forEach(p => filterState.dayOfWeek.add(p.dataset.day));
            filterState.time.from = readPickerState('time-from-picker');
            filterState.time.to = readPickerState('time-to-picker');
            // Robustly sync checkboxes for each filter category
            // Locations (boroughs)
            filterState.locations.clear();
            document.querySelectorAll('#location-filters input[type="checkbox"]:checked').forEach(i => filterState.locations.add(i.value));
            // Details
            filterState.details.clear();
            document.querySelectorAll('#details-filters input[type="checkbox"]:checked').forEach(i => filterState.details.add(i.value));
            // Favorites
            filterState.favorites.clear();
            document.querySelectorAll('#favorites-filter input[type="checkbox"]:checked').forEach(i => filterState.favorites.add(i.value));
            // DEBUG: Log locations after syncing from modal
            console.log('[DEBUG] filterState.locations after sync:', Array.from(filterState.locations));
        };
        const syncModalFromState = () => {
            // Handle day pills - "Any Day" is active when no specific day is selected
            document.querySelectorAll('#dayOfWeek-filters .day-pill').forEach(p => {
                if (p.dataset.day === 'any') {
                    // "Any Day" is active when no specific day is selected
                    p.classList.toggle('active', filterState.dayOfWeek.size === 0);
                } else {
                    // Specific days are active when they're in the filterState
                    p.classList.toggle('active', filterState.dayOfWeek.has(p.dataset.day));
                }
            });
            
            updatePickerFromState('time-from-picker', filterState.time.from);
            updatePickerFromState('time-to-picker', filterState.time.to);
            ['locations', 'details', 'favorites'].forEach(cat => {
                const container = cat === 'favorites' ? 'favorites-filter' : `${cat}-filters`;
                document.querySelectorAll(`#${container} input[type="checkbox"]`).forEach(input => {
                    input.checked = filterState[cat]?.has(input.value) || false;
                });
            });
        };
        const removeFilter = (category, value) => {
            // Get current global filters
            const globalFilters = window.MicFinderState.getActiveFilters();

            if (category === 'time') {
                console.log('🕐 [FILTER] Removing time pill - resetting to default 10:00 AM - 11:45 PM');
                globalFilters.customTimeStart = '10:00 AM';
                globalFilters.customTimeEnd = '11:45 PM';
                globalFilters.timeSetViaModal = false; // Clear modal flag when X'ing out
                
                // Update the sidebar time selectors to reflect the new default range
                if (window.MicFinderSidebar && window.MicFinderSidebar.setCustomTimeRange) {
                    window.MicFinderSidebar.setCustomTimeRange(
                        { hour: '10', minute: '00', ampm: 'AM' },
                        { hour: '11', minute: '45', ampm: 'PM' }
                    );
                }
            } else if (category === 'dayOfWeek') {
                if (Array.isArray(globalFilters.day)) {
                    globalFilters.day = globalFilters.day.filter(day => day !== value);
                } else if (globalFilters.day === value) {
                    globalFilters.day = '';
                }
                // If removing a day filter and no days remain, this effectively selects "Any Day"
            } else if (category === 'locations') {
                if (Array.isArray(globalFilters.borough)) {
                    globalFilters.borough = globalFilters.borough.filter(b => b !== value);
                }
            } else if (category === 'neighborhoods') {
                if (Array.isArray(globalFilters.neighborhood)) {
                    globalFilters.neighborhood = globalFilters.neighborhood.filter(n => n !== value);
                }
            } else if (category === 'details') {
                if (Array.isArray(globalFilters.cost)) {
                    globalFilters.cost = globalFilters.cost.filter(c => c !== value && c !== '1 drink min');
                }
                if (Array.isArray(globalFilters.signup)) {
                    globalFilters.signup = globalFilters.signup.filter(s => s !== value);
                }
            } else if (category === 'favorites') {
                globalFilters.showFavorites = false;
            }

            // Update global state and UI
            window.MicFinderState.setActiveFilters(globalFilters);
            window.MicFinderFilters.saveFilterState(globalFilters);
            window.MicFinderApp.render();
            renderActivePills();
            // Force search bar dropdown to update with new filters
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.dispatchEvent(new Event('input', { bubbles: true }));
            }
        };
        const setDefaultTime = () => {
             const now = new Date();
             let hours = now.getHours();
             let minutes = now.getMinutes();
             let snappedMinutes = Math.round(minutes / 15) * 15;
             if (snappedMinutes === 60) {
                 snappedMinutes = 0;
                 hours = (hours + 1) % 24;
             }
             filterState.time.from = `${hours.toString().padStart(2, '0')}:${snappedMinutes.toString().padStart(2, '0')}`;
             filterState.time.to = '23:45';
        };
        // Function to ensure "Any Day" pill exists in the modal
        const ensureAnyDayPillExists = () => {
            const dayFiltersSection = document.querySelector('#dayOfWeek-filters');
            if (!dayFiltersSection) return;
            
            // Check if "Any Day" pill already exists
            const existingAnyDayPill = dayFiltersSection.querySelector('.day-pill[data-day="any"]');
            if (!existingAnyDayPill) {
                // Create "Any Day" pill if it doesn't exist
                const anyDayPill = document.createElement('button');
                anyDayPill.className = 'day-pill';
                anyDayPill.setAttribute('data-day', 'any');
                anyDayPill.textContent = 'Any Day';
                
                // Add click handler
                anyDayPill.addEventListener('click', function() {
                    // Only allow one active day at a time
                    document.querySelectorAll('.day-pill').forEach(p => p.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Clear day filter and set default time range
                    filterState.dayOfWeek.clear();
                    const fromTime = '10:00';
                    const toTime = '23:45';
                    
                    updatePickerFromState('time-from-picker', fromTime);
                    updatePickerFromState('time-to-picker', toTime);
                    filterState.time.from = fromTime;
                    filterState.time.to = toTime;
                    
                    // Update global state to reflect "Any Day" selection
                    if (window.MicFinderState && window.MicFinderFilters && window.MicFinderApp) {
                        const filters = window.MicFinderState.getActiveFilters();
                        filters.day = ''; // Empty string for "Any Day"
                        window.MicFinderState.setActiveFilters(filters);
                        window.MicFinderFilters.saveFilterState(filters);
                        window.MicFinderApp.render();
                        
                        // Sync modal state to reflect the change
                        setTimeout(() => {
                            syncModalFromGlobalState();
                        }, 0);
                    }
                    
                    // Close the modal if it's open
                    const modal = document.querySelector('#filter-modal');
                    if (modal && !modal.classList.contains('hidden')) {
                        closeModal();
                    }
                    
                    renderActivePills();
                });
                
                // Insert at the beginning of the day filters section
                dayFiltersSection.insertBefore(anyDayPill, dayFiltersSection.firstChild);
            }
            
            // Always ensure the pill state is correct
            if (existingAnyDayPill) {
                // Update the existing pill's state based on current filter state
                const globalFilters = window.MicFinderState ? window.MicFinderState.getActiveFilters() : {};
                const shouldBeActive = !globalFilters.day || globalFilters.day === '';
                existingAnyDayPill.classList.toggle('active', shouldBeActive);
            }
        };

        const openModal = () => {
            // Sync from global state first
            syncModalFromGlobalState();
            
            // Set default time if no time is set
            if (!filterState.time.from && !filterState.time.to) setDefaultTime();
            
            // Ensure "Any Day" pill exists
            ensureAnyDayPillExists();
            
            // Update modal UI
            syncModalFromState();
            renderActivePills();
            
            // Show modal
            filterModal.classList.remove('hidden');
            filterModal.classList.add('flex');
        };
        const closeModal = () => {
            filterModal.classList.add('hidden');
            filterModal.classList.remove('flex');
            closeAllDropdowns();
        };
        const handleApplyFilters = () => {
            syncStateFromModal();
            closeModal();

            // --- Map modal filterState to app's global filter format ---
            const newFilters = {};

            // Search filter (get from main search input)
            const searchInput = document.getElementById('search-input');
            if (searchInput && searchInput.value.trim()) {
                newFilters.search = searchInput.value.trim();
            }

            // Day of week
            if (filterState.dayOfWeek.size > 0) {
                // Check if "Any Day" is selected (it would be the only item)
                const selectedDays = Array.from(filterState.dayOfWeek);
                if (selectedDays.length === 1 && selectedDays[0] === 'any') {
                    newFilters.day = ''; // Empty string for "Any Day"
                } else {
                    // Filter out "any" and use actual days
                    const actualDays = selectedDays.filter(day => day !== 'any');
                    if (actualDays.length > 0) {
                        newFilters.day = actualDays.length === 1 ? actualDays[0] : actualDays;
                    } else {
                        newFilters.day = ''; // No actual days selected
                    }
                }
            } else {
                newFilters.day = '';
            }

            // Time
            newFilters.customTimeStart = filterState.time.from
                ? to12HourString(filterState.time.from)
                : '';
            newFilters.customTimeEnd = filterState.time.to
                ? to12HourString(filterState.time.to)
                : '';
            
            // Mark that time was set via modal (to show pill even if it's 10am-11:45pm)
            if (newFilters.customTimeStart && newFilters.customTimeEnd) {
                newFilters.timeSetViaModal = true;
            }

            // Location (map to boroughs)
            newFilters.borough = Array.from(filterState.locations);
            // DEBUG: Log boroughs after mapping
            console.log('[DEBUG] newFilters.borough:', newFilters.borough);

            // Details (map to cost and signup)
            newFilters.cost = [];
            newFilters.signup = [];
            filterState.details.forEach(detail => {
                if (detail === "Free") {
                    newFilters.cost.push('free');
                } else if (detail === "Paid") {
                    newFilters.cost.push('paid');
                } else if (detail === "1 Item Min") {
                    newFilters.cost.push('1 drink min');
                } else if (detail === "In-person Sign-up") {
                    newFilters.signup.push('in-person');
                } else if (detail === "Online Sign-up") {
                    newFilters.signup.push('online');
                }
            });

            // Favorites
            newFilters.showFavorites = filterState.favorites.has("Show Favorites Only");

            // DEBUG: Log all filters before applying
            console.log('[DEBUG] About to apply filters:', newFilters);

            // Save and apply
            if (window.MicFinderState && window.MicFinderFilters && window.MicFinderApp) {
                console.log('Applying filters...');
                window.MicFinderState.setActiveFilters(newFilters);
                window.MicFinderFilters.saveFilterState(newFilters);
                window.MicFinderApp.render();
                console.log('Filters applied successfully');
                // Render pills AFTER global state is updated
                renderActivePills();
                // Force search bar dropdown to update with new filters
                const searchInput = document.getElementById('search-input');
                if (searchInput) {
                    searchInput.dispatchEvent(new Event('input', { bubbles: true }));
                }
            } else {
                console.error('Required window objects not available');
            }
        };
        const handleClearFilters = () => {
            // Clear local filter state
            Object.values(filterState).forEach(val => (val instanceof Set ? val.clear() : (val.from = '', val.to = '')));
            
            // Set time to 10:00 AM - 11:59 PM after clearing
            filterState.time.from = '10:00';
            filterState.time.to = '23:59';
            
            // Don't set any default day - leave dayOfWeek empty
            // const today = new Date().toLocaleString('en-us', { weekday: 'long' });
            // filterState.dayOfWeek.add(today);
            
            // Update time pickers
            updatePickerFromState('time-from-picker', '10:00');
            updatePickerFromState('time-to-picker', '23:59');
            
            // Clear all day pills - don't set any as active
            document.querySelectorAll('#dayOfWeek-filters .day-pill').forEach(p => {
                p.classList.remove('active');
            });
            
            // Clear mobile day select as well
            const mobileDaySelect = document.getElementById('mobile-day-select');
            if (mobileDaySelect) {
                mobileDaySelect.value = '';
            }
            
            // Clear all checkboxes
            document.querySelectorAll('#location-filters input[type="checkbox"]').forEach(cb => cb.checked = false);
            document.querySelectorAll('#details-filters input[type="checkbox"]').forEach(cb => cb.checked = false);
            document.querySelectorAll('#favorites-filter input[type="checkbox"]').forEach(cb => cb.checked = false);
            
            // Apply the cleared filters
            handleApplyFilters();
        };
        const syncModalFromGlobalState = () => {
            if (!window.MicFinderState) return;
            
            const globalFilters = window.MicFinderState.getActiveFilters();
            
            // Clear current state
            Object.values(filterState).forEach(val => (val instanceof Set ? val.clear() : (val.from = '', val.to = '')));
            
            // Day of week
            if (globalFilters.day && globalFilters.day !== '') {
                if (Array.isArray(globalFilters.day)) {
                    globalFilters.day.forEach(day => filterState.dayOfWeek.add(day));
                } else {
                    filterState.dayOfWeek.add(globalFilters.day);
                }
            } else {
                // Clear any existing day selections - "Any Day" will be active
                filterState.dayOfWeek.clear();
            }
            
            // Time
            if (globalFilters.customTimeStart) {
                const startTime = globalFilters.customTimeStart;
                const [time, period] = startTime.split(' ');
                const [hour, minute] = time.split(':');
                let hour24 = parseInt(hour);
                if (period === 'PM' && hour24 !== 12) hour24 += 12;
                if (period === 'AM' && hour24 === 12) hour24 = 0;
                filterState.time.from = `${hour24.toString().padStart(2, '0')}:${minute}`;
            }
            
            if (globalFilters.customTimeEnd) {
                const endTime = globalFilters.customTimeEnd;
                const [time, period] = endTime.split(' ');
                const [hour, minute] = time.split(':');
                let hour24 = parseInt(hour);
                if (period === 'PM' && hour24 !== 12) hour24 += 12;
                if (period === 'AM' && hour24 === 12) hour24 = 0;
                filterState.time.to = `${hour24.toString().padStart(2, '0')}:${minute}`;
            }
            
            // Borough
            if (globalFilters.borough && Array.isArray(globalFilters.borough)) {
                globalFilters.borough.forEach(borough => filterState.locations.add(borough));
            }
            
            // Cost and signup
            if (globalFilters.cost && Array.isArray(globalFilters.cost)) {
                globalFilters.cost.forEach(cost => {
                    if (cost === 'free') filterState.details.add('Free');
                    else if (cost === 'paid') filterState.details.add('Paid');
                    else if (cost === '1 drink min') filterState.details.add('1 Item Min');
                });
            }
            
            if (globalFilters.signup && Array.isArray(globalFilters.signup)) {
                globalFilters.signup.forEach(signup => {
                    if (signup === 'in-person') filterState.details.add('In-person Sign-up');
                    else if (signup === 'online') filterState.details.add('Online Sign-up');
                });
            }
            
            // Favorites
            if (globalFilters.showFavorites) {
                filterState.favorites.add('Show Favorites Only');
            }
            
            // Update modal UI
            syncModalFromState();
            renderActivePills();
        };
        // Remove or guard these event listener attachments:
        if (typeof modalButton !== 'undefined' && modalButton) {
            modalButton.addEventListener('click', openModal);
            
            // Add right-click context menu functionality
            modalButton.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                showResetContextMenu(e);
            });
        }
        const modalButtonMobile = document.getElementById('modal-button-mobile');
        if (typeof modalButtonMobile !== 'undefined' && modalButtonMobile) modalButtonMobile.addEventListener('click', openModal);
        if (typeof closeModalX !== 'undefined' && closeModalX) closeModalX.addEventListener('click', closeModal);
        if (typeof applyFiltersButton !== 'undefined' && applyFiltersButton) applyFiltersButton.addEventListener('click', handleApplyFilters);
        if (typeof clearFiltersButton !== 'undefined' && clearFiltersButton) clearFiltersButton.addEventListener('click', handleClearFilters);
        
        // Context Menu Functions
        const resetContextMenu = document.getElementById('reset-context-menu');
        const resetToDefaultButton = document.getElementById('reset-to-default-filters');
        
        console.log('🔍 [DEBUG] Context menu elements found:', {
            resetContextMenu: !!resetContextMenu,
            resetToDefaultButton: !!resetToDefaultButton,
            isMobile: window.MicFinderUtils ? window.MicFinderUtils.isMobileDevice() : 'unknown'
        });
        
        // Add right-click context menu to the map element so it works in all views
        function attachContextMenuToMap() {
            const mapElement = document.getElementById('map');
            if (mapElement) {
                // Remove any existing listeners to avoid duplicates
                mapElement.removeEventListener('contextmenu', handleMapContextMenu);
                mapElement.addEventListener('contextmenu', handleMapContextMenu);
                console.log('🎯 [CONTEXT] Successfully added context menu to map element');
                
                // Also add touch event for mobile devices
                mapElement.removeEventListener('touchstart', handleMobileContextMenu);
                mapElement.addEventListener('touchstart', handleMobileContextMenu, { passive: false });
                console.log('📱 [CONTEXT] Added mobile touch handler for context menu');
                
                return true;
            } else {
                console.log('🎯 [CONTEXT] Map element not found, will retry...');
                return false;
            }
        }
        
        function handleMapContextMenu(e) {
            console.log('🖱️ [CONTEXT] Right-click detected on map');
            e.preventDefault();
            showResetContextMenu(e);
        }
        
        function handleMobileContextMenu(e) {
            console.log('📱 [CONTEXT] Touch detected on map', {
                touches: e.touches.length,
                isMobile: window.MicFinderUtils ? window.MicFinderUtils.isMobileDevice() : 'unknown',
                viewport: {
                    width: window.innerWidth,
                    height: window.innerHeight
                }
            });
            
            // For mobile, show context menu on long press
            if (e.touches.length === 1) {
                const touch = e.touches[0];
                const startX = touch.clientX;
                const startY = touch.clientY;
                let hasMoved = false;
                
                const longPressTimer = setTimeout(() => {
                    if (!hasMoved) {
                        console.log('📱 [CONTEXT] Long press detected, showing context menu');
                        showResetContextMenu({
                            pageX: startX,
                            pageY: startY,
                            preventDefault: () => {}
                        });
                    }
                }, 500); // 500ms long press
                
                // Track movement to cancel long press if user is panning
                const trackMovement = (moveEvent) => {
                    if (moveEvent.touches.length === 1) {
                        const currentTouch = moveEvent.touches[0];
                        const deltaX = Math.abs(currentTouch.clientX - startX);
                        const deltaY = Math.abs(currentTouch.clientY - startY);
                        
                        // If moved more than 10px, consider it a pan gesture
                        if (deltaX > 10 || deltaY > 10) {
                            hasMoved = true;
                            clearTimeout(longPressTimer);
                            console.log('📱 [CONTEXT] Movement detected, canceling long press');
                        }
                    }
                };
                
                // Clear timer and remove listeners
                const clearTimer = () => {
                    clearTimeout(longPressTimer);
                    hasMoved = false;
                    // Fix: Get map element within the function scope
                    const currentMapElement = document.getElementById('map');
                    if (currentMapElement) {
                        currentMapElement.removeEventListener('touchend', clearTimer);
                        currentMapElement.removeEventListener('touchcancel', clearTimer);
                        currentMapElement.removeEventListener('touchmove', trackMovement);
                    }
                };
                
                // Fix: Get map element within the function scope
                const currentMapElement = document.getElementById('map');
                if (currentMapElement) {
                    currentMapElement.addEventListener('touchend', clearTimer, { once: true });
                    currentMapElement.addEventListener('touchcancel', clearTimer, { once: true });
                    currentMapElement.addEventListener('touchmove', trackMovement, { passive: true });
                }
            }
        }
        
        // Try to attach immediately
        if (!attachContextMenuToMap()) {
            // Retry after a short delay in case map isn't loaded yet
            setTimeout(() => {
                if (!attachContextMenuToMap()) {
                    // Try again after map initialization
                    setTimeout(attachContextMenuToMap, 2000);
                }
            }, 1000);
        }
        
        // Re-enable mobile context menu after fixing the scope issue
        setTimeout(() => {
            const mapElement = document.getElementById('map');
            if (mapElement && typeof handleMobileContextMenu === 'function') {
                mapElement.addEventListener('touchstart', handleMobileContextMenu, { passive: false });
                console.log('✅ [CONTEXT] Mobile context menu re-enabled after fix');
            }
        }, 1000);
        
        function showResetContextMenu(e) {
            console.log('📋 [CONTEXT] Attempting to show reset context menu', {
                eventType: e.type || 'unknown',
                pageX: e.pageX,
                pageY: e.pageY,
                isMobile: window.MicFinderUtils ? window.MicFinderUtils.isMobileDevice() : 'unknown',
                viewport: {
                    width: window.innerWidth,
                    height: window.innerHeight
                }
            });
            
            e.preventDefault();
            const menu = document.getElementById('reset-context-menu');
            if (menu) {
                console.log('📋 [CONTEXT] Context menu element found, showing...');
                menu.style.display = 'block';
                menu.style.left = e.pageX + 'px';
                menu.style.top = e.pageY + 'px';
                
                // Log menu state
                console.log('📋 [CONTEXT] Menu displayed with styles:', {
                    display: menu.style.display,
                    left: menu.style.left,
                    top: menu.style.top,
                    visibility: menu.style.visibility,
                    opacity: menu.style.opacity,
                    zIndex: menu.style.zIndex
                });
                
                // Add click outside listener to close menu
                setTimeout(() => {
                    document.addEventListener('click', closeResetContextMenu, { once: true });
                }, 0);
            } else {
                console.error('❌ [CONTEXT] Context menu element not found!');
            }
        }
        
        function closeResetContextMenu() {
            console.log('❌ [CONTEXT] Closing reset context menu');
            const menu = document.getElementById('reset-context-menu');
            if (menu) {
                menu.style.display = 'none';
                console.log('❌ [CONTEXT] Menu hidden successfully');
            } else {
                console.error('❌ [CONTEXT] Could not find menu to close');
            }
        }
        
        function resetToDefaultFilters() {
            console.log('🔄 [RESET] Reset function called!', {
                timestamp: new Date().toISOString(),
                isMobile: window.MicFinderUtils ? window.MicFinderUtils.isMobileDevice() : 'unknown',
                viewport: {
                    width: window.innerWidth,
                    height: window.innerHeight
                },
                userAgent: navigator.userAgent.substring(0, 100) + '...'
            });
            console.log('🔄 [RESET] Resetting to default filters...');
            
            // Calculate current time rounded to nearest 15 minutes
            const now = new Date();
            let hours = now.getHours();
            let minutes = now.getMinutes();
            let snappedMinutes = Math.round(minutes / 15) * 15;
            if (snappedMinutes === 60) {
                snappedMinutes = 0;
                hours = (hours + 1) % 24;
            }
            const currentTime = `${hours.toString().padStart(2, '0')}:${snappedMinutes.toString().padStart(2, '0')}`;
            
            // Get current day
            const currentDay = window.MicFinderUtils.getCurrentDay();
            
            // Set default filters
            const defaultFilters = {
                day: currentDay, // Set to current day instead of empty string
                sort: 'currentTime',
                customTimeStart: to12HourString(currentTime),
                customTimeEnd: '11:45 PM',
                timeSetViaModal: false,
                isDefaultTimeRange: true,
                showFavorites: false,
                borough: [],
                neighborhood: [],
                cost: [],
                mapFilterEnabled: false,
                search: '',
                signup: [],
                exactVenue: false
            };
            
            console.log('🔄 [RESET] Default filters:', defaultFilters);
            
            // Apply filters
            window.MicFinderState.setActiveFilters(defaultFilters);
            window.MicFinderFilters.saveFilterState(defaultFilters);
            
            // Update time pickers
            updatePickerFromState('time-from-picker', currentTime);
            updatePickerFromState('time-to-picker', '23:45');
            
            // Clear day pills and set current day as active
            document.querySelectorAll('.day-pill').forEach(p => p.classList.remove('active'));
            const currentDayPill = document.querySelector(`[data-day="${currentDay.toLowerCase()}"]`);
            if (currentDayPill) {
                currentDayPill.classList.add('active');
            }
            
            // Re-render app
            window.MicFinderApp.render();
            
            // Close context menu
            closeResetContextMenu();
            
            console.log('✅ [RESET] Successfully reset to default filters');
        }
        
        // Add event listener for reset button
        if (resetToDefaultButton) {
            console.log('🎯 [RESET] Adding click event listener to reset button');
            resetToDefaultButton.addEventListener('click', resetToDefaultFilters);
            console.log('✅ [RESET] Click event listener added successfully');
        } else {
            console.error('❌ [RESET] Reset button not found - cannot add event listener');
        }
        
        // Close modal when clicking outside of modal content
        if (typeof filterModal !== 'undefined' && filterModal) {
            filterModal.addEventListener('click', (e) => {
                if (e.target === filterModal) {
                    closeModal();
                }
            });
        }
        
        document.addEventListener('click', (e) => {
            // Don't close dropdowns if clicking on day dropdown or pill
            if (e.target && typeof e.target.closest === 'function') {
                if (!e.target.closest('.relative') && 
                    !e.target.closest('.pill-dropdown') && 
                    !e.target.closest('.pill[data-type="day"]')) {
                    closeAllDropdowns();
                }
            }
        });
        
        // Initialize modal state on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Wait for the app to initialize, then sync modal state
            setTimeout(() => {
                if (window.MicFinderState) {
                    syncModalFromGlobalState();
                    // Ensure "Any Day" pill exists
                    ensureAnyDayPillExists();
                    // Render pills immediately after syncing state
                    renderActivePills();
                    // Set up a listener for state changes to re-render pills
                    const originalSetActiveFilters = window.MicFinderState.setActiveFilters;
                    // Helper function to apply mutual exclusivity rules
                    function applyMutualExclusivityRules(filters) {
                        const cleanFilters = { ...filters };
                        
                        // Cost mutual exclusivity: Free vs Paid (handle both popup and modal formats)
                        if (Array.isArray(cleanFilters.cost)) {
                            const hasFree = cleanFilters.cost.includes('Free') || cleanFilters.cost.includes('free');
                            const hasPaid = cleanFilters.cost.includes('Paid') || cleanFilters.cost.includes('paid');
                            
                            if (hasFree && hasPaid) {
                                // Remove all Paid variants and keep Free variants
                                cleanFilters.cost = cleanFilters.cost.filter(c => 
                                    c !== 'Paid' && c !== 'paid'
                                );
                                console.log('🔧 [MUTUAL EXCLUSIVITY] Removed "Paid" because "Free" is selected');
                            }
                        }
                        
                        // Signup mutual exclusivity: In-person vs Online (handle both popup and modal formats)
                        if (Array.isArray(cleanFilters.signup)) {
                            const hasInPerson = cleanFilters.signup.includes('In-person Sign-up') || cleanFilters.signup.includes('in-person');
                            const hasOnline = cleanFilters.signup.includes('Online Sign-up') || cleanFilters.signup.includes('online');
                            
                            if (hasInPerson && hasOnline) {
                                // Remove all Online variants and keep In-person variants
                                cleanFilters.signup = cleanFilters.signup.filter(s => 
                                    s !== 'Online Sign-up' && s !== 'online'
                                );
                                console.log('🔧 [MUTUAL EXCLUSIVITY] Removed "Online Sign-up" because "In-person Sign-up" is selected');
                            }
                        }
                        
                        return cleanFilters;
                    }

                    window.MicFinderState.setActiveFilters = function(filters) {
                        // Apply mutual exclusivity rules before setting filters
                        const cleanFilters = applyMutualExclusivityRules(filters);
                        originalSetActiveFilters.call(this, cleanFilters);
                                            // Re-render pills whenever filters change (unless disabled)
                        if (!window._disablePillRerender) {
                            setTimeout(() => {
                                syncModalFromGlobalState();
                                // Ensure "Any Day" pill exists
                                ensureAnyDayPillExists();
                                renderActivePills();
                                syncPillsWithGlobalState();
                            }, 0);
                        }
                    };

                    // Clean up existing filter state immediately
                    const currentFilters = window.MicFinderState.getActiveFilters();
                    const cleanedCurrentFilters = applyMutualExclusivityRules(currentFilters);
                    if (JSON.stringify(currentFilters) !== JSON.stringify(cleanedCurrentFilters)) {
                        console.log('🔧 [INITIAL CLEANUP] Applying mutual exclusivity to existing filters');
                        window.MicFinderState.setActiveFilters(cleanedCurrentFilters);
                    }
                }
            }, 100);
            
            // Add search input listener for real-time filtering
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                // Autocomplete functionality
                let autocompleteSuggestions = [];
                let selectedIndex = -1;
                
                // Generate suggestions from mic data (with typo tolerance using Fuse.js)
                function generateSuggestions(query) {
                    if (!query || query.length < 2) return [];

                    // Always use the full list of mics for venue suggestions (do NOT apply current filters)
                    let allMics = window.MicFinderState ? window.MicFinderState.getAllMics() : [];
                    if (!allMics || allMics.length === 0) return [];

                    // --- Group mics by venue for pill grid ---
                    function normalizeVenueName(name) {
                        return name.trim().toLowerCase().replace(/^the\s+/, '').replace(/[^a-z0-9 ]/gi, '');
                    }
                    const venueMap = {};
                    const filters = window.MicFinderState ? window.MicFinderState.getActiveFilters() : {};
                    allMics.forEach(mic => {
                        const normVenue = normalizeVenueName(mic.venue);
                        if (!venueMap[normVenue]) {
                            venueMap[normVenue] = {
                                ...mic,
                                venue: mic.venue, // Keep the original casing of the first occurrence
                                times: [],
                                allMicTimes: [],
                                allMicIds: [],
                            };
                        }
                        // Always store all times/ids for reference (but deduplicate times)
                        if (!venueMap[normVenue].allMicTimes.includes(mic.time)) {
                            venueMap[normVenue].allMicTimes.push(mic.time);
                        }
                        venueMap[normVenue].allMicIds.push(mic.id);

                        // Only add to .times if it matches ALL filters
                        let matches = true;
                        // Day filter
                        if (filters.day) {
                            const days = Array.isArray(filters.day) ? filters.day : [filters.day];
                            if (!days.includes(mic.day)) matches = false;
                        }
                        // Time filter (assume mic.time is in 'h:mm AM/PM' and filters.customTimeStart/End are also in 'h:mm AM/PM')
                        if (filters.customTimeStart && filters.customTimeEnd && mic.time) {
                            function timeToMinutes(t) {
                                let match = t.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
                                if (!match) return null;
                                let [_, h, m, p] = match;
                                h = parseInt(h, 10);
                                m = parseInt(m, 10);
                                if (p.toUpperCase() === 'PM' && h < 12) h += 12;
                                if (p.toUpperCase() === 'AM' && h === 12) h = 0;
                                return h * 60 + m;
                            }
                            const micMins = timeToMinutes(mic.time);
                            const startMins = timeToMinutes(filters.customTimeStart);
                            const endMins = timeToMinutes(filters.customTimeEnd);
                            if (micMins === null || startMins === null || endMins === null || micMins < startMins || micMins > endMins) matches = false;
                        }
                        // Location filter (borough)
                        if (filters.borough && Array.isArray(filters.borough) && filters.borough.length > 0) {
                            if (!filters.borough.includes(mic.borough)) matches = false;
                        }
                        // Details filter (cost)
                        if (filters.cost && Array.isArray(filters.cost) && filters.cost.length > 0) {
                            if (!filters.cost.includes((mic.cost || '').toLowerCase())) matches = false;
                        }
                        // Details filter (signup)
                        if (filters.signup && Array.isArray(filters.signup) && filters.signup.length > 0) {
                            if (!filters.signup.includes((mic.signup || '').toLowerCase())) matches = false;
                        }
                        // Favorites filter
                        if (filters.showFavorites) {
                            if (!window.MicFinderFavorites || !window.MicFinderFavorites.isFavorite || !window.MicFinderFavorites.isFavorite(mic.id)) matches = false;
                        }
                        // --- DEBUG LOG ---
                        console.log('[DEBUG][Autocomplete] Venue:', mic.venue, '| Day:', mic.day, '| Time:', mic.time, '| Borough:', mic.borough, '| Included:', matches);
                        // --- Add times for mics that match filters (include future mics) ---
                        if (matches) {
                            // For autocomplete, show all matching times (not just "open" ones)
                            if (!venueMap[normVenue].times.includes(mic.time)) {
                                venueMap[normVenue].times.push(mic.time);
                            }
                        }
                    });
                    const fuseData = Object.values(venueMap).map(venue => ({
                        type: 'venue',
                        title: venue.venue,
                        subtitle: venue.address,
                        data: { venue: venue.venue },
                        mic: venue,
                        times: venue.times,
                        micIds: venue.allMicIds,
                    }));

                    // Set up Fuse.js
                    const fuse = new Fuse(fuseData, {
                        keys: ['title'],
                        threshold: 0.38, // Lower = stricter, higher = fuzzier
                        distance: 100,
                        minMatchCharLength: 2,
                        ignoreLocation: true,
                    });

                    // Get results
                    const results = fuse.search(query, { limit: 8 });
                    // Map to suggestion format
                    return results.map(res => ({
                        ...res.item,
                        title: res.item.title,
                        subtitle: res.item.subtitle,
                        type: res.item.type,
                        data: res.item.data,
                        mic: res.item.mic,
                        times: res.item.times,
                        micIds: res.item.micIds,
                    }));
                }
                
                // Highlight matching text
                function highlightText(text, query) {
                    if (!query) return text;
                    const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                    return text.replace(regex, '<span class="autocomplete-highlight">$1</span>');
                }
                
                // Render a single mixed list of recent searches and fuzzy suggestions (Google Maps style)
                function renderSuggestions(suggestions, isHistory = false, historyList = []) {
                    const dropdown = document.getElementById('autocomplete-dropdown');
                    if (!dropdown) return;

                    const query = searchInput.value.trim().toLowerCase();
                    let history = (historyList && historyList.length > 0) ? historyList : getSearchHistory();
                    let matchingHistory = [];
                    let mixedList = [];

                    if (query.length < 2) {
                        // Show up to 5 most recent history items (no venue suggestions)
                        matchingHistory = history.slice(0, 5);
                        mixedList = matchingHistory.map(term => ({
                            type: 'history',
                            title: term,
                            icon: 'fa-history',
                            isHistory: true
                        }));
                    } else {
                        // Show up to 2 matching history items, then venue suggestions
                        matchingHistory = history.filter(term => term.toLowerCase().includes(query)).slice(0, 2);
                        mixedList = [
                            ...matchingHistory.map(term => ({
                                type: 'history',
                                title: term,
                                icon: 'fa-history',
                                isHistory: true
                            })),
                            ...suggestions
                        ];
                    }

                    if (mixedList.length === 0) {
                        dropdown.innerHTML = '<div class="autocomplete-no-results">No matches found</div>';
                        dropdown.classList.remove('hidden');
                        return;
                    }

                    let html = mixedList.map((item, index) => {
                        if (item.isHistory) {
                            console.log('[RENDER] Rendering history suggestion:', item.title);
                            return `
                                <div class="autocomplete-suggestion history" data-index="h${index}" data-type="history" data-history-term="${item.title}">
                                    <div class="autocomplete-suggestion-icon"><i class="fa fa-history" aria-hidden="true"></i></div>
                                    <div class="autocomplete-suggestion-content">
                                        <div class="autocomplete-suggestion-title">${item.title}</div>
                                    </div>
                                    <button class="autocomplete-history-remove" title="Remove from history" tabindex="0" aria-label="Remove ${item.title} from history">&times;</button>
                                </div>
                            `;
                        } else {
                            let mic = item.mic || null;
                            const address = mic?.address || item.subtitle || '';
                            let distanceHtml = '';
                            if (userLocation && mic && typeof mic.lat === 'number' && typeof mic.lon === 'number') {
                                const dist = getDistanceMiles(userLocation.lat, userLocation.lon, mic.lat, mic.lon);
                                if (dist !== null && !isNaN(dist)) {
                                    distanceHtml = `<span class='autocomplete-suggestion-distance'>${dist.toFixed(1)} mi away</span>`;
                                }
                            }
                            let fullAddress = (mic?.address || item.subtitle || '').replace(/\n|\r|<br\s*\/?\>/gi, ' ');
                            let zip = '';
                            const zipMatch = fullAddress.match(/\b\d{5}\b/);
                            if (zipMatch) zip = zipMatch[0];
                            if (mic?.borough && zip) {
                                fullAddress = `${mic.borough}, NY, ${zip}`;
                            } else if (mic?.borough) {
                                fullAddress = `${mic.borough}, NY`;
                            } else if (zip) {
                                fullAddress = `NY, ${zip}`;
                            }
                            // --- Always render all times as pills for venue suggestions ---
                            let timesHtml = '';
                            if (item.type === 'venue' && item.times && item.times.length > 0) {
                                // DEBUG: Log times for each venue
                                console.log(`[RENDER DEBUG] Venue: ${item.title} | Times:`, item.times);
                                
                                // Sort times from earliest to latest
                                const parseTimeToMinutes = (timeStr) => {
                                    let match = timeStr.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
                                    if (match) {
                                        let [_, hours, minutes, modifier] = match;
                                        hours = parseInt(hours, 10);
                                        minutes = parseInt(minutes, 10);
                                        if (modifier.toUpperCase() === 'PM' && hours < 12) hours += 12;
                                        if (modifier.toUpperCase() === 'AM' && hours === 12) hours = 0;
                                        return hours * 60 + minutes;
                                    }
                                    match = timeStr.match(/^(\d{1,2}):(\d{2})$/);
                                    if (match) {
                                        let [_, hours, minutes] = match;
                                        return parseInt(hours, 10) * 60 + parseInt(minutes, 10);
                                    }
                                    return 0;
                                };
                                const sortedTimes = [...item.times].sort((a, b) => parseTimeToMinutes(a) - parseTimeToMinutes(b));
                                timesHtml = `
                                    <div class=\"flex flex-wrap gap-2 mt-2\">
                                        ${sortedTimes.map(time => `<span class=\"pill bg-gray-700 text-white\" data-venue=\"${item.title}\" data-time=\"${time}\">${time}</span>`).join('')}
                                    </div>
                                `;
                            } else if (item.type === 'venue') {
                                // DEBUG: Log when venue has no times
                                console.log(`[RENDER DEBUG] Venue: ${item.title} | No times array or empty times array:`, item.times);
                            }
                            return `
                                <div class=\"autocomplete-suggestion ${item.type} ${index === selectedIndex ? 'selected' : ''}\" 
                                     data-index=\"${index}\" 
                                     data-type=\"${item.type}\"
                                     data-venue=\"${item.data?.venue || ''}\"
                                     data-neighborhood=\"${item.data?.neighborhood || ''}\"
                                     data-borough=\"${item.data?.borough || ''}\"
                                     data-address=\"${fullAddress}\">
                                    <div class=\"autocomplete-suggestion-icon\">
                                        <i class=\"fa fa-map-marker-alt\" aria-hidden=\"true\"></i>
                                    </div>
                                    <div class=\"autocomplete-suggestion-content\">
                                        <div class=\"autocomplete-suggestion-title\">${highlightText(item.title, searchInput.value)}</div>
                                        <div class=\"autocomplete-suggestion-subtitle\">${fullAddress}</div>
                                        ${distanceHtml ? `<div class=\"autocomplete-suggestion-distance\">${distanceHtml}</div>` : ''}
                                        ${timesHtml}
                                    </div>
                                </div>
                            `;
                        }
                    }).join('');
                    // Add clear history button if any history is shown
                    if (matchingHistory.length > 0) {
                        html += `<div class="autocomplete-clear-history-row">
                            <button class="autocomplete-clear-history-btn" tabindex="0">Clear History</button>
                        </div>`;
                    }
                    dropdown.innerHTML = html;
                    dropdown.classList.remove('hidden');
                    isDropdownVisible = true;
                    console.log('Dropdown shown');

                    // Click handler for fuzzy suggestions
                    dropdown.querySelectorAll('.autocomplete-suggestion:not(.history)').forEach(suggestion => {
                        suggestion.addEventListener('mousedown', (e) => {
                            e.preventDefault(); // Prevent input blur before handler
                            selectSuggestion(suggestion);
                        });
                    });
                    // --- NEW: Click handler for time pills ---
                    dropdown.querySelectorAll('.autocomplete-suggestion').forEach(suggestion => {
                        const venue = suggestion.getAttribute('data-venue');
                        // Try to get the day from the suggestion's mic object (if available)
                        let day = null;
                        // Try to find the suggestion's index in the suggestions array
                        let suggestionIndex = suggestion.getAttribute('data-index');
                        if (suggestionIndex && !isNaN(suggestionIndex)) {
                            suggestionIndex = parseInt(suggestionIndex);
                            if (suggestions[suggestionIndex] && suggestions[suggestionIndex].mic && suggestions[suggestionIndex].mic.day) {
                                day = suggestions[suggestionIndex].mic.day;
                            }
                        }
                        // Fallback: use current filter day
                        if (!day && window.MicFinderState) {
                            const filters = window.MicFinderState.getActiveFilters();
                            day = Array.isArray(filters.day) ? filters.day[0] : filters.day;
                        }
                        suggestion.querySelectorAll('.pill.bg-gray-700').forEach(pill => {
                            pill.addEventListener('click', (e) => {
                                e.stopPropagation();
                                const time = pill.textContent.trim();
                                console.log('[Time Pill Click] Venue:', venue, 'Day:', day, 'Time:', time);
                                if (!venue || !day || !time) {
                                    console.warn('[Time Pill Click] Missing venue, day, or time.');
                                    return;
                                }
                                const allMics = window.MicFinderState.getAllMics();
                                // Find mic by venue, day, and time (case-insensitive, trimmed)
                                const mic = allMics.find(m =>
                                    m.venue && m.venue.trim().toLowerCase() === venue.trim().toLowerCase() &&
                                    m.day && m.day.trim().toLowerCase() === day.trim().toLowerCase() &&
                                    m.time && m.time.trim().toLowerCase() === time.toLowerCase()
                                );
                                console.log('[Time Pill Click] Found mic:', mic);
                                if (mic) {
                                    if (window.MicFinderUI && window.MicFinderUI.showMicDetails) {
                                        console.log('[Time Pill Click] Calling showMicDetails for mic.id:', mic.id);
                                        window.MicFinderUI.showMicDetails(mic.id);
                                    }
                                    if (window.MicFinderMap && window.MicFinderMap.showMicOnMap) {
                                        console.log('[Time Pill Click] Calling showMicOnMap for mic:', mic);
                                        window.MicFinderMap.showMicOnMap(mic);
                                    }
                                    // Optionally, close the dropdown
                                    hideDropdown();
                                } else {
                                    console.warn('[Time Pill Click] No matching mic found for venue, day, time.');
                                }
                            });
                        });
                    });
                    // Click handler for history
                    console.log('[ATTACH] Attaching history click listeners...');
                    dropdown.querySelectorAll('.autocomplete-suggestion.history').forEach(suggestion => {
                        suggestion.addEventListener('mousedown', (e) => {
                            e.preventDefault(); // Prevent input blur before handler
                            // Prevent remove button from triggering this
                            if (e.target.classList.contains('autocomplete-history-remove')) return;
                            const term = suggestion.getAttribute('data-history-term');
                            
                            // Set the search input value
                            isExactVenueSelection = true;
                            searchInput.value = term;
                            
                            // Hide dropdown
                            hideDropdown();
                            
                            // Apply the search
                            applySearch();
                            
                            // --- Zoom to venue on map if it's a venue name ---
                            if (window.MicFinderState && window.MicFinderMap) {
                                const allMics = window.MicFinderState.getAllMics();
                                // Try to find the first mic for this venue name
                                const mic = allMics.find(m => m.venue && m.venue.toLowerCase() === term.toLowerCase());
                                // Simulate applying the search filter
                                const currentFilters = window.MicFinderState.getActiveFilters();
                                const testFilters = { ...currentFilters, search: term, exactVenue: term };
                                const filteredMics = window.MicFinderFilters.applyAllFilters(testFilters);
                                if (!mic || filteredMics.length === 0) {
                                    // Revert search input value to previous if popup is shown
                                    if (searchInput) searchInput.value = currentFilters.search || '';
                                    showNoMicsTodayPopup(term);
                                    return;
                                }
                                // If there are results, proceed as normal
                                if (mic && typeof mic.lat === 'number' && typeof mic.lon === 'number') {
                                    if (window.MicFinderState.getCurrentMobileView && window.MicFinderState.getCurrentMobileView() !== 'map') {
                                        if (window.MicFinderMobile && window.MicFinderMobile.switchMobileView) {
                                            window.MicFinderMobile.switchMobileView('map');
                                        }
                                    }
                                    setTimeout(() => {
                                        if (window.MicFinderMap.showMicOnMap) {
                                            window.MicFinderMap.showMicOnMap(mic);
                                            if (window.MicFinderMap.scrollToListItem) {
                                                window.MicFinderMap.scrollToListItem(mic.id);
                                            }
                                        } else if (window.map && window.map.setView) {
                                            window.map.setView([mic.lat, mic.lon], 14, { animate: true });
                                        }
                                    }, 0);
                                }
                            }
                            
                            // Reset the flag after all logic is complete
                            setTimeout(() => {
                                isExactVenueSelection = false;
                            }, 100);
                        });
                    });
                    // Remove individual history item
                    dropdown.querySelectorAll('.autocomplete-history-remove').forEach((btn, idx) => {
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            let history = getSearchHistory();
                            history.splice(idx, 1);
                            saveSearchHistory(history);
                            // Re-render with current suggestions and updated history
                            const query = searchInput.value.trim();
                            const suggestions = query.length >= 2 ? generateSuggestions(query) : [];
                            renderSuggestions(suggestions, false, history);
                        });
                    });
                    // Clear all history
                    const clearBtn = dropdown.querySelector('.autocomplete-clear-history-btn');
                    if (clearBtn) {
                        clearBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            saveSearchHistory([]);
                            const query = searchInput.value.trim();
                            const suggestions = query.length >= 2 ? generateSuggestions(query) : [];
                            renderSuggestions(suggestions, false, []);
                        });
                    }
                }

                // --- Loading feedback for autocomplete ---
                let autocompleteLoadingTimeout = null;
                function showAutocompleteSpinner() {
                    const dropdown = document.getElementById('autocomplete-dropdown');
                    if (dropdown) {
                        dropdown.innerHTML = `<div class='autocomplete-loading-spinner'><div class='autocomplete-spinner'></div></div>`;
                        dropdown.classList.remove('hidden');
                    }
                }
                function hideAutocompleteSpinner() {
                    // No-op: spinner will be replaced by suggestions
                }

                // Show mixed suggestions as you type or on focus (with loading feedback)
                function showMixedSuggestions() {
                    const query = searchInput.value.trim();
                    if (query.length >= 2) {
                        // Show spinner if search takes >200ms
                        clearTimeout(autocompleteLoadingTimeout);
                        autocompleteLoadingTimeout = setTimeout(() => {
                            showAutocompleteSpinner();
                        }, 200);
                        Promise.resolve().then(() => {
                            const suggestions = generateSuggestions(query);
                            const history = getSearchHistory();
                            clearTimeout(autocompleteLoadingTimeout);
                            renderSuggestions(suggestions, false, history);
                        });
                    } else {
                        clearTimeout(autocompleteLoadingTimeout);
                        const history = getSearchHistory();
                        renderSuggestions([], false, history);
                    }
                }
                searchInput.addEventListener('focus', showMixedSuggestions);
                searchInput.addEventListener('input', (e) => {
                    setExactVenueFlag(false);
                    clearTimeout(searchInput.searchTimeout); // Always clear the debounce timer first

                    const value = searchInput.value;
                    if (value.length < 2) {
                        // Clear search and exactVenue filters immediately when text is too short
                        if (window.MicFinderState && window.MicFinderApp) {
                            const { setActiveFilters, getActiveFilters } = window.MicFinderState;
                            const filters = getActiveFilters();
                            const newFilters = { ...filters, search: '', exactVenue: '' };
                            setActiveFilters(newFilters);
                            if (window.MicFinderFilters && window.MicFinderFilters.saveFilterState) {
                                window.MicFinderFilters.saveFilterState(newFilters);
                            }
                            window.MicFinderApp.render();
                            renderActivePills();
                        }
                        return;
                    }

                    showMixedSuggestions();
                    // Debounce the search application to allow continued typing
                    searchInput.searchTimeout = setTimeout(() => {
                        applySearch();
                    }, 300); // Wait 300ms after user stops typing
                });
                
                // Add to history on every search
                function applySearch() {
                    console.log('[APPLY SEARCH] applySearch called with value:', searchInput.value);
                    if (window.MicFinderState && window.MicFinderApp) {
                        const currentFilters = window.MicFinderState.getActiveFilters();
                        const searchValue = searchInput.value.trim();
                        
                        // Only add to history if search has meaningful content
                        if (searchValue.length >= 2) {
                            addSearchToHistory(searchValue);
                        }

                        // Only apply search if at least 2 characters
                        if (searchValue.length < 2) {
                            // Clear search and exactVenue filters if search is too short
                            const newFilters = { ...currentFilters, search: '', exactVenue: '' };
                            window.MicFinderState.setActiveFilters(newFilters);
                            window.MicFinderFilters.saveFilterState(newFilters);
                            window.MicFinderApp.render();
                            renderActivePills();
                            return;
                        }

                        // Merge search/exactVenue into existing filters instead of replacing
                        const newFilters = { ...currentFilters, search: searchValue };
                        if (typeof currentFilters.mapFilterEnabled !== 'undefined') {
                            newFilters.mapFilterEnabled = currentFilters.mapFilterEnabled;
                        } else {
                            newFilters.mapFilterEnabled = false;
                        }
                        // Set exactVenue property
                        if (getExactVenueFlag()) {
                            newFilters.exactVenue = searchValue;
                        } else {
                            newFilters.exactVenue = '';
                        }
                        window.MicFinderState.setActiveFilters(newFilters);
                        window.MicFinderFilters.saveFilterState(newFilters);
                        window.MicFinderApp.render();
                        renderActivePills();
                        
                        // --- Navigate to venue on map if it's an exact venue match ---
                        if (window.MicFinderState && window.MicFinderMap) {
                            const allMics = window.MicFinderState.getAllMics();
                            // Try to find the first mic for this venue name (check both exact flag and direct match)
                            const mic = allMics.find(m => m.venue && m.venue.toLowerCase() === searchValue.toLowerCase());
                            if (mic && typeof mic.lat === 'number' && typeof mic.lon === 'number' && 
                                (getExactVenueFlag() || mic.venue.toLowerCase() === searchValue.toLowerCase())) {
                                if (window.MicFinderState.getCurrentMobileView && window.MicFinderState.getCurrentMobileView() !== 'map') {
                                    if (window.MicFinderMobile && window.MicFinderMobile.switchMobileView) {
                                        window.MicFinderMobile.switchMobileView('map');
                                    }
                                }
                                setTimeout(() => {
                                    if (window.MicFinderMap.showMicOnMap) {
                                        window.MicFinderMap.showMicOnMap(mic);
                                        if (window.MicFinderMap.scrollToListItem) {
                                            window.MicFinderMap.scrollToListItem(mic.id);
                                        }
                                    } else if (window.map && window.map.setView) {
                                        window.map.setView([mic.lat, mic.lon], 14, { animate: true });
                                    }
                                }, 0);
                            }
                        }
                    }
                    // Note: isExactVenueSelection flag is now handled by the calling code
                }
                
                // Select a suggestion
                function selectSuggestion(suggestionElement) {
                    const type = suggestionElement.dataset.type;
                    const venue = suggestionElement.dataset.venue;
                    const address = suggestionElement.dataset.address;
                    const historyTerm = suggestionElement.getAttribute('data-history-term');

                    // Set the search input value
                    if (type === 'venue') {
                        setExactVenueFlag(true);
                        searchInput.value = venue || address || '';
                    } else if (type === 'address') {
                        setExactVenueFlag(false);
                        searchInput.value = address || venue || '';
                    } else if (type === 'history') {
                        setExactVenueFlag(true);
                        searchInput.value = historyTerm || '';
                    } else {
                        setExactVenueFlag(false);
                    }

                    // Debug log
                    console.log('[SELECT SUGGESTION] searchInput.value before applySearch:', searchInput.value);
                    console.log('[SELECT SUGGESTION] isExactVenueSelection:', isExactVenueSelection);

                    // Hide dropdown
                    hideDropdown();

                    // Apply the search
                    applySearch();

                    // --- Zoom to venue on map if type is 'venue' or 'history' ---
                    if ((type === 'venue' || type === 'history') && window.MicFinderState && window.MicFinderMap) {
                        const allMics = window.MicFinderState.getAllMics();
                        // Try to find the first mic for this venue name
                        const searchTerm = type === 'venue' ? (venue || '') : (historyTerm || '');
                        const mic = allMics.find(m => m.venue && m.venue.toLowerCase() === searchTerm.toLowerCase());
                        // Simulate applying the search filter
                        const currentFilters = window.MicFinderState.getActiveFilters();
                        const testFilters = { ...currentFilters, search: searchTerm, exactVenue: searchTerm };
                        const filteredMics = window.MicFinderFilters.applyAllFilters(testFilters);
                        if (!mic || filteredMics.length === 0) {
                            // Revert search input value to previous if popup is shown
                            if (searchInput) searchInput.value = currentFilters.search || '';
                            showNoMicsTodayPopup(searchTerm);
                            return;
                        }
                        if (mic && typeof mic.lat === 'number' && typeof mic.lon === 'number') {
                            if (window.MicFinderState.getCurrentMobileView && window.MicFinderState.getCurrentMobileView() !== 'map') {
                                if (window.MicFinderMobile && window.MicFinderMobile.switchMobileView) {
                                    window.MicFinderMobile.switchMobileView('map');
                                }
                            }
                            setTimeout(() => {
                                if (window.MicFinderMap.showMicOnMap) {
                                    window.MicFinderMap.showMicOnMap(mic);
                                    if (window.MicFinderMap.scrollToListItem) {
                                        window.MicFinderMap.scrollToListItem(mic.id);
                                    }
                                } else if (window.map && window.map.setView) {
                                    window.map.setView([mic.lat, mic.lon], 14, { animate: true });
                                }
                            }, 0);
                        }
                    }
                    
                    // Reset the flag after all logic is complete
                    setTimeout(() => {
                        isExactVenueSelection = false;
                    }, 100);
                }
                
                // Hide dropdown
                function hideDropdown() {
                    const dropdown = document.getElementById('autocomplete-dropdown');
                    if (dropdown) {
                        dropdown.classList.add('hidden');
                    }
                    isDropdownVisible = false;
                    console.log('Dropdown hidden');
                    selectedIndex = -1;
                }
                
                // Handle keyboard navigation
                function handleKeydown(e) {
                    if (!isDropdownVisible) return;
                    
                    const suggestions = document.querySelectorAll('.autocomplete-suggestion');
                    
                    switch (e.key) {
                        case 'ArrowDown':
                            e.preventDefault();
                            selectedIndex = Math.min(selectedIndex + 1, suggestions.length - 1);
                            updateSelection();
                            break;
                        case 'ArrowUp':
                            e.preventDefault();
                            selectedIndex = Math.max(selectedIndex - 1, -1);
                            updateSelection();
                            break;
                        case 'Enter':
                            e.preventDefault();
                            console.log('[ENTER KEY] selectedIndex:', selectedIndex, suggestions[selectedIndex]);
                            if (selectedIndex >= 0 && suggestions[selectedIndex]) {
                                console.log('[ENTER KEY] suggestion type:', suggestions[selectedIndex].dataset.type);
                                selectSuggestion(suggestions[selectedIndex]);
                            } else {
                                applySearch();
                                hideDropdown();
                            }
                            break;
                        case 'Escape':
                            e.preventDefault();
                            hideDropdown();
                            break;
                    }
                }
                
                // Update visual selection
                function updateSelection() {
                    const suggestions = document.querySelectorAll('.autocomplete-suggestion');
                    suggestions.forEach((suggestion, index) => {
                        suggestion.classList.toggle('selected', index === selectedIndex);
                    });
                    
                    // Scroll selected item into view
                    if (selectedIndex >= 0 && suggestions[selectedIndex]) {
                        suggestions[selectedIndex].scrollIntoView({ block: 'nearest' });
                    }
                }
                
                // Keyboard navigation
                searchInput.addEventListener('keydown', handleKeydown);
                
                // Hide dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (e.target && typeof e.target.closest === 'function' && !e.target.closest('#map-search-bar')) {
                        hideDropdown();
                    }
                });
                
                // Focus handling
                searchInput.addEventListener('focus', () => {
                    const query = searchInput.value.trim();
                    if (query.length >= 2) {
                        const suggestions = generateSuggestions(query);
                        renderSuggestions(suggestions);
                    }
                });
                
                searchInput.addEventListener('blur', () => {
                    // Small delay to allow for suggestion clicks
                    setTimeout(() => {
                        if (!document.activeElement.closest('#autocomplete-dropdown')) {
                            hideDropdown();
                        }
                    }, 150);
                });
            }

            // CREATE CHECKBOXES ONCE HERE:
            createCheckboxes('location-filters', locationOptions);
            createCheckboxes('details-filters', detailOptions);
            document.getElementById('favorites-filter').innerHTML = `<label class="flex items-center cursor-pointer"><input type="checkbox" value="Show Favorites Only" class="custom-checkbox"><span class="ml-2 text-gray-200">Show Favorites Only</span></label>`;

            // Add mutual exclusivity logic to details checkboxes
            const detailsCheckboxes = document.querySelectorAll('#details-filters input[type="checkbox"]');
            detailsCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const value = this.value;
                    
                    if (this.checked) {
                        // Apply mutual exclusivity rules when checking a box
                        if (value === 'Free') {
                            // Uncheck Paid
                            const paidCheckbox = document.querySelector('#details-filters input[value="Paid"]');
                            if (paidCheckbox) paidCheckbox.checked = false;
                        } else if (value === 'Paid') {
                            // Uncheck Free
                            const freeCheckbox = document.querySelector('#details-filters input[value="Free"]');
                            if (freeCheckbox) freeCheckbox.checked = false;
                        } else if (value === 'In-person Sign-up') {
                            // Uncheck Online Sign-up
                            const onlineCheckbox = document.querySelector('#details-filters input[value="Online Sign-up"]');
                            if (onlineCheckbox) onlineCheckbox.checked = false;
                        } else if (value === 'Online Sign-up') {
                            // Uncheck In-person Sign-up
                            const inPersonCheckbox = document.querySelector('#details-filters input[value="In-person Sign-up"]');
                            if (inPersonCheckbox) inPersonCheckbox.checked = false;
                        }
                    }
                });
            });

            // Initial render of pills
            renderActivePills();

            // Clear the search filter and input field on page load
            if (window.MicFinderState && window.MicFinderFilters && window.MicFinderApp) {
                const filters = window.MicFinderState.getActiveFilters();
                let changed = false;
                if (filters.search) {
                    filters.search = '';
                    changed = true;
                }
                if (filters.exactVenue) {
                    filters.exactVenue = '';
                    changed = true;
                }
                if (changed) {
                    window.MicFinderState.setActiveFilters(filters);
                    window.MicFinderFilters.saveFilterState(filters);
                    window.MicFinderApp.render();
                }
                // Also clear the search input field
                const searchInput = document.getElementById('search-input');
                if (searchInput) searchInput.value = '';
                // Also clear the global exactVenue flag
                setExactVenueFlag(false);
            }
        });

        // Search button click handler
        const searchBtn = document.getElementById('search-btn');
        const searchInput = document.getElementById('search-input');
        if (searchBtn && searchInput) {
            searchBtn.addEventListener('click', () => {
                // Clear any pending debounced search
                clearTimeout(searchInput.searchTimeout);
                // Apply search immediately
                applySearch();
                hideDropdown();
            });
        }
        
        // Enter key handler for immediate search (when dropdown is not visible)
        if (searchInput) {
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !isDropdownVisible) {
                    e.preventDefault();
                    // Clear any pending debounced search
                    clearTimeout(searchInput.searchTimeout);
                    // Apply search immediately
                    applySearch();
                }
            });
        }

        // Mobile sidebar close button functionality
        const mobileListClose = document.getElementById('mobile-list-close');
        if (mobileListClose) {
            mobileListClose.addEventListener('click', function() {
                closeMobileSidebar();
            });
        }
        
        // Function to close mobile sidebar
        function closeMobileSidebar() {
            const rightSidebar = document.getElementById('right-sidebar');
            if (rightSidebar) {
                rightSidebar.classList.remove('mobile-open');
                rightSidebar.style.transform = 'translateX(100%)';
                // Hide after animation completes
                setTimeout(() => {
                    rightSidebar.style.display = 'none';
                }, 300);
            }
        }
        
        // Close sidebar when clicking outside (only on mobile)
        document.addEventListener('click', function(e) {
            if (window.innerWidth <= 1023) {
                const rightSidebar = document.getElementById('right-sidebar');
                const listBtn = document.getElementById('list-view-btn-mobile');
                
                if (rightSidebar && rightSidebar.classList.contains('mobile-open')) {
                    // Don't close if clicking on the sidebar itself or the list button
                    if (!rightSidebar.contains(e.target) && !listBtn.contains(e.target)) {
                        closeMobileSidebar();
                    }
                }
            }
        });

        // Add this function after searchInput is defined
        function clearSearchIfEmpty() {
            if (searchInput.value.trim().length < 2) {
                if (window.MicFinderState && window.MicFinderApp) {
                    const { setActiveFilters, getActiveFilters } = window.MicFinderState;
                    const filters = getActiveFilters();
                    const newFilters = { ...filters, search: '', exactVenue: '' };
                    setActiveFilters(newFilters);
                    if (window.MicFinderFilters && window.MicFinderFilters.saveFilterState) {
                        window.MicFinderFilters.saveFilterState(newFilters);
                    }
                    window.MicFinderApp.render();
                    renderActivePills();
                }
            }
        }
        if (searchInput) {
            searchInput.addEventListener('input', clearSearchIfEmpty);
            searchInput.addEventListener('blur', clearSearchIfEmpty);
        }
        const clearSearchBtn = document.getElementById('clear-search-btn');
        if (searchInput && clearSearchBtn) {
            // Show/hide the button based on input
            searchInput.addEventListener('input', () => {
                if (searchInput.value.trim().length > 0) {
                    clearSearchBtn.classList.remove('hidden');
                } else {
                    clearSearchBtn.classList.add('hidden');
                }
            });

            // On click, clear input and trigger clear logic
            clearSearchBtn.addEventListener('click', () => {
                searchInput.value = '';
                clearSearchBtn.classList.add('hidden');
                if (typeof clearSearchIfEmpty === 'function') {
                    clearSearchIfEmpty();
                }
                searchInput.focus();
            });
        }
        
        // Service Worker Registration for PWA functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('[PWA] Service Worker registered successfully:', registration.scope);
                        
                        // Handle updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            if (newWorker) {
                                newWorker.addEventListener('statechange', () => {
                                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                        // New content is available, notify user
                                        showUpdateNotification();
                                    }
                                });
                            }
                        });
                    })
                    .catch(error => {
                        console.warn('[PWA] Service Worker registration failed:', error);
                    });
                    
                // Listen for messages from service worker
                navigator.serviceWorker.addEventListener('message', event => {
                    if (event.data && event.data.type === 'SYNC_FAVORITES') {
                        // Handle offline favorite sync
                        console.log('[PWA] Favorites synced from offline');
                    }
                });
            });
        }
        
        // PWA Install prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('[PWA] Install prompt triggered');
            e.preventDefault();
            deferredPrompt = e;
            showInstallBanner();
        });
        
        function showInstallBanner() {
            // Create a subtle install banner
            const banner = document.createElement('div');
            banner.id = 'pwa-install-banner';
            banner.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 20px;
                right: 20px;
                background: #3b82f6;
                color: white;
                padding: 12px 16px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: space-between;
                transform: translateY(100%);
                transition: transform 0.3s ease;
                font-size: 14px;
            `;
            
            banner.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px;">
                    <i class="fa-solid fa-mobile-alt"></i>
                    <span>Install Mic Finder as an app for better experience</span>
                </div>
                <div>
                    <button onclick="installPWA()" style="background: white; color: #3b82f6; border: none; padding: 6px 12px; border-radius: 4px; margin-right: 8px; cursor: pointer; font-weight: 600;">Install</button>
                    <button onclick="dismissInstallBanner()" style="background: transparent; color: white; border: 1px solid white; padding: 6px 12px; border-radius: 4px; cursor: pointer;">Later</button>
                </div>
            `;
            
            document.body.appendChild(banner);
            setTimeout(() => banner.style.transform = 'translateY(0)', 100);
        }
        
        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    console.log('[PWA] Install choice:', choiceResult.outcome);
                    deferredPrompt = null;
                    dismissInstallBanner();
                });
            }
        }
        
        function dismissInstallBanner() {
            const banner = document.getElementById('pwa-install-banner');
            if (banner) {
                banner.style.transform = 'translateY(100%)';
                setTimeout(() => banner.remove(), 300);
            }
        }
        
        function showUpdateNotification() {
            // Create update notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #10b981;
                color: white;
                padding: 12px 16px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                transform: translateX(100%);
                transition: transform 0.3s ease;
                font-size: 14px;
                max-width: 300px;
            `;
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px;">
                    <i class="fa-solid fa-download"></i>
                    <span>New version available!</span>
                </div>
                <button onclick="refreshApp()" style="background: white; color: #10b981; border: none; padding: 4px 8px; border-radius: 4px; margin-top: 2px; cursor: pointer; font-weight: 600;">Refresh</button>
            `;
            
            document.body.appendChild(notification);
            setTimeout(() => notification.style.transform = 'translateX(0)', 100);
        }
        
        function refreshApp() {
            if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({ type: 'SKIP_WAITING' });
                window.location.reload();
            }
        }

        // Day selection popup functionality
        function openDaySelectionPopup(currentDay) {
            console.log('🗓️ [POPUP] Opening day selection popup. Current day:', currentDay);
            
            const popup = document.getElementById('day-selection-popup');
            if (!popup) {
                console.error('🗓️ [POPUP] Day selection popup not found');
                return;
            }
            
            // Mark current day as selected
            const dayOptions = popup.querySelectorAll('.day-option');
            dayOptions.forEach(option => {
                option.classList.remove('bg-blue-600');
                if (option.dataset.value === currentDay) {
                    option.classList.add('bg-blue-600');
                }
            });
            
            // Use popup manager to open the day selection popup
            popupManager.openPopup(popupManager.popupTypes.DAY_SELECTION, popup);
            
            // Show popup
            popup.classList.remove('hidden');
            
            // Set up click handlers for day options
            dayOptions.forEach(option => {
                option.onclick = function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    
                    const selectedValue = this.dataset.value;
                    const selectedText = this.textContent.trim();
                    
                    console.log('🗓️ [POPUP] Day selected:', selectedValue, selectedText);
                    
                    // Update global filters
                    if (window.MicFinderState && window.MicFinderFilters && window.MicFinderApp) {
                        const filters = window.MicFinderState.getActiveFilters();
                        filters.day = selectedValue || null;
                        window.MicFinderState.setActiveFilters(filters);
                        window.MicFinderFilters.saveFilterState(filters);
                        window.MicFinderApp.render();
                        
                        // Re-render pills to reflect changes
                        if (typeof renderActivePills === 'function') {
                            renderActivePills();
                        }
                    }
                    
                    // Close day popup
                    closeDaySelectionPopup();
                    

                };
            });
        }
        
        function closeDaySelectionPopup() {
            console.log('🗓️ [POPUP] Closing day selection popup');
            // Use popup manager to close the day selection popup
            if (popupManager.getActivePopupType() === popupManager.popupTypes.DAY_SELECTION) {
                popupManager.closeActivePopup();
            } else {
                // Fallback: close directly if popup manager isn't tracking it
                const popup = document.getElementById('day-selection-popup');
                if (popup) {
                    popup.classList.add('hidden');
                }
            }
        }


        
        // Borough selection popup functionality
        function openBoroughSelectionPopup(currentBorough) {
            console.log('🏢 [POPUP] Opening borough selection popup. Current borough:', currentBorough);
            
            const popup = document.getElementById('borough-selection-popup');
            if (!popup) {
                console.error('🏢 [POPUP] Borough selection popup not found');
                return;
            }
            
            // Mark current boroughs as selected (support multiple selections)
            const boroughOptions = popup.querySelectorAll('.borough-option');
            const currentFilters = window.MicFinderState ? window.MicFinderState.getActiveFilters() : {};
            const selectedBoroughs = currentFilters.borough || [];
            
            boroughOptions.forEach(option => {
                option.classList.remove('bg-blue-600');
                if (Array.isArray(selectedBoroughs) && selectedBoroughs.includes(option.dataset.value)) {
                    option.classList.add('bg-blue-600');
                } else if (option.dataset.value === currentBorough) {
                    option.classList.add('bg-blue-600');
                }
            });
            
            // Use popup manager to open the borough selection popup
            popupManager.openPopup(popupManager.popupTypes.BOROUGH_SELECTION, popup);
            
            // Show popup
            popup.classList.remove('hidden');
            
            // Set up click handlers for borough options
            boroughOptions.forEach(option => {
                option.onclick = function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    
                    const selectedValue = this.dataset.value;
                    const selectedText = this.textContent.trim();
                    
                    console.log('🏢 [POPUP] Borough selected:', selectedValue, selectedText);
                    
                    // Update global filters
                    if (window.MicFinderState && window.MicFinderFilters && window.MicFinderApp) {
                        const filters = window.MicFinderState.getActiveFilters();
                        
                        if (selectedValue === '') {
                            // "Any Borough" selected - clear all borough filters
                            filters.borough = [];
                        } else {
                            // Toggle borough selection (multi-select)
                            if (!Array.isArray(filters.borough)) {
                                filters.borough = [];
                            }
                            
                            if (filters.borough.includes(selectedValue)) {
                                // Remove if already selected
                                filters.borough = filters.borough.filter(b => b !== selectedValue);
                            } else {
                                // Add to selection
                                filters.borough.push(selectedValue);
                            }
                        }
                        
                        window.MicFinderState.setActiveFilters(filters);
                        window.MicFinderFilters.saveFilterState(filters);
                        window.MicFinderApp.render();
                        
                        // Re-render pills to reflect changes
                        if (typeof renderActivePills === 'function') {
                            renderActivePills();
                        }
                    }
                    
                    // Close popup
                    closeBoroughSelectionPopup();
                };
            });
        }
        
        function closeBoroughSelectionPopup() {
            console.log('🏢 [POPUP] Closing borough selection popup');
            // Use popup manager to close the borough selection popup
            if (popupManager.getActivePopupType() === popupManager.popupTypes.BOROUGH_SELECTION) {
                popupManager.closeActivePopup();
            } else {
                // Fallback: close directly if popup manager isn't tracking it
                const popup = document.getElementById('borough-selection-popup');
                if (popup) {
                    popup.classList.add('hidden');
                }
            }
        }

        // Neighborhood selection popup functionality
        function openNeighborhoodSelectionPopup(currentNeighborhood) {
            console.log('🏘️ [POPUP] Opening neighborhood selection popup. Current neighborhood:', currentNeighborhood);
            
            const popup = document.getElementById('neighborhood-selection-popup');
            if (!popup) {
                console.error('🏘️ [POPUP] Neighborhood selection popup not found');
                return;
            }
            
            // Populate neighborhood options dynamically
            populateNeighborhoodOptions();
            
            // Mark current neighborhoods as selected (support multiple selections)
            const neighborhoodOptions = popup.querySelectorAll('.neighborhood-option');
            const currentFilters = window.MicFinderState ? window.MicFinderState.getActiveFilters() : {};
            const selectedNeighborhoods = currentFilters.neighborhood || [];
            
            neighborhoodOptions.forEach(option => {
                option.classList.remove('bg-blue-600');
                if (Array.isArray(selectedNeighborhoods) && selectedNeighborhoods.includes(option.dataset.value)) {
                    option.classList.add('bg-blue-600');
                } else if (option.dataset.value === currentNeighborhood) {
                    option.classList.add('bg-blue-600');
                }
            });
            
            // Use popup manager to open the neighborhood selection popup
            popupManager.openPopup(popupManager.popupTypes.NEIGHBORHOOD_SELECTION, popup);
            
            // Show popup
            popup.classList.remove('hidden');
            
            // Set up click handlers for neighborhood options
            neighborhoodOptions.forEach(option => {
                option.onclick = function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    
                    const selectedValue = this.dataset.value;
                    const selectedText = this.textContent.trim();
                    
                    console.log('🏘️ [POPUP] Neighborhood selected:', selectedValue, selectedText);
                    
                    // Update global filters
                    if (window.MicFinderState && window.MicFinderFilters && window.MicFinderApp) {
                        const filters = window.MicFinderState.getActiveFilters();
                        
                        if (selectedValue === '') {
                            // "Any Neighborhood" selected - clear all neighborhood filters
                            filters.neighborhood = [];
                        } else {
                            // Toggle neighborhood selection (multi-select)
                            if (!Array.isArray(filters.neighborhood)) {
                                filters.neighborhood = [];
                            }
                            
                            if (filters.neighborhood.includes(selectedValue)) {
                                // Remove if already selected
                                filters.neighborhood = filters.neighborhood.filter(n => n !== selectedValue);
                            } else {
                                // Add to selection
                                filters.neighborhood.push(selectedValue);
                            }
                        }
                        
                        window.MicFinderState.setActiveFilters(filters);
                        window.MicFinderFilters.saveFilterState(filters);
                        window.MicFinderApp.render();
                        
                        // Re-render pills to reflect changes
                        if (typeof renderActivePills === 'function') {
                            renderActivePills();
                        }
                    }
                    
                    // Close popup
                    closeNeighborhoodSelectionPopup();
                };
            });
        }

        function closeNeighborhoodSelectionPopup() {
            console.log('🏘️ [POPUP] Closing neighborhood selection popup');
            // Use popup manager to close the neighborhood selection popup
            if (popupManager.getActivePopupType() === popupManager.popupTypes.NEIGHBORHOOD_SELECTION) {
                popupManager.closeActivePopup();
            } else {
                // Fallback: close directly if popup manager isn't tracking it
                const popup = document.getElementById('neighborhood-selection-popup');
                if (popup) {
                    popup.classList.add('hidden');
                }
            }
        }

        // Function to populate neighborhood options from available data
        function populateNeighborhoodOptions() {
            const container = document.getElementById('neighborhood-options');
            if (!container) return;
            
            // Get unique neighborhoods from the current mic data
            const neighborhoods = new Set();
            
            // Try to get neighborhoods from the current state
            if (window.MicFinderState && window.MicFinderState.getMicData) {
                const micData = window.MicFinderState.getMicData();
                if (micData && Array.isArray(micData)) {
                    micData.forEach(mic => {
                        if (mic.neighborhood && mic.neighborhood.trim()) {
                            neighborhoods.add(mic.neighborhood.trim());
                        }
                    });
                }
            }
            
            // If no mic data available, use some common NYC neighborhoods as fallback
            if (neighborhoods.size === 0) {
                const fallbackNeighborhoods = [
                    'West Village', 'Chelsea', 'East Village', 'Upper West Side', 'Upper East Side',
                    'Williamsburg', 'Park Slope', 'Brooklyn Heights', 'DUMBO', 'Greenpoint',
                    'Astoria', 'Long Island City', 'Forest Hills', 'Jackson Heights',
                    'Financial District', 'SoHo', 'NoHo', 'Tribeca', 'Chinatown', 'Little Italy'
                ];
                fallbackNeighborhoods.forEach(hood => neighborhoods.add(hood));
            }
            
            // Sort neighborhoods alphabetically
            const sortedNeighborhoods = Array.from(neighborhoods).sort();
            
            // Create neighborhood options
            let optionsHTML = '';
            
            // Add "Any Neighborhood" option first
            optionsHTML += '<button class="neighborhood-option w-full text-left px-4 py-3 rounded-lg text-white hover:bg-gray-700 transition-colors" data-value="">Any Neighborhood</button>';
            
            // Add individual neighborhood options
            sortedNeighborhoods.forEach(neighborhood => {
                optionsHTML += `<button class="neighborhood-option w-full text-left px-4 py-3 rounded-lg text-white hover:bg-gray-700 transition-colors" data-value="${neighborhood}">${neighborhood}</button>`;
            });
            
            container.innerHTML = optionsHTML;
        }

        // Details selection popup functionality
        function openDetailsSelectionPopup(currentDetail) {
            console.log('📝 [POPUP] Opening details selection popup. Current detail:', currentDetail);
            
            const popup = document.getElementById('details-selection-popup');
            if (!popup) {
                console.error('📝 [POPUP] Details selection popup not found');
                return;
            }
            
            // Mark current details as selected (support multiple selections with exclusivity rules)
            const detailOptions = popup.querySelectorAll('.detail-option');
            const currentFilters = window.MicFinderState ? window.MicFinderState.getActiveFilters() : {};
            const selectedCost = currentFilters.cost || [];
            const selectedSignup = currentFilters.signup || [];
            
            detailOptions.forEach(option => {
                option.classList.remove('bg-blue-600');
                const value = option.dataset.value;
                
                // Check if this option should be highlighted as selected
                if (Array.isArray(selectedCost) && selectedCost.includes(value)) {
                    option.classList.add('bg-blue-600');
                } else if (Array.isArray(selectedSignup) && selectedSignup.includes(value)) {
                    option.classList.add('bg-blue-600');
                } else if (value === currentDetail) {
                    option.classList.add('bg-blue-600');
                }
            });
            
            // Use popup manager to open the details selection popup
            popupManager.openPopup(popupManager.popupTypes.DETAILS_SELECTION, popup);
            
            // Show popup
            popup.classList.remove('hidden');
            
            // Set up click handlers for detail options
            detailOptions.forEach(option => {
                option.onclick = function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    
                    const selectedValue = this.dataset.value;
                    const selectedText = this.textContent.trim();
                    
                    console.log('📝 [POPUP] Detail selected:', selectedValue, selectedText);
                    
                    // Update global filters with mutual exclusivity logic
                    if (window.MicFinderState && window.MicFinderFilters && window.MicFinderApp) {
                        const filters = window.MicFinderState.getActiveFilters();
                        
                        if (selectedValue === '') {
                            // "Any Details" selected - clear all detail filters
                            filters.cost = [];
                            filters.signup = [];
                        } else {
                            // Initialize arrays if needed
                            if (!Array.isArray(filters.cost)) filters.cost = [];
                            if (!Array.isArray(filters.signup)) filters.signup = [];
                            
                            // Handle mutual exclusivity and toggle logic
                            if (selectedValue === 'Free' || selectedValue === 'Paid') {
                                // Cost options: Free vs Paid (mutually exclusive)
                                if (selectedValue === 'Free') {
                                    if (filters.cost.includes('Free')) {
                                        // Remove Free if already selected
                                        filters.cost = filters.cost.filter(c => c !== 'Free');
                                    } else {
                                        // Add Free and remove Paid
                                        filters.cost = filters.cost.filter(c => c !== 'Paid');
                                        filters.cost.push('Free');
                                    }
                                } else { // Paid
                                    if (filters.cost.includes('Paid')) {
                                        // Remove Paid if already selected
                                        filters.cost = filters.cost.filter(c => c !== 'Paid');
                                    } else {
                                        // Add Paid and remove Free
                                        filters.cost = filters.cost.filter(c => c !== 'Free');
                                        filters.cost.push('Paid');
                                    }
                                }
                            } else if (selectedValue === 'In-person Sign-up' || selectedValue === 'Online Sign-up') {
                                // Signup options: In-person vs Online (mutually exclusive)
                                if (selectedValue === 'In-person Sign-up') {
                                    if (filters.signup.includes('In-person Sign-up')) {
                                        // Remove In-person if already selected
                                        filters.signup = filters.signup.filter(s => s !== 'In-person Sign-up');
                                    } else {
                                        // Add In-person and remove Online
                                        filters.signup = filters.signup.filter(s => s !== 'Online Sign-up');
                                        filters.signup.push('In-person Sign-up');
                                    }
                                } else { // Online Sign-up
                                    if (filters.signup.includes('Online Sign-up')) {
                                        // Remove Online if already selected
                                        filters.signup = filters.signup.filter(s => s !== 'Online Sign-up');
                                    } else {
                                        // Add Online and remove In-person
                                        filters.signup = filters.signup.filter(s => s !== 'In-person Sign-up');
                                        filters.signup.push('Online Sign-up');
                                    }
                                }
                            } else if (selectedValue === '1 Item Min') {
                                // 1 Item Min can be toggled independently
                                if (filters.cost.includes('1 Item Min')) {
                                    filters.cost = filters.cost.filter(c => c !== '1 Item Min');
                                } else {
                                    filters.cost.push('1 Item Min');
                                }
                            }
                        }
                        
                        window.MicFinderState.setActiveFilters(filters);
                        window.MicFinderFilters.saveFilterState(filters);
                        window.MicFinderApp.render();
                        
                        // Re-render pills to reflect changes
                        if (typeof renderActivePills === 'function') {
                            renderActivePills();
                        }
                    }
                    
                    // Close popup
                    closeDetailsSelectionPopup();
                };
            });
        }
        
        function closeDetailsSelectionPopup() {
            console.log('📝 [POPUP] Closing details selection popup');
            // Use popup manager to close the details selection popup
            if (popupManager.getActivePopupType() === popupManager.popupTypes.DETAILS_SELECTION) {
                popupManager.closeActivePopup();
            } else {
                // Fallback: close directly if popup manager isn't tracking it
                const popup = document.getElementById('details-selection-popup');
                if (popup) {
                    popup.classList.add('hidden');
                }
            }
        }

        // Make functions globally available
        window.openDaySelectionPopup = openDaySelectionPopup;
        window.closeDaySelectionPopup = closeDaySelectionPopup;
        window.openBoroughSelectionPopup = openBoroughSelectionPopup;
        window.openNeighborhoodSelectionPopup = openNeighborhoodSelectionPopup;
        window.closeBoroughSelectionPopup = closeBoroughSelectionPopup;
        window.openDetailsSelectionPopup = openDetailsSelectionPopup;
        window.closeDetailsSelectionPopup = closeDetailsSelectionPopup;
        
        // Set up popup event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Day popup listeners
            const dayPopup = document.getElementById('day-selection-popup');
            const dayCloseBtn = document.getElementById('close-day-popup');
            
            // Day close button
            if (dayCloseBtn) {
                dayCloseBtn.addEventListener('click', closeDaySelectionPopup);
            }
            
            // Day close on outside click - now handled by popup manager

            // Borough popup listeners
            const boroughPopup = document.getElementById('borough-selection-popup');
            const boroughCloseBtn = document.getElementById('close-borough-popup');
            
            // Borough close button
            if (boroughCloseBtn) {
                boroughCloseBtn.addEventListener('click', closeBoroughSelectionPopup);
            }
            
            // Borough close on outside click - now handled by popup manager

            // Neighborhood popup listeners
            const neighborhoodPopup = document.getElementById('neighborhood-selection-popup');
            const neighborhoodCloseBtn = document.getElementById('close-neighborhood-popup');
            
            // Neighborhood close button
            if (neighborhoodCloseBtn) {
                neighborhoodCloseBtn.addEventListener('click', closeNeighborhoodSelectionPopup);
            }
            
            // Neighborhood close on outside click - now handled by popup manager

            // Details popup listeners
            const detailsPopup = document.getElementById('details-selection-popup');
            const detailsCloseBtn = document.getElementById('close-details-popup');
            
            // Details close button
            if (detailsCloseBtn) {
                detailsCloseBtn.addEventListener('click', closeDetailsSelectionPopup);
            }
            
            // Details close on outside click - now handled by popup manager
            
            // Close on escape key - now handled by popup manager
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    popupManager.closeActivePopup();
                }
            });
        });

        // Old dropdown code removed - now using popup
        
        // Essential debug functions for testing
        window.debugDayPopup = function() {
            const dayPills = document.querySelectorAll('.pill[data-type="day"]');
            console.log('🧪 Testing day popup functionality...');
            console.log('Day pills found:', dayPills.length);
            if (dayPills.length > 0) {
                const firstPill = dayPills[0];
                console.log('Clicking first day pill to open popup...');
                firstPill.click();
            } else {
                console.log('No day pills found. Manually testing popup...');
                openDaySelectionPopup('Thursday');
            }
        };
        
        // Check pill container visibility
        window.checkPillContainers = function() {
            const desktop = document.getElementById('active-pills-row');
            const mobile = document.getElementById('active-pills-row-mobile');
            const desktopParent = desktop ? desktop.closest('.hidden.lg\\:flex') : null;
            const mobileParent = mobile ? mobile.closest('.lg\\:hidden') : null;
            
            console.log('🔍 PILL CONTAINER VISIBILITY CHECK');
            console.log('Window width:', window.innerWidth);
            console.log('Desktop container parent:', !!desktopParent);
            console.log('Mobile container parent:', !!mobileParent);
            
            if (desktopParent) {
                const style = getComputedStyle(desktopParent);
                console.log('Desktop parent display:', style.display);
            }
            
            if (mobileParent) {
                const style = getComputedStyle(mobileParent);
                console.log('Mobile parent display:', style.display);
            }
            
            console.log('Desktop pills:', desktop ? desktop.children.length : 0);
            console.log('Mobile pills:', mobile ? mobile.children.length : 0);
        };

        // Debug neighborhood functionality
        window.debugNeighborhood = function() {
            console.log('🏘️ Testing neighborhood functionality...');
            
            // Test popup creation
            const popup = document.getElementById('neighborhood-selection-popup');
            console.log('Neighborhood popup found:', !!popup);
            
            // Test function availability
            console.log('openNeighborhoodSelectionPopup function:', typeof openNeighborhoodSelectionPopup);
            console.log('closeNeighborhoodSelectionPopup function:', typeof closeNeighborhoodSelectionPopup);
            console.log('populateNeighborhoodOptions function:', typeof populateNeighborhoodOptions);
            
            // Test populating options
            if (typeof populateNeighborhoodOptions === 'function') {
                console.log('Calling populateNeighborhoodOptions...');
                populateNeighborhoodOptions();
                
                const options = document.querySelectorAll('.neighborhood-option');
                console.log('Neighborhood options created:', options.length);
                options.forEach((option, index) => {
                    console.log(`Option ${index + 1}:`, option.textContent.trim(), 'Value:', option.dataset.value);
                });
            }
            
            // Test opening popup
            if (typeof openNeighborhoodSelectionPopup === 'function') {
                console.log('Opening neighborhood popup...');
                openNeighborhoodSelectionPopup('Test Neighborhood');
            }
        };

        // Test adding a neighborhood filter
        window.testNeighborhoodFilter = function() {
            console.log('🧪 Testing neighborhood filter addition...');
            
            if (window.MicFinderState && window.MicFinderFilters && window.MicFinderApp) {
                const filters = window.MicFinderState.getActiveFilters();
                
                // Add a test neighborhood
                if (!Array.isArray(filters.neighborhood)) {
                    filters.neighborhood = [];
                }
                filters.neighborhood.push('Greenwich Village');
                
                console.log('Updated filters:', filters);
                
                // Apply the filter
                window.MicFinderState.setActiveFilters(filters);
                window.MicFinderFilters.saveFilterState(filters);
                window.MicFinderApp.render();
                
                // Re-render pills
                if (typeof renderActivePills === 'function') {
                    renderActivePills();
                }
                
                console.log('✅ Neighborhood filter added and pills should be re-rendered');
            } else {
                console.error('❌ MicFinderState, MicFinderFilters, or MicFinderApp not available');
            }
        };
        
        // Legacy function name for compatibility
        window.debugDayDropdown = window.debugDayPopup;
        
        // Quick health check function
        window.checkDayPillHealth = function() {
            console.log('🏥 DAY PILL HEALTH CHECK');
            console.log('✅ toggleDayDropdown function:', typeof window.toggleDayDropdown);
            console.log('✅ renderActivePills function:', typeof renderActivePills);
            console.log('✅ MicFinderState:', !!window.MicFinderState);
            console.log('✅ MicFinderApp:', !!window.MicFinderApp);
            
            const dayPills = document.querySelectorAll('.pill[data-type="day"]');
            console.log('✅ Day pills in DOM:', dayPills.length);
            
            const dropdowns = document.querySelectorAll('.pill-dropdown');
            console.log('✅ Dropdowns in DOM:', dropdowns.length);
            
            console.log('🏥 Health check complete!');
        };

        // Final comprehensive test function to verify all fixes
        window.testAllFixes = function() {
            console.log('🧪 FINAL COMPREHENSIVE TEST');
            
            // Test mobile container visibility
            const mobileContainer = document.getElementById('active-pills-row-mobile');
            const mobileParent = mobileContainer ? mobileContainer.closest('.mobile-pills-row') : null;
            
            console.log('📱 Mobile container tests:');
            console.log('  Container exists:', !!mobileContainer);
            console.log('  Parent exists:', !!mobileParent);
            
            if (mobileParent) {
                const parentStyles = getComputedStyle(mobileParent);
                console.log('  Parent display:', parentStyles.display);
                console.log('  Parent visibility:', parentStyles.visibility);
                console.log('  Parent has lg:hidden:', mobileParent.classList.contains('lg:hidden'));
            }
            
            if (mobileContainer) {
                const containerStyles = getComputedStyle(mobileContainer);
                console.log('  Container display:', containerStyles.display);
                console.log('  Container visibility:', containerStyles.visibility);
                const rect = mobileContainer.getBoundingClientRect();
                console.log('  Container dimensions:', `${rect.width}x${rect.height}`);
            }
            
            // Test day pill popup functionality
            const dayPills = document.querySelectorAll('.pill[data-type="day"]');
            const popup = document.getElementById('day-selection-popup');
            console.log('🗓️ Day pill tests:');
            console.log('  Day pills found:', dayPills.length);
            console.log('  Day popup exists:', !!popup);
            
            if (dayPills.length > 0) {
                const firstPill = dayPills[0];
                console.log('  Testing popup click...');
                firstPill.click();
                
                setTimeout(() => {
                    const isPopupVisible = popup && !popup.classList.contains('hidden');
                    console.log('  Popup opened:', isPopupVisible);
                    
                    if (isPopupVisible) {
                        console.log('✅ Day pill popup functionality working!');
                        // Close it
                        closeDaySelectionPopup();
                    } else {
                        console.log('❌ Day pill popup not working');
                    }
                }, 100);
            } else {
                console.log('  No day pills found, testing popup directly...');
                openDaySelectionPopup('Thursday');
                setTimeout(() => {
                    const isPopupVisible = popup && !popup.classList.contains('hidden');
                    console.log('  Direct popup test:', isPopupVisible ? 'Success' : 'Failed');
                    if (isPopupVisible) {
                        closeDaySelectionPopup();
                    }
                }, 100);
            }
            
            console.log('🧪 Final test complete!');
        };
        
        // Legacy test function for backward compatibility
        window.testDayPillOptimizations = function() {
            console.log('🧪 TESTING DAY PILL OPTIMIZATIONS');
            
            // Test throttling
            console.log('⏱️ Testing renderActivePills throttling...');
            const startTime = performance.now();
            for (let i = 0; i < 10; i++) {
                renderActivePills();
            }
            const endTime = performance.now();
            console.log(`✅ Called renderActivePills 10 times in ${(endTime - startTime).toFixed(2)}ms`);
            
            // Test day pill functionality
            const dayPills = document.querySelectorAll('.pill[data-type="day"]');
            console.log(`✅ Found ${dayPills.length} day pills`);
            
            if (dayPills.length > 0) {
                console.log('🖱️ Testing day pill click...');
                const firstPill = dayPills[0];
                console.log('🖱️ First pill element:', firstPill);
                console.log('🖱️ First pill has dropdown:', !!firstPill.querySelector('.pill-dropdown'));
                console.log('🖱️ First pill data-type:', firstPill.getAttribute('data-type'));
                
                firstPill.click();
                
                setTimeout(() => {
                    const visibleDropdown = document.querySelector('.pill-dropdown.visible');
                    const allDropdowns = document.querySelectorAll('.pill-dropdown');
                    console.log('🖱️ All dropdowns found:', allDropdowns.length);
                    console.log('🖱️ Visible dropdowns found:', visibleDropdown ? 1 : 0);
                    
                    if (visibleDropdown) {
                        console.log('✅ Day pill dropdown opened successfully');
                        // Close it
                        firstPill.click();
                        setTimeout(() => {
                            const stillVisible = document.querySelector('.pill-dropdown.visible');
                            if (!stillVisible) {
                                console.log('✅ Day pill dropdown closed successfully');
                            } else {
                                console.log('⚠️ Day pill dropdown did not close');
                            }
                        }, 200);
                    } else {
                        console.log('⚠️ Day pill dropdown did not open');
                        // Debug: check the dropdown state
                        if (allDropdowns.length > 0) {
                            console.log('🖱️ Checking dropdown classes:', allDropdowns[0].className);
                        }
                    }
                }, 200);
            }
            
            // Test mobile container sizing
            const mapContainer = document.getElementById('map');
            if (mapContainer) {
                const rect = mapContainer.getBoundingClientRect();
                console.log(`📱 Map container size: ${rect.width}x${rect.height}`);
                if (rect.width > 0 && rect.height > 0) {
                    console.log('✅ Mobile container sizing fixed');
                } else {
                    console.log('⚠️ Mobile container still has zero dimensions');
                }
            }
            
            console.log('🧪 Optimization tests complete!');
        };
        
        // Test function to verify complete integration
        window.testDayPillFunctionality = function() {
            console.log('🧪 Testing integrated day pill functionality...');
            
            // Test full integration with app render cycle
            if (window.MicFinderState && window.MicFinderApp) {
                console.log('✅ MicFinderState and MicFinderApp available');
                
                    const currentFilters = window.MicFinderState.getActiveFilters();
                console.log('📊 Current filters:', currentFilters);
                
                const testFilters = { ...currentFilters, day: 'Wednesday' };
                console.log('🔄 Setting day filter to Wednesday via app render...');
                
                // Use the proper app render cycle
                window.MicFinderState.setActiveFilters(testFilters);
                window.MicFinderFilters.saveFilterState(testFilters);
                window.MicFinderApp.render(); // This should call renderActivePills automatically
                
                setTimeout(() => {
                    const dayPills = document.querySelectorAll('.pill[data-type="day"]');
                    console.log('✅ Day pills created via app render:', dayPills.length);
                    
                    if (dayPills.length > 0) {
                        const pill = dayPills[0];
                        console.log('🔄 Testing dropdown functionality...');
                        
                        // Test dropdown
                        pill.click();
                        
                        setTimeout(() => {
                            const visibleDropdown = document.querySelector('.pill-dropdown.visible');
                            if (visibleDropdown) {
                                console.log('✅ Dropdown visible!');
                                const options = visibleDropdown.querySelectorAll('.dropdown-option');
                                console.log('✅ Options found:', options.length);
                                
                                // Test option selection
                                const fridayOption = Array.from(options).find(opt => opt.textContent.includes('Friday'));
                                if (fridayOption) {
                                    console.log('🔄 Clicking Friday option...');
                                    fridayOption.click();
                                    
                                    setTimeout(() => {
                                        // Check if filter was updated in state
                                        const newFilters = window.MicFinderState.getActiveFilters();
                                        if (newFilters.day === 'Friday') {
                                            console.log('✅ SUCCESS: State updated correctly!');
                                            console.log('✅ SUCCESS: Complete integration working!');
                                        } else {
                                            console.log('❌ FAILED: State not updated. Current day filter:', newFilters.day);
                                        }
                                    }, 200);
                                }
                            } else {
                                console.log('❌ FAILED: Dropdown not visible');
                                window.forceCreateDayPill();
                            }
                        }, 200);
                    } else {
                        console.log('❌ No day pills found via app render, trying manual creation...');
                        window.forceCreateDayPill();
                    }
                }, 1000);
            } else {
                console.log('❌ Required modules not available, testing manual pill...');
                window.forceCreateDayPill();
            }
        };
        
        // Force create a day pill for testing
        window.forceCreateDayPill = function() {
            const pillsContainer = document.getElementById('active-pills-row') || document.getElementById('active-pills-row-mobile');
            if (!pillsContainer) {
                console.log('❌ No pills container found');
                return;
            }
            
            console.log('🔧 Creating manual test day pill...');
            const pill = document.createElement('button');
            pill.className = 'pill active-pill-item bg-gray-900/80 backdrop-blur-sm text-white border-white/10 shadow-md';
            pill.setAttribute('data-type', 'day');
            pill.classList.add('day-filter-pill');
            
            pill.innerHTML = `
                Wednesday 
                <i class="fa-solid fa-chevron-down pill-edit-icon"></i>
                <div class="pill-dropdown">
                    <div class="dropdown-option" data-value="Monday">Monday <i class="fa-solid fa-check dropdown-option-check"></i></div>
                    <div class="dropdown-option" data-value="Tuesday">Tuesday <i class="fa-solid fa-check dropdown-option-check"></i></div>
                    <div class="dropdown-option selected" data-value="Wednesday">Wednesday <i class="fa-solid fa-check dropdown-option-check"></i></div>
                    <div class="dropdown-option" data-value="Thursday">Thursday <i class="fa-solid fa-check dropdown-option-check"></i></div>
                    <div class="dropdown-option" data-value="Friday">Friday <i class="fa-solid fa-check dropdown-option-check"></i></div>
                    <div class="dropdown-option" data-value="Saturday">Saturday <i class="fa-solid fa-check dropdown-option-check"></i></div>
                    <div class="dropdown-option" data-value="Sunday">Sunday <i class="fa-solid fa-check dropdown-option-check"></i></div>
                    <div class="dropdown-option" data-value="">Any Day <i class="fa-solid fa-check dropdown-option-check"></i></div>
                </div>
            `;
            
            pill.addEventListener('click', (e) => {
                e.stopPropagation();
                e.preventDefault();
                console.log('🗓️ [MANUAL TEST] Day pill clicked!');
                window.toggleDayDropdown(pill);
            });
            
            pillsContainer.appendChild(pill);
            console.log('✅ Manual test day pill created');
            
            // Auto-test it after creation
            setTimeout(() => {
                console.log('🔄 Auto-testing manual pill...');
                pill.click();
            }, 100);
        };

        document.addEventListener('DOMContentLoaded', function() {
            // Pills should now work normally without forced debug state
            
            // Initialize sidebar visibility based on current screen size
            const rightSidebar = document.getElementById('right-sidebar');
            if (rightSidebar) {
                if (window.innerWidth >= 1024) {
                    // Desktop view - ensure sidebar is visible
                    rightSidebar.style.display = 'flex';
                    rightSidebar.classList.remove('mobile-open');
                    // Reset any mobile-specific styles that might have been applied
                    rightSidebar.style.transform = '';
                    rightSidebar.style.position = '';
                    rightSidebar.style.top = '';
                    rightSidebar.style.right = '';
                    rightSidebar.style.bottom = '';
                    rightSidebar.style.width = '';
                    rightSidebar.style.zIndex = '';
                    rightSidebar.style.transition = '';
                } else {
                    // Mobile view - hide sidebar initially
                    rightSidebar.style.display = 'none';
                }
            }
            
            // Debug pill container dimensions and RIGHT-SIDE overflow
            function debugPillContainer() {
                const container = document.getElementById('active-pills-row-mobile');
                if (container) {
                    const containerRect = container.getBoundingClientRect();
                    const viewportWidth = window.innerWidth;
                    
                    console.log('=== PILLS RIGHT-SIDE OVERFLOW DEBUG ===');
                    console.log('[Pills Debug] Viewport width:', viewportWidth + 'px');
                    console.log('[Pills Debug] Container dimensions:', {
                        width: container.offsetWidth,
                        scrollWidth: container.scrollWidth,
                        clientWidth: container.clientWidth,
                        containerRect: {
                            left: containerRect.left,
                            right: containerRect.right,
                            width: containerRect.width
                        }
                    });
                    
                    const pills = container.querySelectorAll('.pill');
                    console.log('[Pills Debug] Pills count:', pills.length);
                    
                    let totalPillWidth = 0;
                    let pillsOverflowingRight = [];
                    let visiblePills = [];
                    
                    pills.forEach((pill, index) => {
                        const pillRect = pill.getBoundingClientRect();
                        const pillWidth = pill.offsetWidth;
                        totalPillWidth += pillWidth;
                        
                        // Check if pill extends beyond RIGHT edge of viewport
                        const isOverflowingRight = pillRect.right > viewportWidth;
                        // Check if pill is visible (at least partially)
                        const isVisible = pillRect.left < viewportWidth && pillRect.right > 0;
                        
                        if (isOverflowingRight) {
                            pillsOverflowingRight.push({
                                index,
                                text: pill.textContent,
                                pillRight: pillRect.right,
                                overflowAmount: pillRect.right - viewportWidth
                            });
                        }
                        
                        if (isVisible) {
                            visiblePills.push({
                                index,
                                text: pill.textContent,
                                left: pillRect.left,
                                right: pillRect.right
                            });
                        }
                        
                        console.log(`[Pills Debug] Pill ${index}: "${pill.textContent}" - Width: ${pillWidth}px, Right edge: ${pillRect.right}px, Overflowing right: ${isOverflowingRight}`);
                    });
                    
                    console.log('[Pills Debug] RIGHT OVERFLOW ANALYSIS:');
                    console.log('- Total pills width:', totalPillWidth + 'px');
                    console.log('- Pills overflowing RIGHT:', pillsOverflowingRight.length);
                    console.log('- Pills currently visible:', visiblePills.length);
                    
                    if (pillsOverflowingRight.length > 0) {
                        console.log('[Pills Debug] PILLS CUT OFF ON RIGHT:', pillsOverflowingRight);
                    }
                    
                    // Scroll analysis
                    const maxScrollLeft = container.scrollWidth - container.clientWidth;
                    const scrollProgress = maxScrollLeft > 0 ? (container.scrollLeft / maxScrollLeft) * 100 : 0;
                    
                    console.log('[Pills Debug] SCROLL STATUS:');
                    console.log('- Current scroll position:', container.scrollLeft + 'px');
                    console.log('- Maximum scroll distance:', maxScrollLeft + 'px');
                    console.log('- Scroll progress:', scrollProgress.toFixed(1) + '%');
                    console.log('- Can scroll more right:', container.scrollLeft < maxScrollLeft);
                    
                    // Container overflow analysis
                    const isOverflowing = container.scrollWidth > container.clientWidth;
                    const leftOverflowAmount = isOverflowing ? container.scrollWidth - container.clientWidth : 0;
                    
                    console.log('[Pills Debug] CONTAINER OVERFLOW:');
                    console.log('- Container overflowing:', isOverflowing ? 'YES' : 'NO');
                    console.log('- Left overflow amount:', leftOverflowAmount + 'px');
                    console.log('- Overflow-x style:', getComputedStyle(container).overflowX);
                    console.log('- Direction style:', getComputedStyle(container).direction);
                    
                    // Visual boundary check
                    console.log('[Pills Debug] BOUNDARY CHECK:');
                    console.log('- Container starts at:', containerRect.left + 'px from left edge');
                    console.log('- Container ends at:', containerRect.right + 'px from left edge');
                    console.log('- Content extends from:', (containerRect.right - container.scrollWidth) + 'px from left edge');
                    
                    return {
                        pillsOverflowingRight,
                        canScrollLeft: container.scrollLeft > 0,
                        totalOverflow: leftOverflowAmount
                    };
                }
            }
            
            // Debug pill styling
            function debugPillStyling() {
                console.log('[Pill Styling Debug] Checking mobile pill styles...');
                const pills = document.querySelectorAll('.pill');
                console.log('[Pill Styling Debug] Found pills:', pills.length);
                
                pills.forEach((pill, index) => {
                    const computedStyles = getComputedStyle(pill);
                    console.log(`[Pill Styling Debug] Pill ${index}:`, {
                        text: pill.textContent,
                        classes: pill.className,
                        background: computedStyles.background,
                        backgroundColor: computedStyles.backgroundColor,
                        backgroundImage: computedStyles.backgroundImage,
                        backdropFilter: computedStyles.backdropFilter,
                        boxShadow: computedStyles.boxShadow,
                        color: computedStyles.color,
                        hasGradient: computedStyles.background.includes('linear-gradient') || computedStyles.backgroundImage.includes('linear-gradient')
                    });
                });
            }
            
            // Force apply styles test for mobile pills
            function forceApplyPillStyles() {
                console.log('[Force Pill Styles] Attempting to force apply gradient styles...');
                const pills = document.querySelectorAll('.pill');
                pills.forEach((pill, index) => {
                    console.log(`[Force Pill Styles] Pill ${index} before:`, {
                        background: getComputedStyle(pill).background,
                        backgroundColor: getComputedStyle(pill).backgroundColor
                    });
                    
                    // Try to force apply the gradient
                    pill.style.setProperty('background', 'linear-gradient(90deg, #444857 0%, #232533 100%)', 'important');
                    pill.style.setProperty('color', '#fff', 'important');
                    pill.style.setProperty('backdrop-filter', 'none', 'important');
                    pill.style.setProperty('box-shadow', 'none', 'important');
                    
                    console.log(`[Force Pill Styles] Pill ${index} after:`, {
                        background: getComputedStyle(pill).background,
                        backgroundColor: getComputedStyle(pill).backgroundColor
                    });
                });
            }
            
            // Debug on load and when pills are updated
            setTimeout(debugPillContainer, 1000);
            setTimeout(() => {
                debugPillStyling();
                forceApplyPillStyles();
                if (window.testPillBarriers) {
                    window.testPillBarriers();
                }
            }, 1500);
            window.addEventListener('resize', debugPillContainer);
            
            // Handle sidebar visibility on window resize
            window.addEventListener('resize', function() {
                const rightSidebar = document.getElementById('right-sidebar');
                if (rightSidebar) {
                    if (window.innerWidth >= 1024) {
                        // Desktop view - ensure sidebar is visible
                        rightSidebar.style.display = 'flex';
                        rightSidebar.classList.remove('mobile-open');
                        // Reset any mobile-specific transforms
                        rightSidebar.style.transform = '';
                        rightSidebar.style.position = '';
                        rightSidebar.style.top = '';
                        rightSidebar.style.right = '';
                        rightSidebar.style.bottom = '';
                        rightSidebar.style.width = '';
                        rightSidebar.style.zIndex = '';
                        rightSidebar.style.transition = '';
                    } else {
                        // Mobile view - hide sidebar unless explicitly opened
                        if (!rightSidebar.classList.contains('mobile-open')) {
                            rightSidebar.style.display = 'none';
                        }
                    }
                }
            });
            
            // Add real-time scroll debugging
            const container = document.getElementById('active-pills-row-mobile');
            if (container) {
                container.addEventListener('scroll', function() {
                    const maxScrollLeft = this.scrollWidth - this.clientWidth;
                    const scrollProgress = maxScrollLeft > 0 ? (this.scrollLeft / maxScrollLeft) * 100 : 0;
                    console.log('[Pills Scroll] Position:', this.scrollLeft + 'px, Progress:', scrollProgress.toFixed(1) + '%, Can scroll more right:', this.scrollLeft < maxScrollLeft);
                });
                
                // Add touch/mouse interaction debugging
                container.addEventListener('touchstart', () => console.log('[Pills Touch] Touch scroll started'), { passive: true });
                container.addEventListener('touchend', () => console.log('[Pills Touch] Touch scroll ended'), { passive: true });
                container.addEventListener('mousedown', () => console.log('[Pills Mouse] Mouse scroll started'), { passive: true });
                container.addEventListener('mouseup', () => console.log('[Pills Mouse] Mouse scroll ended'), { passive: true });
            }
            
            // Expose debug function globally
            window.debugPills = debugPillContainer;
            
            // Add mobile pills layout test function
            window.testMobilePillsLayout = function() {
                console.log('[MOBILE PILLS TEST] === MANUAL LAYOUT TEST ===');
                const pillsRowMobile = document.getElementById('active-pills-row-mobile');
                const allFiltersBtn = pillsRowMobile?.querySelector('#modal-button-mobile');
                
                if (!pillsRowMobile) {
                    console.error('[MOBILE PILLS TEST] ❌ Pills row mobile not found');
                    return;
                }
                
                console.log('[MOBILE PILLS TEST] Main container:', {
                    width: pillsRowMobile.offsetWidth,
                    scrollWidth: pillsRowMobile.scrollWidth,
                    clientWidth: pillsRowMobile.clientWidth,
                    overflow: getComputedStyle(pillsRowMobile).overflow
                });
                
                if (allFiltersBtn) {
                    const btnRect = allFiltersBtn.getBoundingClientRect();
                    console.log('[MOBILE PILLS TEST] All Filters button:', {
                        left: btnRect.left,
                        right: btnRect.right,
                        width: btnRect.width,
                        position: getComputedStyle(allFiltersBtn).position
                    });
                } else {
                    console.error('[MOBILE PILLS TEST] ❌ All Filters button not found');
                }
                
                const pills = pillsRowMobile.querySelectorAll('.pill');
                console.log('[MOBILE PILLS TEST] Pills container:', {
                    left: pillsRowMobile.getBoundingClientRect().left,
                    right: pillsRowMobile.getBoundingClientRect().right,
                    width: pillsRowMobile.getBoundingClientRect().width,
                    scrollWidth: pillsRowMobile.scrollWidth,
                    clientWidth: pillsRowMobile.clientWidth,
                    canScroll: pillsRowMobile.scrollWidth > pillsRowMobile.clientWidth,
                    paddingLeft: getComputedStyle(pillsRowMobile).paddingLeft,
                    flex: getComputedStyle(pillsRowMobile).flex
                });
                
                console.log('[MOBILE PILLS TEST] Pills count:', pills.length);
                
                if (pills.length > 0) {
                    const firstPill = pills[0];
                    const firstPillRect = firstPill.getBoundingClientRect();
                    console.log('[MOBILE PILLS TEST] First pill:', {
                        left: firstPillRect.left,
                        right: firstPillRect.right,
                        width: firstPillRect.width,
                        text: firstPill.textContent.trim()
                    });
                    
                    // Test scroll behavior
                    console.log('[MOBILE PILLS TEST] Testing scroll behavior...');
                    const originalScrollLeft = pillsRowMobile.scrollLeft;
                    pillsRowMobile.scrollLeft = 0;
                    console.log('[MOBILE PILLS TEST] After scrolling to start:', {
                        scrollLeft: pillsRowMobile.scrollLeft,
                        firstPillLeft: firstPill.getBoundingClientRect().left
                    });
                    
                    // Check overlap after scroll
                    if (allFiltersBtn) {
                        const btnRect = allFiltersBtn.getBoundingClientRect();
                        const firstPillRectAfterScroll = firstPill.getBoundingClientRect();
                        const canOverlap = firstPillRectAfterScroll.left < btnRect.right;
                        console.log('[MOBILE PILLS TEST] After scroll to start - can overlap?', canOverlap);
                        
                        if (canOverlap) {
                            console.error('[MOBILE PILLS TEST] ❌ FAILED: First pill can still overlap after scrolling to start!');
                        } else {
                            console.log('[MOBILE PILLS TEST] ✅ PASSED: First pill cannot overlap after scrolling to start');
                        }
                    }
                    
                    // Restore original scroll position
                    pillsRowMobile.scrollLeft = originalScrollLeft;
                }
            };
            
            // Add scroll test function for RIGHT scrolling
            window.testPillScroll = function() {
                const container = document.getElementById('active-pills-row-mobile');
                if (container) {
                    console.log('[Pills Test] Testing scroll to right...');
                    container.scrollBy({left: 100, behavior: 'smooth'});
                    setTimeout(() => {
                        console.log('[Pills Test] Current scroll position:', container.scrollLeft);
                    }, 500);
                }
            };
            
            // Comprehensive barrier test function
            window.testPillBarriers = function() {
                const container = document.getElementById('active-pills-row-mobile');
                
                console.log('=== BARRIER REMOVAL TEST ===');
                
                if (container) {
                    const containerStyle = getComputedStyle(container);
                    console.log('[Barrier Test] Container overflow-x:', containerStyle.overflowX);
                    console.log('[Barrier Test] Container padding-right:', containerStyle.paddingRight);
                    console.log('[Barrier Test] Container max-width:', containerStyle.maxWidth);
                    console.log('[Barrier Test] Container width:', containerStyle.width);
                    console.log('[Barrier Test] Container scrollWidth:', container.scrollWidth);
                    console.log('[Barrier Test] Container clientWidth:', container.clientWidth);
                }
                
                // Test if scrolling is possible
                if (container && container.scrollWidth > container.clientWidth) {
                    console.log('[Barrier Test] ✅ Container can scroll horizontally');
                    console.log('[Barrier Test] Max scroll distance:', container.scrollWidth - container.clientWidth);
                } else {
                    console.log('[Barrier Test] ❌ Container cannot scroll horizontally');
                }
            };
            
            // Add visual right-overflow indicator
            // function addRightOverflowIndicator() {
            //     const container = document.getElementById('active-pills-row-mobile');
            //     if (container && container.scrollWidth > container.clientWidth) {
            //         // Create visual indicator that content extends to the right
            //         const indicator = document.createElement('div');
            //         indicator.id = 'right-overflow-indicator';
            //         indicator.style.cssText = `
            //             position: absolute;
            //             right: 0;
            //             top: 0;
            //             width: 20px;
            //             height: 100%;
            //             background: linear-gradient(to right, transparent, rgba(0, 255, 0, 0.7));
            //             pointer-events: none;
            //             z-index: 100;
            //             border: 2px solid lime;
            //         `;
            //         indicator.textContent = '→';
            //         indicator.style.display = 'flex';
            //         indicator.style.alignItems = 'center';
            //         indicator.style.justifyContent = 'center';
            //         indicator.style.color = 'lime';
            //         indicator.style.fontWeight = 'bold';
            //         container.parentElement.style.position = 'relative';
            //         container.parentElement.appendChild(indicator);
            //         console.log('[Pills Debug] Added right overflow indicator');
            //     }
            // }
            
            // setTimeout(addRightOverflowIndicator, 1500);
            
            // Log computed background color for #search-and-filters-row
            var searchRow = document.getElementById('search-and-filters-row');
            if (searchRow) {
                var style = window.getComputedStyle(searchRow);
                console.log('[DEBUG] #search-and-filters-row background:', style.background, style.backgroundColor);
                console.log('[DEBUG] #search-and-filters-row classes:', searchRow.className);
                console.log('[DEBUG] #search-and-filters-row rect:', searchRow.getBoundingClientRect());
                if (searchRow.parentElement) {
                    var parentStyle = window.getComputedStyle(searchRow.parentElement);
                    console.log('[DEBUG] Parent of #search-and-filters-row background:', parentStyle.background, parentStyle.backgroundColor);
                    console.log('[DEBUG] Parent tag:', searchRow.parentElement.tagName, 'classes:', searchRow.parentElement.className);
                }
            }
            // Log computed background color for body
            var bodyStyle = window.getComputedStyle(document.body);
            console.log('[DEBUG] body background:', bodyStyle.background, bodyStyle.backgroundColor);
            // Log main if present
            var main = document.querySelector('main');
            if (main) {
                var mainStyle = window.getComputedStyle(main);
                console.log('[DEBUG] main background:', mainStyle.background, mainStyle.backgroundColor);
                console.log('[DEBUG] main classes:', main.className);
            }
        });

        // --- Bottom Bar Mobile Button Functionality ---
        document.addEventListener('DOMContentLoaded', function() {
            // Favorites button
            const favBtn = document.getElementById('favorites-btn-mobile');
            if (favBtn) {
                function updateMobileFavoritesIcon() {
                    if (window.MicFinderState) {
                        const filters = window.MicFinderState.getActiveFilters();
                        const icon = favBtn.querySelector('i');
                        if (icon) {
                            if (filters.showFavorites) {
                                icon.className = 'fa-solid fa-star';
                            } else {
                                icon.className = 'fa-regular fa-star';
                            }
                        }
                    }
                }
                
                // Favorites protection system removed - was interfering with normal toggle
                
                // Event listener removed - handled by mobile.js to prevent duplicates
                
                // Update icon on load and after render
                updateMobileFavoritesIcon();
                
                // Optionally, listen for global render events if available
                if (window.MicFinderApp && window.MicFinderApp.render) {
                    const origRender = window.MicFinderApp.render;
                    window.MicFinderApp.render = function() {
                        origRender.apply(this, arguments);
                        updateMobileFavoritesIcon();
                    };
                }
            }
            // Filter button
            const filterBtn = document.getElementById('filters-btn-mobile');
            if (filterBtn) {
                filterBtn.addEventListener('click', function() {
                    if (typeof openModal === 'function') {
                        openModal();
                    } else {
                        alert('Filter modal not available.');
                    }
                });
            }
            // List view button
            const listBtn = document.getElementById('list-view-btn-mobile');
            if (listBtn) {
                listBtn.addEventListener('click', function() {
                    // Show the right sidebar for mobile list view
                    const rightSidebar = document.getElementById('right-sidebar');
                    if (rightSidebar) {
                        // First ensure the sidebar is properly initialized
                        rightSidebar.style.display = 'flex';
                        rightSidebar.style.position = 'fixed';
                        rightSidebar.style.top = '0';
                        rightSidebar.style.right = '0';
                        rightSidebar.style.bottom = '0';
                        rightSidebar.style.width = '100%';
                        rightSidebar.style.zIndex = '1000';
                        rightSidebar.style.transform = 'translateX(100%)';
                        rightSidebar.style.transition = 'transform 0.3s ease';
                        
                        // Force a reflow to ensure the initial state is applied
                        rightSidebar.offsetHeight;
                        
                        // Now animate it in
                        rightSidebar.classList.add('mobile-open');
                        rightSidebar.style.transform = 'translateX(0)';
                        
                        // Ensure the mic list is populated
                        if (window.MicFinderApp && window.MicFinderApp.render) {
                            window.MicFinderApp.render();
                        }
                    }
                });
            }
            // Find location button
            const findLocationBtn = document.getElementById('find-location-btn-mobile');
            if (findLocationBtn) {
                findLocationBtn.addEventListener('click', function() {
                    // Trigger the same function as the desktop find location button
                    const desktopDirectionsBtn = document.getElementById('directions-btn');
                    if (desktopDirectionsBtn) {
                        desktopDirectionsBtn.click();
                    } else if (window.MicFinderMap && window.MicFinderMap.geolocateUser) {
                        window.MicFinderMap.geolocateUser();
                    }
                });
            }
            // Reset map view button
            const resetMapBtn = document.getElementById('reset-map-btn-mobile');
            if (resetMapBtn) {
                resetMapBtn.addEventListener('click', function() {
                    // Trigger the same function as the desktop reset map button
                    const desktopZoomBtn = document.getElementById('zoom-to-fit-btn');
                    if (desktopZoomBtn) {
                        desktopZoomBtn.click();
                    }
                });
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
          var mobileDaySelect = document.getElementById('mobile-day-select');
          var mobileDayWrapper = document.querySelector('.mobile-day-select-wrapper');
          var mobileDayClose = document.querySelector('.mobile-day-select-close');
          
          // Debug logging
          console.log('[DEBUG] mobileDayClose element:', mobileDayClose);
          console.log('[DEBUG] mobileDayWrapper element:', mobileDayWrapper);
          // Show wrapper if on mobile
          if (mobileDayWrapper) mobileDayWrapper.style.display = window.innerWidth <= 600 ? 'block' : 'none';
          if (mobileDaySelect) {
            // Sync select with filter state on open
            if (window.MicFinderState) {
              var filters = window.MicFinderState.getActiveFilters();
              if (filters.day) {
                mobileDaySelect.value = Array.isArray(filters.day) ? filters.day[0] : filters.day;
              }
            }
            // On change, update filter state
            mobileDaySelect.addEventListener('change', function(e) {
              var selectedDay = this.value;
              if (window.MicFinderState && window.MicFinderFilters && window.MicFinderApp) {
                var filters = window.MicFinderState.getActiveFilters();
                filters.day = selectedDay;
                window.MicFinderState.setActiveFilters(filters);
                window.MicFinderFilters.saveFilterState(filters);
                window.MicFinderApp.render();
              }
              

              
              // Optionally close dropdown after selection
              if (window.innerWidth <= 600 && mobileDayWrapper) mobileDayWrapper.style.display = 'none';
            });
          }
          // X button closes dropdown
          if (mobileDayClose && mobileDayWrapper) {
            console.log('[DEBUG] Adding click listener to mobileDayClose');
            mobileDayClose.addEventListener('click', function() {
              console.log('[DEBUG] mobileDayClose clicked');
              mobileDayWrapper.style.display = 'none';
            });
                } else {
            console.log('[DEBUG] mobileDayClose or mobileDayWrapper not found:', { mobileDayClose, mobileDayWrapper });
          }
          // Click outside closes dropdown (mobile only)
          document.addEventListener('mousedown', function(e) {
            if (window.innerWidth > 600) return;
            if (mobileDayWrapper && !mobileDayWrapper.contains(e.target)) {
              mobileDayWrapper.style.display = 'none';
            }
          });
        });

        // Function to update bottom bar selection for mobile view
        window.updateBottomBarSelection = function(mic) {
            const bottomBarInfo = document.getElementById('bottom-bar-info');
            const titleElement = document.getElementById('bottom-selection-title');
            const subtitleElement = document.getElementById('bottom-selection-subtitle');
            
            if (bottomBarInfo && titleElement && subtitleElement && mic) {
                titleElement.textContent = mic.venue || 'Unknown Venue';
                subtitleElement.textContent = mic.time + ' • ' + mic.day;
                bottomBarInfo.style.display = 'block';
            }
        };

        // Remove any leftover right-overflow-indicator on page load
        document.addEventListener('DOMContentLoaded', function() {
          var indicator = document.getElementById('right-overflow-indicator');
          if (indicator) indicator.remove();
        });

        document.addEventListener('DOMContentLoaded', function() {
          var modalBtnMobile = document.getElementById('modal-button-mobile');
          if (modalBtnMobile) {
            var computed = window.getComputedStyle(modalBtnMobile);
            var rect = modalBtnMobile.getBoundingClientRect();
            var span = modalBtnMobile.querySelector('span');
            var spanComputed = span ? window.getComputedStyle(span) : null;
            var spanRect = span ? span.getBoundingClientRect() : null;
            console.log('[DEBUG] #modal-button-mobile computed styles:', computed);
            console.log('[DEBUG] #modal-button-mobile bounding rect:', rect);
            if (span) {
              console.log('[DEBUG] #modal-button-mobile span computed styles:', spanComputed);
              console.log('[DEBUG] #modal-button-mobile span bounding rect:', spanRect);
            }
            // Log flex and alignment properties
            console.log('[DEBUG] #modal-button-mobile display:', computed.display);
            console.log('[DEBUG] #modal-button-mobile align-items:', computed.alignItems);
            console.log('[DEBUG] #modal-button-mobile justify-content:', computed.justifyContent);
            console.log('[DEBUG] #modal-button-mobile text-align:', computed.textAlign);
            if (span) {
              console.log('[DEBUG] #modal-button-mobile span marginLeft:', spanComputed.marginLeft);
              console.log('[DEBUG] #modal-button-mobile span marginRight:', spanComputed.marginRight);
            }
          } else {
            console.log('[DEBUG] #modal-button-mobile not found');
          }
        });

        // Enhanced Intro System with UX Optimization
        document.addEventListener('DOMContentLoaded', function() {
          console.log('[Intro] Enhanced system initializing...');
          
          // Check if user has seen intro before
          const hasSeenIntro = localStorage.getItem('micfinder-intro-seen');
          const visitCount = parseInt(localStorage.getItem('micfinder-visit-count') || '0') + 1;
          localStorage.setItem('micfinder-visit-count', visitCount.toString());
          
          const introOverlay = document.getElementById('intro-overlay');
          const smartStartBtn = document.getElementById('smart-start-btn');
          const skipWalkthroughBtn = document.getElementById('skip-walkthrough');
          const showIntroBtn = document.getElementById('show-intro-btn');
          const skipIntroBtn = document.getElementById('skip-intro-btn');
          const returnUserBanner = document.getElementById('return-user-banner');
          
          // Dynamic content based on user context
          function initializeDynamicContent() {
            const currentHour = new Date().getHours();
            const isEvening = currentHour >= 17;
            const isMorning = currentHour < 12;
            const isWeekend = [0, 6].includes(new Date().getDay());
            
            // Dynamic headlines based on time and context
            const welcomeTitle = document.getElementById('dynamic-welcome-title');
            const welcomeSubtitle = document.getElementById('dynamic-welcome-subtitle');
            
            let titleText, subtitleText;
            
            if (visitCount > 1) {
              // Return user messaging
              titleText = "Welcome back! Ready for your next gig?";
              subtitleText = "Let's find the perfect stage for tonight";
              if (returnUserBanner) {
                returnUserBanner.classList.remove('hidden');
              }
            } else if (isEvening) {
              titleText = "Tonight's the night to perform!";
              subtitleText = "Find open mics happening right now near you";
            } else if (isMorning) {
              titleText = "Planning your comedy journey?";
              subtitleText = "Discover the best venues to showcase your talent";
            } else if (isWeekend) {
              titleText = "Weekend comedy awaits!";
              subtitleText = "Explore this weekend's hottest open mic scenes";
            } else {
              titleText = "Ready to find your perfect stage?";
              subtitleText = "Join thousands of comedians discovering their next big break";
            }
            
            if (welcomeTitle) welcomeTitle.textContent = titleText;
            if (welcomeSubtitle) welcomeSubtitle.textContent = subtitleText;
            
            // Location-aware messaging if available (but only if intro is not currently visible)
            if (navigator.geolocation && (!introOverlay || introOverlay.style.display === 'none')) {
              navigator.geolocation.getCurrentPosition(function(position) {
                // Update subtitle with location context only if intro is not showing
                const currentIntroOverlay = document.getElementById('intro-overlay');
                if (welcomeSubtitle && visitCount === 1 && (!currentIntroOverlay || currentIntroOverlay.style.display === 'none')) {
                  welcomeSubtitle.textContent = "Discover amazing comedy venues in your area";
                }
              }, function() {
                // Geolocation failed, keep default messaging
              });
            }
          }
          
          // Initialize dynamic content
          initializeDynamicContent();
          
          console.log('[Intro] Elements found:', {
            introOverlay: !!introOverlay,
            smartStartBtn: !!smartStartBtn,
            skipWalkthroughBtn: !!skipWalkthroughBtn,
            showIntroBtn: !!showIntroBtn,
            hasSeenIntro: hasSeenIntro
          });
          

          
          // Show intro if not seen before
          if (!hasSeenIntro && introOverlay) {
            console.log('[Intro] Showing intro for first time');
            introOverlay.style.display = 'flex';
            introOverlay.style.visibility = 'visible';
          } else if (introOverlay) {
            console.log('[Intro] Hiding intro - user has seen it');
            introOverlay.style.display = 'none';
          }
          
          // Function to show intro
          function showIntro() {
            console.log('[Intro] Showing intro manually');
            if (introOverlay) {
              introOverlay.style.display = 'flex';
              introOverlay.style.visibility = 'visible';
            }
          }
          
          // Function to hide intro
          function hideIntro() {
            console.log('[Intro] Hiding intro');
            if (introOverlay) {
              introOverlay.style.display = 'none';
              introOverlay.style.visibility = 'hidden';
            }
            localStorage.setItem('micfinder-intro-seen', 'true');
            console.log('[Intro] Marked as seen in localStorage');
          }
          
          // Smart start functionality - user-paced demo then optional tutorial
          if (smartStartBtn) {
            smartStartBtn.addEventListener('click', function(e) {
              console.log('[Intro] Smart start button clicked');
              e.preventDefault();
              e.stopPropagation();
              hideIntro();
              // Start with demo only - let user control the pace
              setTimeout(() => {
                startQuickDemoWithTutorialOption();
              }, 300);
            });
          }
          
          // Skip walkthrough - direct access
          if (skipWalkthroughBtn) {
            skipWalkthroughBtn.addEventListener('click', function(e) {
              console.log('[Intro] Skip walkthrough clicked');
              e.preventDefault();
              e.stopPropagation();
              hideIntro();
              // Track that user skipped guided experience
              localStorage.setItem('micfinder-walkthrough-skipped', 'true');
            });
          }
          
          // Filters tutorial trigger functionality
          const filtersTutorialTrigger = document.getElementById('filters-tutorial-trigger');
          if (filtersTutorialTrigger) {
            filtersTutorialTrigger.addEventListener('click', function(e) {
              console.log('[Tutorial] Filters tutorial trigger clicked');
              e.preventDefault();
              e.stopPropagation();
              hideIntro();
              // Show quick filter highlight first, then start tutorial
              setTimeout(() => {
                showQuickFilterHighlight();
              }, 300);
            });
          }
          
          // Skip intro functionality for return users
          if (skipIntroBtn) {
            skipIntroBtn.addEventListener('click', function(e) {
              console.log('[Intro] Skip button clicked');
              e.preventDefault();
              e.stopPropagation();
              hideIntro();
              // Track that user explicitly skipped
              localStorage.setItem('micfinder-intro-skipped', 'true');
            });
          }
          

          
          // Enhanced show intro button with smart detection
          if (showIntroBtn) {
            showIntroBtn.addEventListener('click', function(e) {
              console.log('[Intro] Help button clicked - showing enhanced intro');
              e.preventDefault();
              e.stopPropagation();
              
              // Reset dynamic content for manual activation
              initializeDynamicContent();
              showIntro();
            });
          }
          
          // Search Tutorial Function
          function startSearchTutorial() {
            console.log('[Tutorial] Starting search tutorial');
            
            let currentStep = 0;
            const steps = [
              {
                id: 'search-bar',
                title: 'Main Search Bar',
                description: 'Type venue names, comedian names, or locations. Try "QED Astoria" or "West Side"',
                color: 'blue',
                highlight: 'search-highlight'
              },
              {
                id: 'filters',
                title: 'Filter Options', 
                description: 'Use filter pills to narrow by day, time, location, or mic type',
                color: 'green',
                highlight: 'filters-highlight'
              },
              {
                id: 'suggestions',
                title: 'Smart Suggestions',
                description: 'See autocomplete suggestions as you type, including recent searches',
                color: 'purple',
                highlight: 'search-highlight'
              },
              {
                id: 'map',
                title: 'Map Integration',
                description: 'Search results automatically highlight on the map below',
                color: 'orange',
                highlight: 'map-highlight'
              }
            ];
            
            // Create tutorial overlay
            const tutorialOverlay = document.createElement('div');
            tutorialOverlay.id = 'search-tutorial-overlay';
            tutorialOverlay.className = 'fixed inset-0 z-[70] pointer-events-none';
            tutorialOverlay.innerHTML = `
              <!-- Highlight for main search bar -->
              <div id="search-highlight" class="absolute border-4 border-blue-400 rounded-full shadow-[0_0_20px_rgba(59,130,246,0.8)] animate-pulse pointer-events-none" style="transition: all 0.3s ease; display: none;"></div>
              
              <!-- Highlight for filter pills -->
              <div id="filters-highlight" class="absolute border-4 border-green-400 rounded-lg shadow-[0_0_20px_rgba(34,197,94,0.8)] animate-pulse pointer-events-none" style="transition: all 0.3s ease; display: none;"></div>
              
              <!-- Highlight for map -->
              <div id="map-highlight" class="absolute border-4 border-orange-400 rounded-lg shadow-[0_0_20px_rgba(251,146,60,0.8)] animate-pulse pointer-events-none" style="transition: all 0.3s ease; display: none;"></div>
              
              <!-- Tutorial explanation box -->
              <div id="tutorial-box" class="fixed top-1/2 right-8 transform -translate-y-1/2 bg-white rounded-2xl p-8 shadow-[0_25px_60px_rgba(0,0,0,0.9)] border-4 border-gray-400 max-w-md pointer-events-auto" style="z-index: 80; background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);">
                <div class="flex items-center justify-between mb-6">
                  <h3 class="text-2xl font-black text-gray-900 drop-shadow-sm">Search for Mics & Venues</h3>
                  <button id="close-tutorial" class="text-gray-600 hover:text-gray-800 text-3xl font-black bg-gray-100 hover:bg-gray-200 rounded-full w-8 h-8 flex items-center justify-center transition-colors">&times;</button>
                </div>
                
                <!-- Step indicator -->
                <div class="flex justify-center mb-6">
                  <div class="flex space-x-2">
                    ${steps.map((_, index) => `
                      <div class="w-3 h-3 rounded-full transition-colors ${index === 0 ? 'bg-blue-500' : 'bg-gray-300'}" data-step-dot="${index}"></div>
                    `).join('')}
                  </div>
                </div>
                
                <!-- Current step content -->
                <div id="step-content" class="mb-8">
                  <!-- Will be populated by updateStepContent -->
                </div>
                
                <!-- Navigation buttons -->
                <div class="flex gap-3">
                  <button id="prev-step" class="flex-1 py-3 px-4 rounded-xl bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold transition-colors" style="display: none;">
                    Previous
                  </button>
                  <button id="next-step" class="flex-1 py-3 px-4 rounded-xl bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-bold transition-all duration-300 transform hover:scale-105 shadow-lg">
                    Next
                  </button>
                  <button id="finish-tutorial" class="flex-1 py-3 px-4 rounded-xl bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-bold transition-all duration-300 transform hover:scale-105 shadow-lg" style="display: none;">
                    Got it!
                  </button>
                </div>
              </div>
            `;
            
            document.body.appendChild(tutorialOverlay);
            
            // Update step content
            function updateStepContent() {
              const step = steps[currentStep];
              const stepContent = document.getElementById('step-content');
              const colorClasses = {
                blue: 'bg-blue-50 border-blue-200 text-blue-700',
                green: 'bg-green-50 border-green-200 text-green-700', 
                purple: 'bg-purple-50 border-purple-200 text-purple-700',
                orange: 'bg-orange-50 border-orange-200 text-orange-700'
              };
              
              stepContent.innerHTML = `
                <div class="flex items-start gap-4 p-4 rounded-xl ${colorClasses[step.color]} border-2">
                  <div class="w-10 h-10 bg-gradient-to-br from-${step.color}-500 to-${step.color}-600 rounded-full flex items-center justify-center text-white text-lg font-black shadow-lg mt-0.5">
                    ${currentStep + 1}
                  </div>
                  <div>
                    <div class="font-black text-${step.color}-700 text-xl mb-2">${step.title}</div>
                    <div class="text-gray-900 font-semibold text-lg">${step.description}</div>
                  </div>
                </div>
              `;
              
              // Update step dots
              document.querySelectorAll('[data-step-dot]').forEach((dot, index) => {
                dot.className = `w-3 h-3 rounded-full transition-colors ${index === currentStep ? 'bg-blue-500' : index < currentStep ? 'bg-green-500' : 'bg-gray-300'}`;
              });
              
              // Update navigation buttons
              document.getElementById('prev-step').style.display = currentStep > 0 ? 'block' : 'none';
              document.getElementById('next-step').style.display = currentStep < steps.length - 1 ? 'block' : 'none';
              document.getElementById('finish-tutorial').style.display = currentStep === steps.length - 1 ? 'block' : 'none';
              
              // Show/hide highlights
              document.querySelectorAll('[id$="-highlight"]').forEach(highlight => highlight.style.display = 'none');
              const activeHighlight = document.getElementById(step.highlight);
              if (activeHighlight) {
                activeHighlight.style.display = 'block';
                positionHighlights();
              }
            }
            
            // Position highlights
            function positionHighlights() {
              const step = steps[currentStep];
              const searchBar = document.getElementById('map-search-bar');
              const filtersRow = document.querySelector('#search-and-filters-row .flex.flex-wrap');
              const mapElement = document.getElementById('map');
              
              if (step.highlight === 'search-highlight' && searchBar) {
                const highlight = document.getElementById('search-highlight');
                const rect = searchBar.getBoundingClientRect();
                highlight.style.left = `${rect.left - 8}px`;
                highlight.style.top = `${rect.top - 8}px`;
                highlight.style.width = `${rect.width + 16}px`;
                highlight.style.height = `${rect.height + 16}px`;
              } else if (step.highlight === 'filters-highlight' && filtersRow) {
                const highlight = document.getElementById('filters-highlight');
                const rect = filtersRow.getBoundingClientRect();
                highlight.style.left = `${rect.left - 8}px`;
                highlight.style.top = `${rect.top - 8}px`;
                highlight.style.width = `${rect.width + 16}px`;
                highlight.style.height = `${rect.height + 16}px`;
              } else if (step.highlight === 'map-highlight' && mapElement) {
                const highlight = document.getElementById('map-highlight');
                const rect = mapElement.getBoundingClientRect();
                highlight.style.left = `${rect.left - 8}px`;
                highlight.style.top = `${rect.top - 8}px`;
                highlight.style.width = `${rect.width + 16}px`;
                highlight.style.height = `${rect.height + 16}px`;
              }
            }
            
            // Initialize first step
            updateStepContent();
            
            // Navigation event listeners
            document.getElementById('next-step').addEventListener('click', () => {
              if (currentStep < steps.length - 1) {
                currentStep++;
                updateStepContent();
              }
            });
            
            document.getElementById('prev-step').addEventListener('click', () => {
              if (currentStep > 0) {
                currentStep--;
                updateStepContent();
              }
            });
            
            // Position highlights initially and on resize
            setTimeout(positionHighlights, 100);
            window.addEventListener('resize', positionHighlights);
            
            // Close tutorial functionality
            function closeTutorial() {
              const overlay = document.getElementById('search-tutorial-overlay');
              if (overlay) {
                document.body.removeChild(overlay);
              }
              window.removeEventListener('resize', positionHighlights);
            }
            
            // Add close event listeners
            document.getElementById('close-tutorial').addEventListener('click', closeTutorial);
            document.getElementById('finish-tutorial').addEventListener('click', closeTutorial);
          }
          
          // Filters Tutorial Function
          function startFiltersTutorial() {
            console.log('[Tutorial] Starting filters tutorial');
            
            let currentFilterStep = 0;
            const filterSteps = [
              {
                id: 'filter-pills',
                title: 'Filter Pills',
                description: 'Click filter categories to narrow your search results instantly',
                color: 'green',
                highlight: 'filter-pills-highlight'
              },
              {
                id: 'day-filters',
                title: 'Day Filters',
                description: 'Filter by specific days: Monday, Tuesday, Weekend, etc.',
                color: 'blue',
                highlight: 'day-filters-highlight'
              },
              {
                id: 'time-filters',
                title: 'Time Filters',
                description: 'Filter by time slots: Evening, Late Night, Afternoon',
                color: 'purple',
                highlight: 'time-filters-highlight'
              },
              {
                id: 'location-filters',
                title: 'Location Filters',
                description: 'Filter by boroughs, neighborhoods, or distance from your location',
                color: 'orange',
                highlight: 'filter-pills-highlight'
              },
              {
                id: 'mic-type',
                title: 'Mic Type',
                description: 'Filter by mic style: Open Mic, Showcase, Bringer, etc.',
                color: 'red',
                highlight: 'filter-pills-highlight'
              }
            ];
            
            // Create tutorial overlay
            const tutorialOverlay = document.createElement('div');
            tutorialOverlay.id = 'filters-tutorial-overlay';
            tutorialOverlay.className = 'fixed inset-0 z-[70] pointer-events-none';
            tutorialOverlay.innerHTML = `
              <!-- Highlight for filter pills -->
              <div id="filter-pills-highlight" class="absolute border-4 border-green-400 rounded-lg shadow-[0_0_20px_rgba(34,197,94,0.8)] animate-pulse pointer-events-none" style="transition: all 0.3s ease; display: none;"></div>
              
              <!-- Highlight for day filters -->
              <div id="day-filters-highlight" class="absolute border-4 border-blue-400 rounded-lg shadow-[0_0_20px_rgba(59,130,246,0.8)] animate-pulse pointer-events-none" style="transition: all 0.3s ease; display: none;"></div>
              
              <!-- Highlight for time filters -->
              <div id="time-filters-highlight" class="absolute border-4 border-purple-400 rounded-lg shadow-[0_0_20px_rgba(147,51,234,0.8)] animate-pulse pointer-events-none" style="transition: all 0.3s ease; display: none;"></div>
              
              <!-- Tutorial explanation box -->
              <div id="filters-tutorial-box" class="fixed top-1/2 right-8 transform -translate-y-1/2 bg-white rounded-2xl p-8 shadow-[0_25px_60px_rgba(0,0,0,0.9)] border-4 border-gray-400 max-w-md pointer-events-auto" style="z-index: 80; background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);">
                <div class="flex items-center justify-between mb-6">
                  <h3 class="text-2xl font-black text-gray-900 drop-shadow-sm">Filter Mics & Venues</h3>
                  <button id="close-filters-tutorial" class="text-gray-600 hover:text-gray-800 text-3xl font-black bg-gray-100 hover:bg-gray-200 rounded-full w-8 h-8 flex items-center justify-center transition-colors">&times;</button>
                </div>
                
                <!-- Step indicator -->
                <div class="flex justify-center mb-6">
                  <div class="flex space-x-2">
                    ${filterSteps.map((_, index) => `
                      <div class="w-3 h-3 rounded-full transition-colors ${index === 0 ? 'bg-green-500' : 'bg-gray-300'}" data-filter-step-dot="${index}"></div>
                    `).join('')}
                  </div>
                </div>
                
                <!-- Current step content -->
                <div id="filter-step-content" class="mb-8">
                  <!-- Will be populated by updateFilterStepContent -->
                </div>
                
                <!-- Navigation buttons -->
                <div class="flex gap-3">
                  <button id="prev-filter-step" class="flex-1 py-3 px-4 rounded-xl bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold transition-colors" style="display: none;">
                    Previous
                  </button>
                  <button id="next-filter-step" class="flex-1 py-3 px-4 rounded-xl bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-bold transition-all duration-300 transform hover:scale-105 shadow-lg">
                    Next
                  </button>
                  <button id="finish-filters-tutorial" class="flex-1 py-3 px-4 rounded-xl bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-bold transition-all duration-300 transform hover:scale-105 shadow-lg" style="display: none;">
                    Got it!
                  </button>
                </div>
              </div>
            `;
            
            document.body.appendChild(tutorialOverlay);
            
            // Update step content
            function updateFilterStepContent() {
              const step = filterSteps[currentFilterStep];
              const stepContent = document.getElementById('filter-step-content');
              const colorClasses = {
                green: 'bg-green-50 border-green-200 text-green-700',
                blue: 'bg-blue-50 border-blue-200 text-blue-700',
                purple: 'bg-purple-50 border-purple-200 text-purple-700',
                orange: 'bg-orange-50 border-orange-200 text-orange-700',
                red: 'bg-red-50 border-red-200 text-red-700'
              };
              
              stepContent.innerHTML = `
                <div class="flex items-start gap-4 p-4 rounded-xl ${colorClasses[step.color]} border-2">
                  <div class="w-10 h-10 bg-gradient-to-br from-${step.color}-500 to-${step.color}-600 rounded-full flex items-center justify-center text-white text-lg font-black shadow-lg mt-0.5">
                    ${currentFilterStep + 1}
                  </div>
                  <div>
                    <div class="font-black text-${step.color}-700 text-xl mb-2">${step.title}</div>
                    <div class="text-gray-900 font-semibold text-lg">${step.description}</div>
                  </div>
                </div>
              `;
              
              // Update step dots
              document.querySelectorAll('[data-filter-step-dot]').forEach((dot, index) => {
                dot.className = `w-3 h-3 rounded-full transition-colors ${index === currentFilterStep ? 'bg-green-500' : index < currentFilterStep ? 'bg-blue-500' : 'bg-gray-300'}`;
              });
              
              // Update navigation buttons
              document.getElementById('prev-filter-step').style.display = currentFilterStep > 0 ? 'block' : 'none';
              document.getElementById('next-filter-step').style.display = currentFilterStep < filterSteps.length - 1 ? 'block' : 'none';
              document.getElementById('finish-filters-tutorial').style.display = currentFilterStep === filterSteps.length - 1 ? 'block' : 'none';
              
              // Show/hide highlights
              document.querySelectorAll('[id$="-highlight"]').forEach(highlight => highlight.style.display = 'none');
              const activeHighlight = document.getElementById(step.highlight);
              if (activeHighlight) {
                activeHighlight.style.display = 'block';
                positionFilterHighlights();
              }
            }
            
            // Position highlights
            function positionFilterHighlights() {
              const step = filterSteps[currentFilterStep];
              const filterPills = document.querySelector('#search-and-filters-row .flex.flex-wrap');
              const dayFilters = document.querySelector('[data-filter-type="day"]');
              const timeFilters = document.querySelector('[data-filter-type="time"]');
              
              if (step.highlight === 'filter-pills-highlight' && filterPills) {
                const highlight = document.getElementById('filter-pills-highlight');
                const rect = filterPills.getBoundingClientRect();
                highlight.style.left = `${rect.left - 8}px`;
                highlight.style.top = `${rect.top - 8}px`;
                highlight.style.width = `${rect.width + 16}px`;
                highlight.style.height = `${rect.height + 16}px`;
              } else if (step.highlight === 'day-filters-highlight' && dayFilters) {
                const highlight = document.getElementById('day-filters-highlight');
                const rect = dayFilters.getBoundingClientRect();
                highlight.style.left = `${rect.left - 4}px`;
                highlight.style.top = `${rect.top - 4}px`;
                highlight.style.width = `${rect.width + 8}px`;
                highlight.style.height = `${rect.height + 8}px`;
              } else if (step.highlight === 'time-filters-highlight' && timeFilters) {
                const highlight = document.getElementById('time-filters-highlight');
                const rect = timeFilters.getBoundingClientRect();
                highlight.style.left = `${rect.left - 4}px`;
                highlight.style.top = `${rect.top - 4}px`;
                highlight.style.width = `${rect.width + 8}px`;
                highlight.style.height = `${rect.height + 8}px`;
              }
            }
            
            // Initialize first step
            updateFilterStepContent();
            
            // Navigation event listeners
            document.getElementById('next-filter-step').addEventListener('click', () => {
              if (currentFilterStep < filterSteps.length - 1) {
                currentFilterStep++;
                updateFilterStepContent();
              }
            });
            
            document.getElementById('prev-filter-step').addEventListener('click', () => {
              if (currentFilterStep > 0) {
                currentFilterStep--;
                updateFilterStepContent();
              }
            });
            
            // Position highlights initially and on resize
            setTimeout(positionFilterHighlights, 100);
            window.addEventListener('resize', positionFilterHighlights);
            
            // Close tutorial functionality
            function closeFiltersTutorial() {
              const overlay = document.getElementById('filters-tutorial-overlay');
              if (overlay) {
                document.body.removeChild(overlay);
              }
              window.removeEventListener('resize', positionFilterHighlights);
            }
            
            // Add close event listeners
            document.getElementById('close-filters-tutorial').addEventListener('click', closeFiltersTutorial);
            document.getElementById('finish-filters-tutorial').addEventListener('click', closeFiltersTutorial);
          }
          
          // Quick Filter Highlight Function
          function showQuickFilterHighlight() {
            console.log('[Tutorial] Showing quick filter highlight');
            
            // Create a brief filter highlight overlay
            const filterHighlightOverlay = document.createElement('div');
            filterHighlightOverlay.id = 'quick-filter-highlight-overlay';
            filterHighlightOverlay.className = 'fixed inset-0 z-[70] pointer-events-none';
            filterHighlightOverlay.innerHTML = `
              <!-- Quick highlight for filter area -->
              <div id="quick-filter-highlight" class="absolute border-4 border-green-400 rounded-lg shadow-[0_0_25px_rgba(34,197,94,0.9)] animate-pulse pointer-events-none" style="transition: all 0.3s ease;"></div>
              
              <!-- Brief instruction tooltip -->
              <div id="filter-tooltip" class="fixed bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg pointer-events-none" style="z-index: 80;">
                <div class="text-sm font-semibold">These are your filter options!</div>
                <div class="text-xs">Click any filter to narrow your search</div>
              </div>
            `;
            
            document.body.appendChild(filterHighlightOverlay);
            
            // Position highlight on filter area
            function positionQuickFilterHighlight() {
              const filterArea = document.querySelector('#search-and-filters-row .flex.flex-wrap');
              const quickHighlight = document.getElementById('quick-filter-highlight');
              const tooltip = document.getElementById('filter-tooltip');
              
              if (filterArea && quickHighlight) {
                const rect = filterArea.getBoundingClientRect();
                quickHighlight.style.left = `${rect.left - 8}px`;
                quickHighlight.style.top = `${rect.top - 8}px`;
                quickHighlight.style.width = `${rect.width + 16}px`;
                quickHighlight.style.height = `${rect.height + 16}px`;
                quickHighlight.style.display = 'block';
                
                // Position tooltip near the filter area
                if (tooltip) {
                  tooltip.style.left = `${rect.left + 20}px`;
                  tooltip.style.top = `${rect.bottom + 10}px`;
                  tooltip.style.display = 'block';
                }
              }
            }
            
            // Position highlight initially
            setTimeout(positionQuickFilterHighlight, 100);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
              const overlay = document.getElementById('quick-filter-highlight-overlay');
              if (overlay) {
                document.body.removeChild(overlay);
              }
              // Start full filters tutorial after highlight
              setTimeout(() => {
                startFiltersTutorial();
              }, 200);
            }, 3000);
          }
          
          // Get venues that have mics today for demo suggestions
          function getTodaysVenueSuggestions() {
            const today = new Date().getDay(); // 0=Sunday, 1=Monday, etc.
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const todayName = dayNames[today];
            
            // Map days to venues that definitely have mics (prioritize West Side Comedy Club)
            const venueSchedule = {
              'Sunday': ['West Side Comedy Club', 'QED Astoria'],
              'Monday': ['West Side Comedy Club', 'QED Astoria'],
              'Tuesday': ['West Side Comedy Club', 'Comedy Shop'],
              'Wednesday': ['West Side Comedy Club', 'QED Astoria'],
              'Thursday': ['West Side Comedy Club', 'Comedy Shop'],
              'Friday': ['West Side Comedy Club', 'QED Astoria'],
              'Saturday': ['West Side Comedy Club', 'The Stand']
            };
            
            const todaysVenues = venueSchedule[todayName] || ['West Side Comedy Club', 'QED Astoria'];
            return {
              venue1: todaysVenues[0],
              venue2: todaysVenues[1] || todaysVenues[0],
              todayName: todayName
            };
          }



          // User-paced demo with optional tutorial
          function startQuickDemoWithTutorialOption() {
            console.log('[Demo] Starting comprehensive app demo');
            
            // Ensure mobile pills are rendered before starting the tour
            if (window.renderActivePills) {
              console.log('[Demo] Rendering active pills before tour starts');
              window.renderActivePills();
              
              // Add some sample filter pills for the tour if none exist
              setTimeout(() => {
                const mobilePillsContainer = document.getElementById('active-pills-row-mobile');
                if (mobilePillsContainer && mobilePillsContainer.children.length <= 1) { // Only All Filters button
                  console.log('[Demo] Adding sample filter pills for tour demonstration');
                  
                  // Add a sample day filter pill
                  const dayPill = document.createElement('button');
                  dayPill.className = 'pill active-pill-item bg-gray-900/80 backdrop-blur-sm text-white border-white/10 shadow-md hover:bg-black/70';
                  dayPill.innerHTML = 'Thursday <span class="ml-2 text-gray-300 hover:text-white">×</span>';
                  dayPill.style.marginLeft = '0.5rem';
                  dayPill.style.flexShrink = '0';
                  
                  // Add a sample time filter pill
                  const timePill = document.createElement('button');
                  timePill.className = 'pill active-pill-item bg-gray-900/80 backdrop-blur-sm text-white border-white/10 shadow-md hover:bg-black/70 time-pill';
                  timePill.innerHTML = '7:00 PM - 11:45 PM <span class="ml-2 text-gray-300 hover:text-white">🕒</span>';
                  timePill.style.marginLeft = '0.5rem';
                  timePill.style.flexShrink = '0';
                  
                  // Insert after the All Filters button
                  const allFiltersBtn = mobilePillsContainer.querySelector('#modal-button-mobile');
                  if (allFiltersBtn) {
                    mobilePillsContainer.insertBefore(dayPill, allFiltersBtn.nextSibling);
                    mobilePillsContainer.insertBefore(timePill, dayPill.nextSibling);
                  }
                }
              }, 200);
            }
            
            const suggestions = getTodaysVenueSuggestions();
            let currentDemoStep = 1;
            let totalSteps = 4; // Will be updated dynamically
            
            // Create a comprehensive demo overlay
            const demoOverlay = document.createElement('div');
            demoOverlay.id = 'quick-demo-overlay';
            demoOverlay.className = 'fixed inset-0 z-[70] pointer-events-none';
            demoOverlay.innerHTML = `
              <!-- Demo highlight that moves between elements -->
              <div id="demo-highlight" class="absolute border-4 border-yellow-400 rounded-xl shadow-[0_0_25px_rgba(251,191,36,0.9)] animate-pulse pointer-events-none" style="transition: all 0.5s ease;"></div>
              
              <!-- Demo instruction box -->
              <div id="demo-instruction-box" class="fixed top-1/2 right-8 transform -translate-y-1/2 bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-2xl p-6 shadow-2xl border-3 border-yellow-300 max-w-sm pointer-events-auto mobile:p-3 mobile:max-w-xs mobile:right-4 mobile:top-1/2 mobile:transform mobile:-translate-y-1/2" style="z-index: 80;">
                <div class="flex items-center justify-between mb-4 mobile:mb-3">
                  <div class="flex items-center gap-3 mobile:gap-2">
                    <div class="w-10 h-10 bg-yellow-500 rounded-full flex items-center justify-center text-white text-lg mobile:w-8 mobile:h-8 mobile:text-base">⚡</div>
                    <h3 class="text-xl font-black text-gray-900 mobile:text-lg">App Tour</h3>
                  </div>
                  <div class="text-sm text-gray-600 font-medium mobile:text-xs">
                    <span id="demo-step">1</span>/${totalSteps}
                  </div>
                </div>
                <div id="demo-content" class="mb-6 mobile:mb-4">
                  <div id="demo-title" class="text-lg font-semibold text-gray-900 mb-2 mobile:text-base mobile:mb-1">🔍 Quick Search</div>
                  <div id="demo-description" class="text-gray-700 mobile:text-sm">Try typing "${suggestions.venue1}" or "${suggestions.venue2}" to see ${suggestions.todayName}'s mics</div>
                </div>
                <div class="flex gap-2 mobile:gap-1">
                  <button id="demo-skip" class="flex-1 bg-gray-200 hover:bg-gray-300 text-red-600 py-2 px-4 rounded-lg font-semibold transition-colors touch-manipulation mobile:py-1.5 mobile:px-3 mobile:text-sm">
                    Skip Tour
                  </button>
                  <button id="demo-prev" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg font-semibold transition-colors touch-manipulation mobile:py-1.5 mobile:px-3 mobile:text-sm" style="display: none;">
                    Previous
                  </button>
                  <button id="demo-next" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white py-2 px-4 rounded-lg font-bold transition-colors touch-manipulation mobile:py-1.5 mobile:px-3 mobile:text-sm">
                    Next
                  </button>
                </div>
              </div>
            `;
            
            document.body.appendChild(demoOverlay);
            
            // Demo steps configuration - DYNAMIC based on view mode
            const demoSteps = getTourStepsForCurrentView();
            
            // Update total steps based on current view
            totalSteps = demoSteps.length;
            
            // Add actions to the dynamic steps
            demoSteps.forEach(step => {
              if (step.id === 'search') {
                step.action = () => {
                  const searchInput = document.getElementById('search-input');
                  if (searchInput) {
                    searchInput.focus();
                    searchInput.placeholder = `Try typing '${suggestions.venue1}' or '${suggestions.venue2}'...`;
                  }
                };
              } else if (step.id === 'mobile-pills') {
                step.action = () => {
                  console.log('Highlighting mobile pills area');
                };
              } else if (step.id === 'desktop-filters') {
                step.action = () => {
                  console.log('Highlighting sidebar filters');
                };
              } else if (step.id === 'map') {
                step.action = () => {
                  console.log('Highlighting map area');
                };
              } else if (step.id === 'bottom-nav') {
                step.action = () => {
                  console.log('Highlighting bottom navigation');
                };
              } else if (step.id === 'desktop-nav') {
                step.action = () => {
                  console.log('Highlighting sidebar navigation');
                };
              }
            });
            
            // Responsive tour update function
            function updateTourForCurrentView() {
              const newViewMode = getCurrentViewMode();
              const newSteps = getTourStepsForCurrentView();
              const newTotalSteps = newSteps.length;
              
              // Update total steps
              totalSteps = newTotalSteps;
              
              // Update step counter display
              const stepCounter = document.getElementById('demo-step');
              if (stepCounter) {
                const currentStep = parseInt(stepCounter.textContent.split('/')[0]);
                // Ensure current step is within bounds of new total
                if (currentStep > newTotalSteps) {
                  stepCounter.textContent = `1/${newTotalSteps}`;
                  currentDemoStep = 1;
                } else {
                  stepCounter.textContent = `${currentStep}/${newTotalSteps}`;
                }
              }
              
              // Update demo steps array
              demoSteps.length = 0; // Clear existing steps
              demoSteps.push(...newSteps); // Add new steps
              
              // Re-add actions to the new steps
              demoSteps.forEach(step => {
                if (step.id === 'search') {
                  step.action = () => {
                    const searchInput = document.getElementById('search-input');
                    if (searchInput) {
                      searchInput.focus();
                      searchInput.placeholder = `Try typing '${suggestions.venue1}' or '${suggestions.venue2}'...`;
                    }
                  };
                } else if (step.id === 'mobile-pills') {
                  step.action = () => {
                    console.log('Highlighting mobile pills area');
                  };
                } else if (step.id === 'desktop-filters') {
                  step.action = () => {
                    console.log('Highlighting sidebar filters');
                  };
                } else if (step.id === 'map') {
                  step.action = () => {
                    console.log('Highlighting map area');
                  };
                } else if (step.id === 'bottom-nav') {
                  step.action = () => {
                    console.log('Highlighting bottom navigation');
                  };
                } else if (step.id === 'desktop-nav') {
                  step.action = () => {
                    console.log('Highlighting sidebar navigation');
                  };
                }
              });
              
              console.log(`[Tour] Updated for ${newViewMode} view: ${newTotalSteps} steps`);
            }
            
            // Add window resize listener for responsive tour updates
            let resizeTimeout;
            window.addEventListener('resize', () => {
              clearTimeout(resizeTimeout);
              resizeTimeout = setTimeout(() => {
                updateTourForCurrentView();
              }, 250); // Debounce resize events
            });
            
            // Position demo highlight on target element
            function positionDemoHighlight(targetId) {
              const target = document.getElementById(targetId);
              const demoHighlight = document.getElementById('demo-highlight');
              
              console.log('[Demo] Trying to highlight:', targetId, 'Found element:', !!target);
              
              // Special handling for mobile pills - ensure they're rendered
              if (targetId === 'mobile-pills-row') {
                if (window.renderActivePills) {
                  console.log('[Demo] Ensuring mobile pills are rendered for highlighting');
                  window.renderActivePills();
                  // Wait a bit for the pills to render
                  setTimeout(() => {
                    positionDemoHighlight(targetId);
                  }, 100);
                  return;
                }
              }
              
              if (target && demoHighlight) {
                const rect = target.getBoundingClientRect();
                console.log('[Demo] Element rect:', rect);
                
                // Make sure the element is visible
                if (rect.width === 0 && rect.height === 0) {
                  console.warn('[Demo] Target element has no dimensions:', targetId);
                  
                  // Special fallback for mobile pills - highlight the All Filters button
                  if (targetId === 'mobile-pills-row') {
                    const allFiltersBtn = document.getElementById('modal-button-mobile');
                    if (allFiltersBtn) {
                      console.log('[Demo] Mobile pills empty, highlighting All Filters button instead');
                      const btnRect = allFiltersBtn.getBoundingClientRect();
                      if (btnRect.width > 0 && btnRect.height > 0) {
                        const padding = 1;
                        demoHighlight.style.left = `${btnRect.left - padding}px`;
                        demoHighlight.style.top = `${btnRect.top - padding}px`;
                        demoHighlight.style.width = `${btnRect.width + (padding * 2)}px`;
                        demoHighlight.style.height = `${btnRect.height + (padding * 2)}px`;
                        demoHighlight.style.display = 'block';
                        demoHighlight.style.pointerEvents = 'none';
                        demoHighlight.style.zIndex = '75';
                        return;
                      }
                    }
                  }
                  
                  return;
                }
                
                // Super snug positioning with 1px padding
                const padding = 1;
                demoHighlight.style.left = `${rect.left - padding}px`;
                demoHighlight.style.top = `${rect.top - padding}px`;
                demoHighlight.style.width = `${rect.width + (padding * 2)}px`;
                demoHighlight.style.height = `${rect.height + (padding * 2)}px`;
                demoHighlight.style.display = 'block';
                demoHighlight.style.pointerEvents = 'none';
                demoHighlight.style.zIndex = '75';
                
                console.log('[Demo] Highlight positioned at:', {
                  left: demoHighlight.style.left,
                  top: demoHighlight.style.top,
                  width: demoHighlight.style.width,
                  height: demoHighlight.style.height
                });
              } else {
                console.warn('[Demo] Could not find target or highlight element:', {
                  targetId,
                  target: !!target,
                  highlight: !!demoHighlight
                });
                
                                  // Try alternative selectors if main ID doesn't work
                  if (!target) {
                    const alternatives = {
                      'map-container': ['#map', '.leaflet-container', '#leaflet-map'],
                      'mobile-pills-row': ['#active-pills-row-mobile', '.mobile-pills-row', '#active-pills-row', '#modal-button-mobile'],
                      'active-pills-row': ['#active-pills-row-mobile', '.mobile-pills-row', '#active-pills-row'],
                      'sidebar-container': ['#right-sidebar', '#sidebar-content', '.mic-list', '.sidebar'],
                      'map-search-bar': ['#search-input', '.search-container', '#map-search-bar'],
                      'favorites-btn-mobile': ['#favorites-btn-mobile', '.quick-action-btn[title="Show favorites"]', '#right-sidebar'],
                      'bottom-bar-mobile': ['#bottom-bar-mobile', '.bottom-bar-content', '#active-pills-row-mobile'],
                      'find-location-btn-mobile': ['#find-location-btn-mobile', '.quick-action-btn[title="Find my location"]', '#map-container']
                    };
                  
                  if (alternatives[targetId]) {
                    for (const altSelector of alternatives[targetId]) {
                      const altTarget = document.querySelector(altSelector);
                      if (altTarget) {
                        console.log('[Demo] Found alternative target:', altSelector);
                        const rect = altTarget.getBoundingClientRect();
                        if (rect.width > 0 && rect.height > 0) {
                          // Super snug positioning with 1px padding
                          const padding = 1;
                          demoHighlight.style.left = `${rect.left - padding}px`;
                          demoHighlight.style.top = `${rect.top - padding}px`;
                          demoHighlight.style.width = `${rect.width + (padding * 2)}px`;
                          demoHighlight.style.height = `${rect.height + (padding * 2)}px`;
                          demoHighlight.style.display = 'block';
                          demoHighlight.style.pointerEvents = 'none';
                          demoHighlight.style.zIndex = '75';
                          return;
                        }
                      }
                    }
                  }
                }
              }
            }
            
            // Update demo step
            function updateDemoStep() {
              const step = demoSteps[currentDemoStep - 1];
              document.getElementById('demo-step').textContent = currentDemoStep;
              document.getElementById('demo-title').textContent = step.title;
              document.getElementById('demo-description').textContent = step.description;
              
              // Position highlight and run step action
              positionDemoHighlight(step.target);
              if (step.action) step.action();
              
              // Update button states
              const nextBtn = document.getElementById('demo-next');
              const prevBtn = document.getElementById('demo-prev');
              const skipBtn = document.getElementById('demo-skip');
              
              // Update next button text
              nextBtn.textContent = currentDemoStep === totalSteps ? 'Start Exploring!' : 'Next';
              
              // Show/hide previous button based on current step
              if (currentDemoStep === 1) {
                prevBtn.style.display = 'none';
                skipBtn.classList.remove('flex-1');
                skipBtn.classList.add('flex-1');
              } else {
                prevBtn.style.display = 'block';
                skipBtn.classList.remove('flex-1');
                skipBtn.classList.add('flex-shrink-0');
              }
            }
            
            // Initialize first step
            updateDemoStep();
            window.addEventListener('resize', () => positionDemoHighlight(demoSteps[currentDemoStep - 1].target));
            
            // Close demo functionality
            function closeDemoOverlay() {
              const overlay = document.getElementById('quick-demo-overlay');
              if (overlay) {
                document.body.removeChild(overlay);
              }
              window.removeEventListener('resize', positionDemoHighlight);
              
              // Clean up sample filter pills added for the tour
              const mobilePillsContainer = document.getElementById('active-pills-row-mobile');
              if (mobilePillsContainer) {
                const samplePills = mobilePillsContainer.querySelectorAll('.pill:not(#modal-button-mobile)');
                samplePills.forEach(pill => {
                  if (pill.textContent.includes('Thursday') || pill.textContent.includes('7:00 PM')) {
                    pill.remove();
                  }
                });
              }
            }
            
            // Next step handler
            document.getElementById('demo-next').addEventListener('click', function() {
              if (currentDemoStep < totalSteps) {
                currentDemoStep++;
                updateDemoStep();
              } else {
                // Tour complete
                console.log('[Demo] User completed app tour');
                closeDemoOverlay();
                localStorage.setItem('micfinder-demo-completed', 'true');
              }
            });
            
            // Previous step handler
            document.getElementById('demo-prev').addEventListener('click', function() {
              if (currentDemoStep > 1) {
                currentDemoStep--;
                updateDemoStep();
              }
            });
            
            // Skip tour handler
            document.getElementById('demo-skip').addEventListener('click', function() {
              console.log('[Demo] User skipped app tour');
              closeDemoOverlay();
              localStorage.setItem('micfinder-demo-skipped', 'true');
            });
          }
          
          // Quick Demo Function
          function startQuickDemo() {
            console.log('[Demo] Starting quick interactive demo');
            
            // Create a simplified demo overlay
            const demoOverlay = document.createElement('div');
            demoOverlay.id = 'quick-demo-overlay';
            demoOverlay.className = 'fixed inset-0 z-[70] pointer-events-none';
            demoOverlay.innerHTML = `
              <!-- Demo highlight for search bar -->
              <div id="demo-search-highlight" class="absolute border-4 border-yellow-400 rounded-full shadow-[0_0_25px_rgba(251,191,36,0.9)] animate-pulse pointer-events-none" style="transition: all 0.3s ease;"></div>
              
              <!-- Demo instruction box -->
              <div id="demo-instruction-box" class="fixed top-1/2 right-8 transform -translate-y-1/2 bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-2xl p-6 shadow-2xl border-3 border-yellow-300 max-w-sm pointer-events-auto" style="z-index: 80;">
                <div class="flex items-center gap-3 mb-4">
                  <div class="w-10 h-10 bg-yellow-500 rounded-full flex items-center justify-center text-white text-lg">⚡</div>
                  <h3 class="text-xl font-black text-gray-900">Quick Demo</h3>
                </div>
                <div id="demo-content" class="mb-6">
                  <div class="text-lg font-semibold text-gray-900 mb-2">Try typing in the search bar!</div>
                  <div class="text-gray-700">Type "QED Astoria" or "West Side" to see live results</div>
                </div>
                <button id="end-demo" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white py-3 px-4 rounded-xl font-bold transition-colors touch-manipulation">
                  Got it, let me explore!
                </button>
              </div>
            `;
            
            document.body.appendChild(demoOverlay);
            
            // Position demo highlight on search bar
            function positionDemoHighlight() {
              const searchBar = document.getElementById('map-search-bar');
              const demoHighlight = document.getElementById('demo-search-highlight');
              
              if (searchBar && demoHighlight) {
                const rect = searchBar.getBoundingClientRect();
                demoHighlight.style.left = `${rect.left - 12}px`;
                demoHighlight.style.top = `${rect.top - 12}px`;
                demoHighlight.style.width = `${rect.width + 24}px`;
                demoHighlight.style.height = `${rect.height + 24}px`;
                demoHighlight.style.display = 'block';
              }
            }
            
            // Position highlight initially and on resize
            setTimeout(positionDemoHighlight, 100);
            window.addEventListener('resize', positionDemoHighlight);
            
            // Auto-focus search input for immediate interaction
            setTimeout(() => {
              const searchInput = document.getElementById('search-input');
              if (searchInput) {
                searchInput.focus();
                // Add a subtle placeholder animation
                searchInput.placeholder = "Try typing 'QED Astoria' or 'West Side'...";
              }
            }, 200);
            
            // Close demo functionality
            function closeDemoTutorial() {
              const overlay = document.getElementById('quick-demo-overlay');
              if (overlay) {
                document.body.removeChild(overlay);
              }
              window.removeEventListener('resize', positionDemoHighlight);
            }
            
            // Add close event listener
            document.getElementById('end-demo').addEventListener('click', closeDemoTutorial);
            
            // Auto-close after 10 seconds
            setTimeout(closeDemoTutorial, 10000);
          }
          
          // Mobile optimization enhancements
          function optimizeForMobile() {
            const isMobile = window.innerWidth <= 768;
            const introOverlay = document.getElementById('intro-overlay');
            
            if (isMobile && introOverlay) {
              // Adjust padding and sizing for mobile
              const introContent = introOverlay.querySelector('.bg-white');
              if (introContent) {
                introContent.classList.add('mx-2', 'px-6', 'py-8');
                introContent.classList.remove('p-10');
                
                // Reduce font sizes on mobile
                const title = introContent.querySelector('#dynamic-welcome-title');
                const features = introContent.querySelectorAll('.text-xl');
                
                if (title) {
                  title.classList.remove('text-4xl');
                  title.classList.add('text-3xl');
                }
                
                features.forEach(feature => {
                  if (feature.classList.contains('text-xl')) {
                    feature.classList.remove('text-xl');
                    feature.classList.add('text-lg');
                  }
                });
              }
            }
          }
          
          // Apply mobile optimizations
          optimizeForMobile();
          window.addEventListener('resize', optimizeForMobile);
          
          // Show intro button functionality
          if (showIntroBtn) {
            showIntroBtn.addEventListener('click', function(e) {
              console.log('[Intro] Help button clicked');
              e.preventDefault();
              e.stopPropagation();
              showIntro();
            });
          }
          
          // Also close on overlay click (outside modal)
          if (introOverlay) {
            introOverlay.addEventListener('click', function(e) {
              if (e.target === introOverlay) {
                console.log('[Intro] Overlay background clicked');
                hideIntro();
              }
            });
          }
        });
    </script>
</body>
</html>   